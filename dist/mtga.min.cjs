"use strict";var F=Object.defineProperty;var ne=Object.getOwnPropertyDescriptor;var se=Object.getOwnPropertyNames;var oe=Object.prototype.hasOwnProperty;var ie=(t,e)=>{for(var n in e)F(t,n,{get:e[n],enumerable:!0})},re=(t,e,n,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of se(e))!oe.call(t,o)&&o!==n&&F(t,o,{get:()=>e[o],enumerable:!(s=ne(e,o))||s.enumerable});return t};var ae=t=>re(F({},"__esModule",{value:!0}),t);var Ie={};ie(Ie,{AutoCompleteModule:()=>D,AutoIndentModule:()=>_,AutoPairModule:()=>H,CommentModule:()=>V,HistoryModule:()=>P,IndentModule:()=>G,LineBreakModule:()=>j,LineCopyModule:()=>U,LineCutModule:()=>q,LinePasteModule:()=>z,LineRemoveModule:()=>O,MTGA:()=>$,MTGAModule:()=>K});module.exports=ae(Ie);var B=function(t,e){let n=t.selectionStart>t.selectionEnd,s=Math.min(t.selectionStart,t.selectionEnd),o=Math.max(t.selectionStart,t.selectionEnd),l=t.selectionDirection;return e?{isReversed:n,short:s,long:o,dir:l,value:t.value}:{isReversed:n,short:s,long:o,dir:l}},J=function(t,e){typeof e.value=="string"&&(t.value=e.value),e.isReversed?t.setSelectionRange(e.long,e.short,e.dir):t.setSelectionRange(e.short,e.long,e.dir),t.focus()};var K=class{parent;name;index;onKeydown;onKeydownAsync;onKeyup;onKeyupAsync;onPaste;onPasteAsync;constructor(e,n,s=9999){this.parent=e,this.name=n,this.index=s}static defaults={}};var b=function(t){let e=t.key,n=t.altKey,s=t.shiftKey,o=t.ctrlKey||t.metaKey;return{key:e,altKey:n,shiftKey:s,ctrlKey:o}};function N(t,e){let n=Array.from({length:t.length+1},()=>Array(e.length+1).fill(0));for(let i=1;i<=t.length;i++)for(let d=1;d<=e.length;d++)t[i-1]===e[d-1]?n[i][d]=n[i-1][d-1]+1:n[i][d]=Math.max(n[i-1][d],n[i][d-1]);let s=[],o=0,l=t.length,a=e.length,u=null,c=[],r=function(){u!==null&&c.length>0&&s.push([u,c.reverse().join("")]),u=null,c=[]};for(;l>0||a>0;){let i=t[l-1],d=e[a-1];l>0&&a>0&&i===d?(u!==0&&r(),u=0,c.push(i),o++,l--,a--):a>0&&(l===0||n[l][a-1]>=n[l-1][a])?(u!==1&&r(),u=1,c.push(d),a--):l>0&&(u!==-1&&r(),u=-1,c.push(i),l--)}return r(),{accuracy:o*2/(t.length+e.length),score:o,match:s.reverse()}}function W(t,e,n){let s=function(a,u){return a.repeat(Math.ceil(u/a.length)).slice(0,u)},o=Object.keys(t).join(""),l=Object.values(t).join("");for(let a=n.length-1;a>=0;a--){let u=n[a];for(let c=u.length-1;c>=0;c--){let r=u[c];if(l.includes(r)){let i=u.match(/^\s*/)?.[0].length||0;return s(e,i)}if(o.includes(r)){let i=(u.match(/^\s*/)?.[0].length||0)+e.length;return s(e,i)}}}return""}var le=function(t){if(t.defaultPrevented)return;let e=this.parent,{key:n,altKey:s,ctrlKey:o,shiftKey:l}=b(t);if(!(o&&!s&&n.toLowerCase()==="z"))return;t.preventDefault();let u;l?u=this.next():u=this.prev(),u&&e.setState(u,!1,!1)},ue=function(t){let e=this.parent,n=e._keydownState;if(e._clearKeydownState(),!n)return;let s=e.element,o=n.value,l=s.value;if(o!==l)e.addHistory();else{let a=n.state,u=e.getState();(a.short!==u.short||a.long!==u.long)&&e.addHistory(!1)}},P=class t extends K{items;maxCount;_i;constructor(e){super(e,t.name,0),this.items=[],this.maxCount=t.defaults.maxCount,this._i=1}static name="History";static defaults={maxCount:390};onKeydown=le;onKeyup=ue;prune(){this._i>1&&(this.items=this.items.slice(0,this.items.length-(this._i-1)),this._i=1)}add(e=!0){let n=this.parent;if(e)this.prune();else if(this._i!==1)return;let s=this.items[this.items.length-1],o=n.getState(!0);(!s||s.short!==o.short||s.long!==o.long||s.value!==o.value)&&(this.items.push(o),this.items.length>this.maxCount&&this.items.shift(),console.log(`history saved: ${this.items.length}`))}remove(){this.items.pop()}prev(){return this._i<this.items.length&&(this._i+=1),this.curr()}next(){return this._i>1&&(this._i-=1),this.curr()}curr(){return this.items[this.items.length-this._i]}};var T=function(t){let{short:e,long:n}=B(t),s=t.value.split(/\n/),o=[],l=0;for(let a=0;a<s.length;a++){let u=s[a],c=a===s.length-1,r=c?u:u+`
`,i=l,d=i+r.length,g=-1,m=-1,f="";e>=i&&e<d&&(g=e-i),n>i&&(c?n<=d:n<d)&&(m=n-i),e<=i&&n>=d&&(g=0,m=r.length),g>-1&&m===-1&&(m=r.length),m>-1&&g===-1&&(g=0);let v={isSelected:g>-1&&m>-1,index:a,startIndex:i,endIndex:d,value:r,selectionStart:g,selectionEnd:m};o.push(v),l=d}return o};var ce=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:l,shiftKey:a}=b(t);if(!(l&&!o&&!a&&s==="/"))return;t.preventDefault();let{pattern:c,value:r}=this,i=T(n),{short:d,long:g,dir:m,isReversed:f}=e.getState(),p=i.filter(E=>E.isSelected),v=p.filter(E=>!E.value.trim()),y=p.length>1,w=y&&p.length!==v.length,h=!0;for(let E of p)if(!(w&&v.some(A=>A.index===E.index))&&!E.value.startsWith("//")){h=!1;break}let x=d,M=g,S=[];for(let E=0;E<i.length;E++){let A=i[E],{startIndex:I,endIndex:Q}=A,R=A.value;if(!A.isSelected){S.push(A.value);continue}let L;y?h?L=A.value.replace(c,""):w&&v.some(te=>te.index===A.index)?L=A.value:L=r+A.value:h?L=A.value.replace(c,""):L=r+A.value;let k=L.length-R.length;d>=I&&d<Q?k>=0?(x+=k,M+=k):(x+=Math.max(k,I-d),M+=Math.max(k,I-g)):g>=I&&d<Q?k>=0?M+=k:M+=Math.max(k,I-g):(x+=k,M+=k),S.push(L)}e.setState({isReversed:f,short:x,long:M,dir:m,value:S.join("")},!1,!0)},de=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:l,shiftKey:a}=b(t);if(!(!l&&!o&&a&&s==="*"))return;let{short:c,long:r,dir:i,isReversed:d}=e.getState();if(c!==r||n.value.charAt(c-1)!=="/")return;t.preventDefault();let f=c+1,p=r+1,v=n.value.substring(0,c)+"**/"+n.value.substring(r);e.setState({isReversed:d,short:f,long:p,dir:i,value:v})},he=function(t){ce.call(this,t),de.call(this,t)},V=class t extends K{pattern;value;constructor(e){super(e,t.name),this.pattern=t.defaults.pattern,this.value=t.defaults.value}static name="Comment";static defaults={pattern:/^\/\/\s?/,value:"// "};onKeydown=he};var fe=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:l,shiftKey:a}=b(t);if(!(!l&&!o&&s==="Tab"))return;t.preventDefault();let{pattern:c,value:r}=this,i=T(n),{short:d,long:g,dir:m,isReversed:f}=e.getState(),v=i.filter(M=>M.isSelected).length>1,y=t.shiftKey,w=d,h=g,x=[];for(let M=0;M<i.length;M++){let S=i[M],{startIndex:E,endIndex:A}=S,I=S.value;if(!S.isSelected){x.push(S.value);continue}let R;if(v){let L=!S.value.trim();y?R=S.value.replace(c,""):L?R=S.value:R=r+S.value}else y?R=S.value.replace(c,""):R=r+S.value;let C=R.length-I.length;d>=E&&d<A?C>=0?(w+=C,h+=C):(w+=Math.max(C,E-d),h+=Math.max(C,E-g)):g>=E&&d<A?C>=0?h+=C:h+=Math.max(C,E-g):(w+=C,h+=C),x.push(R)}e.setState({isReversed:f,short:w,long:h,dir:m,value:x.join("")})},G=class t extends K{pattern;value;constructor(e){super(e,t.name),this.pattern=t.defaults.pattern,this.value=t.defaults.value}onKeydown=fe;static name="Indent";static defaults={pattern:/^[^\S\n\r][^\S\n\r]?/,value:"  "}};var X=function(t,e){return Object.keys(t).includes(e)},Y=function(t,e){return Object.values(t).includes(e)},Z=function(t,e,n){return t[e]&&t[e]===n};var ee=function(t,e){return t[e]};var me=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:s,shiftKey:o}=b(t);if(!(!s&&!n&&e==="Enter"))return;t.preventDefault();let a=this.parent,u=this.parent.element,{pairs:c,indentUnit:r}=this,{short:i,long:d,dir:g,isReversed:m}=a.getState(),f=u.value.charAt(i),p=u.value.substring(0,i),v=`
`,y=u.value.substring(d),w=p.split(/\r\n|\r|\n/),h=W(c,r,w),x=i+1;if(Y(c,f)){let E=h.substring(0,h.length-r.length);v+=h+`
`+E,x+=h.length}else v+=h,x+=h.length;let M=p+v+y,S=x;a.setState({isReversed:!1,short:x,long:S,value:M},!1,!0)},_=class t extends K{pairs;indentUnit;constructor(e){super(e,t.name),this.pairs=t.defaults.pairs,this.indentUnit=t.defaults.indentUnit}onKeydown=me;static name="AutoIndent";static defaults={pairs:{"(":")","[":"]","{":"}"},indentUnit:"  "}};var pe=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,s=this.pairs,{key:o,altKey:l,ctrlKey:a,shiftKey:u}=b(t);if(!(!a&&!l&&X(s,o)))return;t.preventDefault();let{short:r,long:i,dir:d,isReversed:g}=e.getState(),m=r!==i,f=o,p=ee(s,f),v=n.value.substring(0,r),y=n.value.substring(r,i),w=n.value.substring(i),h,x,M;if(m)M=v+f+y+p+w,h=(v+f).length,x=(v+f+y).length;else{let S=(v+f).length;M=v+f+p+w,h=S,x=S}e.setState({isReversed:g,short:h,long:x,dir:d,value:M})},ge=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,s=this.pairs,{key:o,altKey:l,ctrlKey:a,shiftKey:u}=b(t);if(!(!a&&!l&&o==="Backspace"))return;let{short:r,long:i}=e.getState();if(r!==i)return;let g=n.value.charAt(r-1),m=n.value.charAt(r);if(!Z(s,g,m))return;t.preventDefault();let f=n.value.substring(0,r-1),p=n.value.substring(r+1),v=f+p,y=f.length,w=f.length;e.setState({isReversed:!1,short:y,long:w,dir:"forward",value:v})},ve=function(t){pe.call(this,t),ge.call(this,t)},H=class t extends K{pairs;constructor(e){super(e,t.name),this.pairs={...t.defaults.pairs}}onKeydown=ve;static name="AutoPair";static defaults={pairs:{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}}};var ye=function(t,e){for(let n of t)if(n.pattern.test(e))return n},we=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:s,shiftKey:o}=b(t);if(!(!s&&!n&&(e.length===1||e==="Backspace")))return;this.stop(!0);let a=this.parent,u=this.parent.element,c=this._requestId+1,r=this._chunkSize,i=[],d=!1,g=!1,m=0,f=h=>{d=!0,g=h||!1};this._requestId=c,this._stop=f;let p=this.parser.call(this,u),v=p.body,y=[];if(v){let h=ye(this.indexes,v);h?y=h.tags:y=this.tags}let w=()=>{let h=[],x=m+r;for(;m<x&&m<y.length;){let S={tag:y[m],query:p};this.filter?.call(this,S,i,m,y)&&(h.push(S),i.push(S)),m++}if(!(g||this._requestId!==c)){if(d||m>=y.length){this.onData?.call(this,h,i),this.onEnd?.call(this,i);return}this.onData?.call(this,h,i),setTimeout(w,0)}};w()},D=class t extends K{tags;indexes;parser;filter;onData;onEnd;_requestId;_chunkSize;_stop;constructor(e){super(e,t.name,1),this.tags=[],this.indexes=[],this.parser=t.defaults.parser,this.filter=t.defaults.filter,this.onData=()=>{},this.onEnd=()=>{},this._requestId=0,this._chunkSize=t.defaults.chunkSize,this._stop=()=>{}}onKeyup=we;static name="AutoComplete";static defaults={chunkSize:100,parser:function(e){let n=e.value.split(/[,.․‧・｡。{}()<>[\]\\/|'"`!?]|\r\n|\r|\n/),s=e.selectionStart,o=0,l=0;for(let i of n){if(l=o+i.length,s>=o&&s<=l)break;o=l+1}let a=e.value.substring(0,o),u=e.value.substring(o,l),c=e.value.substring(l),r=u.match(/^(\s*)(.*?)(\s*)$/);return r&&(a=a+(r[1]||""),u=r[2],c=(r[3]||"")+c),{head:a,body:u,tail:c}},filter:function(e,n,s,o){let{tag:l,query:a}=e,u=a.body;return l.key.indexOf(u)>-1}};compare(e,n){return N(e,n)}stop(e){let n=this._stop;n?.(e)}set(e){let n=e.query.head.length+e.tag.value.length,s=e.query.head.length+e.tag.value.length,o=e.query.head+e.tag.value+e.query.tail,l={short:n,long:s,value:o};this.parent.setState(l)}};var xe=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{pairs:s,indentUnit:o}=this,{key:l,altKey:a,ctrlKey:u,shiftKey:c}=b(t);if(!(u&&!a&&l==="Enter"))return;t.preventDefault();let{short:i,long:d,dir:g,isReversed:m}=e.getState(),f=T(n),p=f.filter(I=>I.isSelected),v=t.shiftKey?p[0]:p[p.length-1],y=f[f.length-1].index===p[p.length-1].index,w=[],h=i,x=d;for(let I of f){if(!(v.index===I.index)){w.push(I.value);continue}c?(w.push(`
`+I.value),h=I.startIndex,x=I.startIndex):(w.push(I.value+`
`),h=I.endIndex,x=I.endIndex)}!c&&y&&(h+=1,x+=1);let M=w.join(""),E=M.substring(0,h).split(/\r\n|\r|\n/),A=W(s,o,E);M=M.substring(0,h)+A+M.substring(x),h+=A.length,x+=A.length,e.setState({isReversed:!1,short:h,long:x,value:M})},j=class t extends K{pairs;indentUnit;constructor(e){super(e,t.name),this.pairs=t.defaults.pairs,this.indentUnit=t.defaults.indentUnit}onKeydown=xe;static name="LineBreak";static defaults={pairs:{"(":")","[":"]","{":"}"},indentUnit:"  "}};var Ke=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:l,shiftKey:a}=b(t);if(!(l&&!o&&a&&s.toLowerCase()==="k"))return;t.preventDefault();let c=T(n),r=c.filter(h=>h.isSelected),i=r[0],d=r[r.length-1],g=[],m=0,f=0,p=0;for(let h of c)h.isSelected||(h.index===i.index-1?(m=h.endIndex,f=h.endIndex):h.index===d.index+1&&(p=h.value.length),g.push(h.value));let v=Math.min(Math.max(0,d.selectionStart,d.selectionEnd-1),Math.max(0,p-1));m+=v,f+=v;let y=g.join("");r.length===1&&r[0].value===""&&c[c.length-1].index===r[0].index&&(y=y.substring(0,y.length-1)),e.setState({isReversed:!1,short:m,long:f,value:y})},O=class t extends K{constructor(e){super(e,t.name)}onKeydown=Ke;static name="LineRemove";static defaults={}};var Me=!!navigator.clipboard?.writeText,Se=async function(t){if(t.defaultPrevented)return;if(!Me){console.warn("navigator.clipboard.writeText not found");return}let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:l,shiftKey:a}=b(t),{short:u,long:c,dir:r,isReversed:i}=e.getState();if(!(!(u!==c)&&l&&!o&&!a&&s.toLowerCase()==="x"))return;t.preventDefault();let m=T(n),f="",p=[],v=u,y=c;for(let w of m)w.isSelected?(v=w.startIndex,y=w.startIndex,f=w.value):p.push(w.value);f&&(f.endsWith(`
`)||(f+=`
`),await navigator.clipboard.writeText(f),e.setState({isReversed:!1,short:v,long:y,value:p.join("")}))},q=class t extends K{constructor(e){super(e,t.name)}onKeydownAsync=Se;static name="LineCut";static defaults={}};var be=!!navigator.clipboard?.writeText,Ee=async function(t){if(t.defaultPrevented)return;if(!be){console.warn("navigator.clipboard.writeText not found");return}let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:l,shiftKey:a}=b(t),{short:u,long:c,dir:r,isReversed:i}=e.getState();if(!(!(u!==c)&&l&&!o&&!a&&s.toLowerCase()==="c"))return;t.preventDefault();let f=T(n).find(p=>p.isSelected)?.value;f&&(f.endsWith(`
`)||(f+=`
`),await navigator.clipboard.writeText(f))},U=class t extends K{constructor(e){super(e,t.name)}onKeydownAsync=Ee;static name="LineCopy";static defaults={}};var Ae=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{short:s,long:o,dir:l,isReversed:a}=e.getState();if(!!(s!==o))return;let r=t.clipboardData?.getData("text");if(!r)return;r=r.replace(/\r\n|\r/g,`
`);let i=r.split(`
`),d=i.length===2,g=i[i.length-1]==="";if(!d||!g)return;t.preventDefault();let m=T(n),f=[],p=s+r.length,v=o+r.length;for(let y of m)y.isSelected&&f.push(r),f.push(y.value);e.setState({isReversed:a,short:p,long:v,dir:l,value:f.join("")})},z=class t extends K{constructor(e){super(e,t.name)}onPaste=Ae;static name="LinePaste";static defaults={}};var $=class{element;modules;moduleOrder;_keydownState;_keydownEvent;_keyupEvent;_pasteEvent;_focusEvent;_blurEvent;constructor(e){this.element=e,this.modules={},this.modules[P.name]=new P(this),this.modules[V.name]=new V(this),this.modules[G.name]=new G(this),this.modules[j.name]=new j(this),this.modules[O.name]=new O(this),this.modules[q.name]=new q(this),this.modules[U.name]=new U(this),this.modules[z.name]=new z(this),this.modules[_.name]=new _(this),this.modules[H.name]=new H(this),this.modules[D.name]=new D(this),this.moduleOrder=[],this._keydownState=null,this._keydownEvent=async s=>{for(let o of this.moduleOrder)o.onKeydown?.call(o,s),await o.onKeydownAsync?.call(o,s);s.defaultPrevented?this._clearKeydownState():["Meta","Control","Alt","Shift"].includes(s.key)||this._setKeydownState(s)},this._keyupEvent=async s=>{for(let o of this.moduleOrder)o.onKeyup?.call(o,s),await o.onKeyupAsync?.call(o,s)},this._pasteEvent=async s=>{for(let o of this.moduleOrder)o.onPaste?.call(o,s),await o.onPasteAsync?.call(o,s)};let n=s=>{this.addHistory(!1)};this._focusEvent=s=>{setTimeout(()=>{this.addHistory(!1),this.element.addEventListener("pointerup",n,!0)},0)},this._blurEvent=s=>{this.element.removeEventListener("pointerup",n,!0)},this.element.addEventListener("keydown",this._keydownEvent,!0),this.element.addEventListener("keyup",this._keyupEvent,!0),this.element.addEventListener("paste",this._pasteEvent,!0),this.element.addEventListener("focus",this._focusEvent,!0),this.element.addEventListener("blur",this._blurEvent,!0),this.initModules()}initModules(){this.moduleOrder=Object.values(this.modules).sort((e,n)=>e.index-n.index)}getModule(e){return this.modules[e]}setModule(e){this.modules[e.name]=e,this.initModules()}removeModule(e){this.modules[e]&&(delete this.modules[e],this.initModules())}getState(e){return B(this.element,e)}setState(e,n=!0,s=!0){n&&this.addHistory(),J(this.element,e),s&&this.addHistory()}addHistory(e=!0){this.getModule(P.name)?.add(e)}removeHistory(){this.getModule(P.name)?.remove()}_clearKeydownState(){this._keydownState=null}_setKeydownState(e){this._keydownState={value:this.element.value,state:B(this.element),key:e.key}}destroy(){this.element.removeEventListener("keydown",this._keydownEvent),this.element.removeEventListener("keyup",this._keyupEvent),this.element.removeEventListener("paste",this._pasteEvent),this.element.removeEventListener("focus",this._focusEvent),this.element.removeEventListener("blur",this._blurEvent)}};
