"use strict";var MtgaJs=(()=>{var W=Object.defineProperty;var ne=Object.getOwnPropertyDescriptor;var se=Object.getOwnPropertyNames;var oe=Object.prototype.hasOwnProperty;var re=(t,e)=>{for(var n in e)W(t,n,{get:e[n],enumerable:!0})},ie=(t,e,n,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of se(e))!oe.call(t,s)&&s!==n&&W(t,s,{get:()=>e[s],enumerable:!(o=ne(e,s))||o.enumerable});return t};var ae=t=>ie(W({},"__esModule",{value:!0}),t);var Te={};re(Te,{AutoCompleteModule:()=>D,AutoIndentModule:()=>G,AutoPairModule:()=>O,CommentModule:()=>_,HistoryModule:()=>P,IndentModule:()=>H,LineBreakModule:()=>j,LineCopyModule:()=>U,LineCutModule:()=>z,LinePasteModule:()=>B,LineRemoveModule:()=>q,MTGA:()=>F});var x=function(t,e){let n=t.selectionStart>t.selectionEnd,o=Math.min(t.selectionStart,t.selectionEnd),s=Math.max(t.selectionStart,t.selectionEnd),i=t.selectionDirection;return e?{isReversed:n,short:o,long:s,dir:i,value:t.value}:{isReversed:n,short:o,long:s,dir:i}},$=function(t,e){typeof e.value=="string"&&(t.value=e.value),e.isReversed?t.setSelectionRange(e.long,e.short,e.dir||"none"):t.setSelectionRange(e.short,e.long,e.dir||"none"),t.focus()};var K=class{parent;name;index;onKeydown;onKeydownAsync;onKeyup;onKeyupAsync;onPaste;onPasteAsync;constructor(e,n,o=9999){this.parent=e,this.name=n,this.index=o}static defaults={}};var b=function(t){let e=t.key,n=t.altKey,o=t.shiftKey,s=t.ctrlKey||t.metaKey;return{key:e,altKey:n,shiftKey:o,ctrlKey:s}};function J(t,e){let n=Array.from({length:t.length+1},()=>Array(e.length+1).fill(0));for(let l=1;l<=t.length;l++)for(let d=1;d<=e.length;d++)t[l-1]===e[d-1]?n[l][d]=n[l-1][d-1]+1:n[l][d]=Math.max(n[l-1][d],n[l][d-1]);let o=[],s=0,i=t.length,a=e.length,u=null,c=[],r=function(){u!==null&&c.length>0&&o.push([u,c.reverse().join("")]),u=null,c=[]};for(;i>0||a>0;){let l=t[i-1],d=e[a-1];i>0&&a>0&&l===d?(u!==0&&r(),u=0,c.push(l),s++,i--,a--):a>0&&(i===0||n[i][a-1]>=n[i-1][a])?(u!==1&&r(),u=1,c.push(d),a--):i>0&&(u!==-1&&r(),u=-1,c.push(l),i--)}return r(),{accuracy:s*2/(t.length+e.length),score:s,match:o.reverse()}}var le=function(t){if(t.defaultPrevented)return;let e=this.parent,{key:n,altKey:o,ctrlKey:s,shiftKey:i}=b(t);if(!(s&&!o&&n.toLowerCase()==="z"))return;t.preventDefault();let u;i?u=this.next():u=this.prev(),u&&e.setState(u)},ue=function(t){let e=this.parent,n=e._keydownState;if(e._clearKeydownState(),!n)return;let o=e.element,s=n.value,i=o.value;if(s!==i)e.addHistory();else{let a=n.state,u=x(o);(a.short!==u.short||a.long!==u.long)&&e.addHistory(!1)}},P=class t extends K{items;maxCount;_i;constructor(e){super(e,t.name,0),this.items=[],this.maxCount=t.defaults.maxCount,this._i=1}static name="History";static defaults={maxCount:390};onKeydown=le;onKeyup=ue;prune(){this._i>1&&(this.items=this.items.slice(0,this.items.length-(this._i-1)),this._i=1)}add(e=!0){let n=this.parent.element;if(e)this.prune();else if(this._i!==1)return;let o=this.items[this.items.length-1],s=x(n,!0);(!o||o.short!==s.short||o.long!==s.long||o.value!==s.value)&&(this.items.push(s),this.items.length>this.maxCount&&this.items.shift())}prev(){return this._i<this.items.length&&(this._i+=1),this.curr()}next(){return this._i>1&&(this._i-=1),this.curr()}curr(){return this.items[this.items.length-this._i]}};var C=function(t){let{short:e,long:n}=x(t),o=t.value.split(/\n/),s=[],i=0;for(let a=0;a<o.length;a++){let u=o[a],c=a===o.length-1,r=c?u:u+`
`,l=i,d=l+r.length,m=-1,v=-1,h="";e>=l&&e<d&&(m=e-l),n>l&&(c?n<=d:n<d)&&(v=n-l),e<=l&&n>=d&&(m=0,v=r.length),m>-1&&v===-1&&(v=r.length),v>-1&&m===-1&&(m=0);let f={isSelected:m>-1&&v>-1,index:a,startIndex:l,endIndex:d,value:r,selectionStart:m,selectionEnd:v};s.push(f),i=d}return s};var ce=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:o,altKey:s,ctrlKey:i,shiftKey:a}=b(t);if(!(i&&!s&&!a&&o==="/"))return;t.preventDefault();let{pattern:c,value:r}=this,l=C(n),{short:d,long:m,dir:v,isReversed:h}=x(n),y=l.filter(M=>M.isSelected),f=y.filter(M=>!M.value.trim()),w=y.length>1,p=w&&y.length!==f.length,g=!0;for(let M of y)if(!(p&&f.some(A=>A.index===M.index))&&!M.value.startsWith("//")){g=!1;break}let I=d,S=m,E=[];for(let M=0;M<l.length;M++){let A=l[M],{startIndex:V,endIndex:Q}=A,R=A.value;if(!A.isSelected){E.push(A.value);continue}let L;w?g?L=A.value.replace(c,""):p&&f.some(te=>te.index===A.index)?L=A.value:L=r+A.value:g?L=A.value.replace(c,""):L=r+A.value;let k=L.length-R.length;d>=V&&d<Q?k>=0?(I+=k,S+=k):(I+=Math.max(k,V-d),S+=Math.max(k,V-m)):m>=V&&d<Q?k>=0?S+=k:S+=Math.max(k,V-m):(I+=k,S+=k),E.push(L)}e.setState({isReversed:h,short:I,long:S,dir:v,value:E.join("")}),e.addHistory()},de=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:o,altKey:s,ctrlKey:i,shiftKey:a}=b(t);if(!(!i&&!s&&a&&o==="*"))return;let{short:c,long:r,dir:l,isReversed:d}=x(n);if(c!==r||n.value.charAt(c-1)!=="/")return;t.preventDefault();let h=c+1,y=r+1,f=n.value.substring(0,c)+"**/"+n.value.substring(r);e.setState({isReversed:d,short:h,long:y,dir:l,value:f}),e.addHistory()},he=function(t){ce.call(this,t),de.call(this,t)},_=class t extends K{pattern;value;constructor(e){super(e,t.name),this.pattern=t.defaults.pattern,this.value=t.defaults.value}static name="Comment";static defaults={pattern:/^\/\/\s?/,value:"// "};onKeydown=he};var fe=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:o,altKey:s,ctrlKey:i,shiftKey:a}=b(t);if(!(!i&&!s&&o==="Tab"))return;t.preventDefault();let{pattern:c,value:r}=this,l=C(n),{short:d,long:m,dir:v,isReversed:h}=x(n),f=l.filter(S=>S.isSelected).length>1,w=t.shiftKey,p=d,g=m,I=[];for(let S=0;S<l.length;S++){let E=l[S],{startIndex:M,endIndex:A}=E,V=E.value;if(!E.isSelected){I.push(E.value);continue}let R;if(f){let L=!E.value.trim();w?R=E.value.replace(c,""):L?R=E.value:R=r+E.value}else w?R=E.value.replace(c,""):R=r+E.value;let T=R.length-V.length;d>=M&&d<A?T>=0?(p+=T,g+=T):(p+=Math.max(T,M-d),g+=Math.max(T,M-m)):m>=M&&d<A?T>=0?g+=T:g+=Math.max(T,M-m):(p+=T,g+=T),I.push(R)}e.setState({isReversed:h,short:p,long:g,dir:v,value:I.join("")}),e.addHistory()},H=class t extends K{pattern;value;constructor(e){super(e,t.name),this.pattern=t.defaults.pattern,this.value=t.defaults.value}onKeydown=fe;static name="Indent";static defaults={pattern:/^[^\S\n\r][^\S\n\r]?/,value:"  "}};var N=function(t,e){return Object.keys(t).includes(e)},X=function(t,e){return Object.values(t).includes(e)},Y=function(t,e,n){return t[e]&&t[e]===n};var Z=function(t,e){return t[e]};var ee=function(t,e){return t.repeat(Math.ceil(e/t.length)).slice(0,e)},me=function(t,e,n){let o=Object.keys(t).join(""),s=Object.values(t).join("");for(let i=n.length-1;i>=0;i--){let a=n[i];for(let u=a.length-1;u>=0;u--){let c=a[u];if(s.includes(c)){let r=a.match(/^\s*/)?.[0].length||0;return ee(e,r)}if(o.includes(c)){let r=(a.match(/^\s*/)?.[0].length||0)+e.length;return ee(e,r)}}}return""},pe=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:o,shiftKey:s}=b(t);if(!(!o&&!n&&!s&&e==="Enter"))return;t.preventDefault();let a=this.parent,u=a.element,{pairs:c,indentUnit:r}=this,{short:l,long:d,dir:m,isReversed:v}=x(u),h=u.value.charAt(l),y=u.value.substring(0,l),f=`
`,w=u.value.substring(d),p=y.split(/\r\n|\r|\n/),g=me(c,r,p),I=l+1;if(X(c,h)){let M=g.substring(0,g.length-r.length);f+=g+`
`+M,I+=g.length}else f+=g,I+=g.length;let S=y+f+w,E=I;a.setState({isReversed:!1,short:I,long:E,dir:"none",value:S}),a.addHistory()},G=class t extends K{pairs;indentUnit;constructor(e){super(e,t.name),this.pairs=t.defaults.pairs,this.indentUnit=t.defaults.indentUnit}onKeydown=pe;static name="AutoIndent";static defaults={pairs:{"(":")","[":"]","{":"}"},indentUnit:"  "}};var ge=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,o=this.pairs,{key:s,altKey:i,ctrlKey:a,shiftKey:u}=b(t);if(!(!a&&!i&&N(o,s)))return;t.preventDefault();let{short:r,long:l,dir:d,isReversed:m}=x(n),v=r!==l,h=s,y=Z(o,h),f=n.value.substring(0,r),w=n.value.substring(r,l),p=n.value.substring(l),g,I,S;if(v)S=f+h+w+y+p,g=(f+h).length,I=(f+h+w).length;else{let E=(f+h).length;S=f+h+y+p,g=E,I=E}e.setState({isReversed:m,short:g,long:I,dir:d,value:S}),e.addHistory()},ve=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,o=this.pairs,{key:s,altKey:i,ctrlKey:a,shiftKey:u}=b(t);if(!(!a&&!i&&!u&&s==="Backspace"))return;let{short:r,long:l}=x(n);if(r!==l)return;let m=n.value.charAt(r-1),v=n.value.charAt(r);if(!Y(o,m,v))return;t.preventDefault();let h=n.value.substring(0,r-1),y=n.value.substring(r+1),f=h+y,w=h.length,p=h.length;e.setState({isReversed:!1,short:w,long:p,dir:"forward",value:f}),e.addHistory()},ye=function(t){ge.call(this,t),ve.call(this,t)},O=class t extends K{pairs;constructor(e){super(e,t.name),this.pairs={...t.defaults.pairs}}onKeydown=ye;static name="AutoPair";static defaults={pairs:{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}}};var we=function(t,e){for(let n of t)if(n.pattern.test(e))return n},xe=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:o,shiftKey:s}=b(t);if(!(!o&&!n&&(e.length===1||e==="Backspace")))return;this.stop(!0);let a=this.parent,u=this._requestId+1,c=this._chunkSize,r=[],l=!1,d=!1,m=0,v=p=>{l=!0,d=p||!1};this._requestId=u,this._stop=v;let h=this.parser.call(this,a.element),y=h.body,f=[];if(y){let p=we(this.indexes,y);p?f=p.tags:f=this.tags}let w=()=>{let p=[],g=m+c;for(;m<g&&m<f.length;){let S={tag:f[m],query:h};this.filter?.call(this,S,r,m,f)&&(p.push(S),r.push(S)),m++}if(!(d||this._requestId!==u)){if(l||m>=f.length){this.onData?.call(this,p,r),this.onEnd?.call(this,r);return}this.onData?.call(this,p,r),setTimeout(w,0)}};w()},D=class t extends K{tags;indexes;parser;filter;onData;onEnd;_requestId;_chunkSize;_stop;constructor(e){super(e,t.name,1),this.tags=[],this.indexes=[],this.parser=t.defaults.parser,this.filter=t.defaults.filter,this.onData=()=>{},this.onEnd=()=>{},this._requestId=0,this._chunkSize=t.defaults.chunkSize,this._stop=()=>{}}onKeyup=xe;static name="AutoComplete";static defaults={chunkSize:100,parser:function(e){let n=e.value.split(/[,.․‧・｡。{}()<>[\]\\/|'"`!?]|\r\n|\r|\n/),o=e.selectionStart,s=0,i=0;for(let l of n){if(i=s+l.length,o>=s&&o<=i)break;s=i+1}let a=e.value.substring(0,s),u=e.value.substring(s,i),c=e.value.substring(i),r=u.match(/^(\s*)(.*?)(\s*)$/);return r&&(a=a+(r[1]||""),u=r[2],c=(r[3]||"")+c),{head:a,body:u,tail:c}},filter:function(e,n,o,s){let{tag:i,query:a}=e,u=a.body;return i.key.indexOf(u)>-1}};compare(e,n){return J(e,n)}stop(e){let n=this._stop;n?.(e)}set(e){let n=e.query.head.length+e.tag.value.length,o=e.query.head.length+e.tag.value.length,s=e.query.head+e.tag.value+e.query.tail,i={short:n,long:o,value:s};this.parent.setState(i)}};var Ke=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:o,altKey:s,ctrlKey:i,shiftKey:a}=b(t);if(!(i&&!s&&o==="Enter"))return;t.preventDefault();let{short:c,long:r,dir:l,isReversed:d}=x(n),m=C(n),v=m.filter(g=>g.isSelected),h=t.shiftKey?v[0]:v[v.length-1],y=m[m.length-1].index===v[v.length-1].index,f=[],w=c,p=r;for(let g of m){if(!(h.index===g.index)){f.push(g.value);continue}a?(f.push(`
`+g.value),w=g.startIndex,p=g.startIndex):(f.push(g.value+`
`),w=g.endIndex,p=g.endIndex)}!a&&y&&(w+=1,p+=1),e.setState({isReversed:!1,short:w,long:p,dir:"none",value:f.join("")}),e.addHistory()},j=class t extends K{constructor(e){super(e,t.name)}onKeydown=Ke;static name="LineBreak";static defaults={}};var Se=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:o,altKey:s,ctrlKey:i,shiftKey:a}=b(t);if(!(i&&!s&&a&&o.toLowerCase()==="k"))return;t.preventDefault();let c=C(n),r=c.filter(f=>f.isSelected),l=r[0],d=[],m=0,v=0;for(let f of c)f.isSelected||(f.index===l.index-1&&(m=f.startIndex,v=f.startIndex),d.push(f.value));let h=d.join("");r.length===1&&r[0].value===""&&c[c.length-1].index===r[0].index&&(h=h.substring(0,h.length-1)),e.setState({isReversed:!1,short:m,long:v,dir:"none",value:h}),e.addHistory()},q=class t extends K{constructor(e){super(e,t.name)}onKeydown=Se;static name="LineRemove";static defaults={}};var be=!!navigator.clipboard?.writeText,Ee=async function(t){if(t.defaultPrevented)return;if(!be){console.warn("navigator.clipboard.writeText not found");return}let e=this.parent,n=this.parent.element,{key:o,altKey:s,ctrlKey:i,shiftKey:a}=b(t),{short:u,long:c,dir:r,isReversed:l}=x(n);if(!(!(u!==c)&&i&&!s&&!a&&o.toLowerCase()==="x"))return;t.preventDefault();let v=C(n),h="",y=[],f=u,w=c;for(let p of v)p.isSelected?(f=p.startIndex,w=p.startIndex,h=p.value):y.push(p.value);h&&(h.endsWith(`
`)||(h+=`
`),await navigator.clipboard.writeText(h),e.setState({isReversed:!1,short:f,long:w,dir:"none",value:y.join("")}),e.addHistory())},z=class t extends K{constructor(e){super(e,t.name)}onKeydownAsync=Ee;static name="LineCut";static defaults={}};var Ie=!!navigator.clipboard?.writeText,Me=async function(t){if(t.defaultPrevented)return;if(!Ie){console.warn("navigator.clipboard.writeText not found");return}let e=this.parent,n=this.parent.element,{key:o,altKey:s,ctrlKey:i,shiftKey:a}=b(t),{short:u,long:c,dir:r,isReversed:l}=x(n);if(!(!(u!==c)&&i&&!s&&!a&&o.toLowerCase()==="c"))return;t.preventDefault();let h=C(n).find(y=>y.isSelected)?.value;h&&(h.endsWith(`
`)||(h+=`
`),console.log(h.replace(/\s/g,"_"),h.length),await navigator.clipboard.writeText(h))},U=class t extends K{constructor(e){super(e,t.name)}onKeydownAsync=Me;static name="LineCopy";static defaults={}};var Ae=!!navigator.clipboard?.readText,Ce=function(t){if(t.defaultPrevented)return;if(!Ae){console.warn("navigator.clipboard?.readText not found");return}let e=this.parent,n=this.parent.element,{short:o,long:s,dir:i,isReversed:a}=x(n);if(!!(o!==s))return;let r=t.clipboardData?.getData("text");if(!r)return;let l=r.split(/\r\n|\r|\n/),d=l.length===2,m=l[l.length-1]==="";if(!d||!m)return;t.preventDefault();let v=C(n),h=[],y=o+r.length,f=s+r.length;for(let w of v)w.isSelected&&h.push(r),h.push(w.value);e.setState({isReversed:a,short:y,long:f,dir:i,value:h.join("")}),e.addHistory()},B=class t extends K{constructor(e){super(e,t.name)}onPaste=Ce;static name="LinePaste";static defaults={}};var F=class{element;modules;moduleOrder;_keydownState;_keydownEvent;_keyupEvent;_pasteEvent;_focusEvent;_blurEvent;constructor(e){this.element=e,this.modules={},this.modules[P.name]=new P(this),this.modules[_.name]=new _(this),this.modules[H.name]=new H(this),this.modules[j.name]=new j(this),this.modules[q.name]=new q(this),this.modules[z.name]=new z(this),this.modules[U.name]=new U(this),this.modules[B.name]=new B(this),this.modules[G.name]=new G(this),this.modules[O.name]=new O(this),this.modules[D.name]=new D(this),this.moduleOrder=[],this._keydownState=null,this._keydownEvent=async o=>{for(let s of this.moduleOrder)s.onKeydown?.call(s,o),await s.onKeydownAsync?.call(s,o);o.defaultPrevented?this._clearKeydownState():["Meta","Control","Alt","Shift"].includes(o.key)||this._setKeydownState(o)},this._keyupEvent=async o=>{for(let s of this.moduleOrder)s.onKeyup?.call(s,o),await s.onKeyupAsync?.call(s,o)},this._pasteEvent=async o=>{for(let s of this.moduleOrder)s.onPaste?.call(s,o),await s.onPasteAsync?.call(s,o)};let n=o=>{this.addHistory(!1)};this._focusEvent=o=>{setTimeout(()=>{this.addHistory(!1),this.element.addEventListener("pointerup",n,!0)},0)},this._blurEvent=o=>{this.element.removeEventListener("pointerup",n,!0)},this.element.addEventListener("keydown",this._keydownEvent,!0),this.element.addEventListener("keyup",this._keyupEvent,!0),this.element.addEventListener("paste",this._pasteEvent,!0),this.element.addEventListener("focus",this._focusEvent,!0),this.element.addEventListener("blur",this._blurEvent,!0),this.initModuleOrder()}initModuleOrder(){this.moduleOrder=Object.values(this.modules).sort((e,n)=>e.index-n.index)}getModule(e){return this.modules[e]}setModule(e){this.modules[e.name]=e,this.initModuleOrder()}removeModule(e){this.modules[e]&&(delete this.modules[e],this.initModuleOrder())}getState(e){return x(this.element,e)}setState(e){$(this.element,e)}addHistory(e=!0){this.getModule(P.name)?.add(e)}_clearKeydownState(){this._keydownState=null}_setKeydownState(e){this._keydownState={value:this.element.value,state:x(this.element),key:e.key}}destroy(){this.element.removeEventListener("keydown",this._keydownEvent),this.element.removeEventListener("keyup",this._keyupEvent),this.element.removeEventListener("paste",this._pasteEvent),this.element.removeEventListener("focus",this._focusEvent),this.element.removeEventListener("blur",this._blurEvent)}};return ae(Te);})();
