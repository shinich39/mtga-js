"use strict";var MtgaJs=(()=>{var Q=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var te=Object.getOwnPropertyNames;var ne=Object.prototype.hasOwnProperty;var se=(t,e)=>{for(var n in e)Q(t,n,{get:e[n],enumerable:!0})},oe=(t,e,n,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of te(e))!ne.call(t,i)&&i!==n&&Q(t,i,{get:()=>e[i],enumerable:!(o=ee(e,i))||o.enumerable});return t};var re=t=>oe(Q({},"__esModule",{value:!0}),t);var Ie={};se(Ie,{AutoCompleteModule:()=>j,AutoIndentModule:()=>_,AutoPairModule:()=>R,CommentModule:()=>k,HistoryModule:()=>G,IndentModule:()=>H,LineBreakModule:()=>D,LineCopyModule:()=>z,LineCutModule:()=>$,LineRemoveModule:()=>q,MTGA:()=>F});var x=function(t,e){let n=t.selectionStart>t.selectionEnd,o=Math.min(t.selectionStart,t.selectionEnd),i=Math.max(t.selectionStart,t.selectionEnd),a=t.selectionDirection;return e?{isReversed:n,short:o,long:i,dir:a,value:t.value}:{isReversed:n,short:o,long:i,dir:a}},N=function(t,e){typeof e.value=="string"&&(t.value=e.value),e.isReversed?t.setSelectionRange(e.long,e.short,e.dir||"none"):t.setSelectionRange(e.short,e.long,e.dir||"none"),t.focus()},M=function(t){let e=t.key,n=t.altKey,o=t.shiftKey,i=t.ctrlKey||t.metaKey;return{key:e,altKey:n,shiftKey:o,ctrlKey:i}};function W(t,e){let n=Array.from({length:t.length+1},()=>Array(e.length+1).fill(0));for(let u=1;u<=t.length;u++)for(let c=1;c<=e.length;c++)t[u-1]===e[c-1]?n[u][c]=n[u-1][c-1]+1:n[u][c]=Math.max(n[u-1][c],n[u][c-1]);let o=[],i=0,a=t.length,s=e.length,r=null,d=[],l=function(){r!==null&&d.length>0&&o.push([r,d.reverse().join("")]),r=null,d=[]};for(;a>0||s>0;){let u=t[a-1],c=e[s-1];a>0&&s>0&&u===c?(r!==0&&l(),r=0,d.push(u),i++,a--,s--):s>0&&(a===0||n[a][s-1]>=n[a-1][s])?(r!==1&&l(),r=1,d.push(c),s--):a>0&&(r!==-1&&l(),r=-1,d.push(u),a--)}return l(),{accuracy:i*2/(t.length+e.length),score:i,match:o.reverse()}}var E=function(t){let{short:e,long:n}=x(t),o=t.value.split(/\n/),i=[],a=0;for(let s=0;s<o.length;s++){let r=o[s],d=s===o.length-1,l=d?r:r+`
`,u=a,c=u+l.length,h=-1,g=-1,v="";e>=u&&e<c&&(h=e-u),n>u&&(d?n<=c:n<c)&&(g=n-u),e<=u&&n>=c&&(h=0,g=l.length),h>-1&&g===-1&&(g=l.length),g>-1&&h===-1&&(h=0);let f={isSelected:h>-1&&g>-1,index:s,startIndex:u,endIndex:c,value:l,selectionStart:h,selectionEnd:g};i.push(f),a=c}return i};var K=class{parent;name;index;onKeydown;onKeyup;constructor(e,n,o=9999){this.parent=e,this.name=n,this.index=o}static defaults={}};var ie=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:o,shiftKey:i}=M(t);if(!(o&&!n&&e.toLowerCase()==="z"))return;t.preventDefault();let s=this.getModule(G.name);if(!s){console.warn(`Module not found: ${G.name}`);return}let r;i?r=s.next():r=s.prev(),r&&this.setState(r)},le=function(t){let e=this._keydownState;if(this._clearKeydownState(),!e)return;let n=this.element,o=e.value,i=n.value;if(o!==i)this.addHistory();else{let a=e.state,s=x(n);(a.short!==s.short||a.long!==s.long)&&this.addHistory(!1)}},G=class t extends K{items;maxCount;_i;constructor(e){super(e,t.name,0),this.items=[],this.maxCount=t.defaults.maxCount,this._i=1}static name="History";static defaults={maxCount:390};onKeydown=ie;onKeyup=le;prune(){this._i>1&&(this.items=this.items.slice(0,this.items.length-(this._i-1)),this._i=1)}add(e=!0){let n=this.parent.element;if(e)this.prune();else if(this._i!==1)return;let o=this.items[this.items.length-1],i=x(n,!0);(!o||o.short!==i.short||o.long!==i.long||o.value!==i.value)&&(this.items.push(i),this.items.length>this.maxCount&&this.items.shift())}prev(){return this._i<this.items.length&&(this._i+=1),this.curr()}next(){return this._i>1&&(this._i-=1),this.curr()}curr(){return this.items[this.items.length-this._i]}};var ae=function(t){if(t.defaultPrevented)return;let e=this.getModule(k.name);if(!e){console.warn(`Module not found: ${k.name}`);return}let{key:n,altKey:o,ctrlKey:i,shiftKey:a}=M(t);if(!(i&&!o&&!a&&n==="/"))return;t.preventDefault();let r=this.element,{pattern:d,value:l}=e,u=E(r),{short:c,long:h,dir:g,isReversed:v}=x(r),p=u.filter(A=>A.isSelected),f=p.filter(A=>!A.value.trim()),y=p.length>1,m=y&&p.length!==f.length,I=!0;for(let A of p)if(!(m&&f.some(T=>T.index===A.index))&&!A.value.startsWith("//")){I=!1;break}let S=c,w=h,b=[];for(let A=0;A<u.length;A++){let T=u[A],{startIndex:O,endIndex:B}=T,P=T.value;if(!T.isSelected){b.push(T.value);continue}let V;y?I?V=T.value.replace(d,""):m&&f.some(Z=>Z.index===T.index)?V=T.value:V=l+T.value:I?V=T.value.replace(d,""):V=l+T.value;let L=V.length-P.length;c>=O&&c<B?L>=0?(S+=L,w+=L):(S+=Math.max(L,O-c),w+=Math.max(L,O-h)):h>=O&&c<B?L>=0?w+=L:w+=Math.max(L,O-h):(S+=L,w+=L),b.push(V)}this.setState({isReversed:v,short:S,long:w,dir:g,value:b.join("")}),this.addHistory()},ue=function(t){if(t.defaultPrevented)return;if(!this.getModule(k.name)){console.warn(`Module not found: ${k.name}`);return}let{key:n,altKey:o,ctrlKey:i,shiftKey:a}=M(t);if(!(!i&&!o&&a&&n==="*"))return;let r=this.element,{short:d,long:l,dir:u,isReversed:c}=x(r);if(d!==l||r.value.charAt(d-1)!=="/")return;t.preventDefault();let v=d+1,p=l+1,f=r.value.substring(0,d)+"**/"+r.value.substring(l);this.setState({isReversed:c,short:v,long:p,dir:u,value:f}),this.addHistory()},ce=function(t){ae.call(this,t),ue.call(this,t)},k=class t extends K{pattern;value;constructor(e){super(e,t.name),this.pattern=t.defaults.pattern,this.value=t.defaults.value}static name="Comment";static defaults={pattern:/^\/\/\s?/,value:"// "};onKeydown=ce};var de=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:o,shiftKey:i}=M(t);if(!(!o&&!n&&e==="Tab"))return;t.preventDefault();let s=this.getModule(H.name);if(!s){console.warn(`Module not found: ${H.name}`);return}let r=this.element,{pattern:d,value:l}=s,u=E(r),{short:c,long:h,dir:g,isReversed:v}=x(r),f=u.filter(w=>w.isSelected).length>1,y=t.shiftKey,m=c,I=h,S=[];for(let w=0;w<u.length;w++){let b=u[w],{startIndex:A,endIndex:T}=b,O=b.value;if(!b.isSelected){S.push(b.value);continue}let P;if(f){let V=!b.value.trim();y?P=b.value.replace(d,""):V?P=b.value:P=l+b.value}else y?P=b.value.replace(d,""):P=l+b.value;let C=P.length-O.length;c>=A&&c<T?C>=0?(m+=C,I+=C):(m+=Math.max(C,A-c),I+=Math.max(C,A-h)):h>=A&&c<T?C>=0?I+=C:I+=Math.max(C,A-h):(m+=C,I+=C),S.push(P)}this.setState({isReversed:v,short:m,long:I,dir:g,value:S.join("")}),this.addHistory()},H=class t extends K{pattern;value;constructor(e){super(e,t.name),this.pattern=t.defaults.pattern,this.value=t.defaults.value}onKeydown=de;static name="Indent";static defaults={pattern:/^[^\S\n\r][^\S\n\r]?/,value:"  "}};var J=function(t,e){return Object.keys(t).includes(e)};var U=function(t,e,n){return t[e]&&t[e]===n};var X=function(t,e){return t[e]};var Y=function(t,e){return t.repeat(Math.ceil(e/t.length)).slice(0,e)},he=function(t,e,n){let o=Object.keys(t).join(""),i=Object.values(t).join("");for(let a=n.length-1;a>=0;a--){let s=n[a];for(let r=s.length-1;r>=0;r--){let d=s[r];if(i.includes(d)){let l=s.match(/^\s*/)?.[0].length||0;return Y(e,l)}if(o.includes(d)){let l=(s.match(/^\s*/)?.[0].length||0)+e.length;return Y(e,l)}}}return""},fe=function(t){if(t.defaultPrevented)return;let e=this.getModule(_.name);if(!e){console.warn(`Module not found: ${_.name}`);return}let{key:n,altKey:o,ctrlKey:i,shiftKey:a}=M(t);if(!(!i&&!o&&!a&&n==="Enter"))return;t.preventDefault();let{pairs:r,indentUnit:d}=e,l=this.element,{short:u,long:c,dir:h,isReversed:g}=x(l),v=l.value.charAt(u-1),p=l.value.charAt(u),f=l.value.substring(0,u),y=`
`,m=l.value.substring(c),I=f.split(/\r\n|\r|\n/),S=he(r,d,I),w=u+1;if(U(r,v,p)){let T=S.substring(0,S.length-d.length);y+=S+`
`+T,w+=S.length}else y+=S,w+=S.length;let b=f+y+m,A=w;this.setState({isReversed:!1,short:w,long:A,dir:"none",value:b}),this.addHistory()},_=class t extends K{pairs;indentUnit;constructor(e){super(e,t.name),this.pairs=t.defaults.pairs,this.indentUnit=t.defaults.indentUnit}onKeydown=fe;static name="AutoIndent";static defaults={pairs:{"(":")","[":"]","{":"}"},indentUnit:"  "}};var me=function(t){if(t.defaultPrevented)return;let e=this.getModule(R.name);if(!e){console.warn(`Module not found: ${R.name}`);return}let n=e.pairs,{key:o,altKey:i,ctrlKey:a,shiftKey:s}=M(t);if(!(!a&&!i&&J(n,o)))return;t.preventDefault();let d=this.element,{short:l,long:u,dir:c,isReversed:h}=x(d),g=l!==u,v=o,p=X(n,v),f=d.value.substring(0,l),y=d.value.substring(l,u),m=d.value.substring(u),I,S,w;if(g)w=f+v+y+p+m,I=(f+v).length,S=(f+v+y).length;else{let b=(f+v).length;w=f+v+p+m,I=b,S=b}this.setState({isReversed:h,short:I,long:S,dir:c,value:w}),this.addHistory()},pe=function(t){if(t.defaultPrevented)return;let e=this.getModule(R.name);if(!e){console.warn(`Module not found: ${R.name}`);return}let n=e.pairs,{key:o,altKey:i,ctrlKey:a,shiftKey:s}=M(t),r=this.element;if(!(!a&&!i&&!s&&o==="Backspace"))return;let{short:l,long:u}=x(r);if(l!==u)return;let h=r.value.charAt(l-1),g=r.value.charAt(l);if(!U(n,h,g))return;t.preventDefault();let v=r.value.substring(0,l-1),p=r.value.substring(l+1),f=v+p,y=v.length,m=v.length;this.setState({isReversed:!1,short:y,long:m,dir:"forward",value:f}),this.addHistory()},ge=function(t){me.call(this,t),pe.call(this,t)},R=class t extends K{pairs;constructor(e){super(e,t.name),this.pairs={...t.defaults.pairs}}onKeydown=ge;static name="AutoPair";static defaults={pairs:{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}}};var ve=function(t,e){for(let n of t)if(n.pattern.test(e))return n},ye=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:o,shiftKey:i}=M(t);if(!(!o&&!n&&(e.length===1||e==="Backspace")))return;let s=this.getModule(j.name);if(!s){console.warn(`Module not found: ${j.name}`);return}s.stop(!0);let r=s._requestId+1,d=s._chunkSize,l=[],u=!1,c=!1,h=0,g=m=>{u=!0,c=m||!1};s._requestId=r,s._stop=g;let v=s.parser.call(s,this.element),p=v.body,f=[];if(p){let m=ve(s.indexes,p);m?f=m.tags:f=s.tags}let y=()=>{let m=[],I=h+d;for(;h<I&&h<f.length;){let w={tag:f[h],query:v};s.filter?.call(s,w,l,h,f)&&(m.push(w),l.push(w)),h++}if(!(c||s._requestId!==r)){if(u||h>=f.length){s.onData?.call(s,m,l),s.onEnd?.call(s,l);return}s.onData?.call(s,m,l),setTimeout(y,0)}};y()},j=class t extends K{tags;indexes;parser;filter;onData;onEnd;_requestId;_chunkSize;_stop;constructor(e){super(e,t.name,1),this.tags=[],this.indexes=[],this.parser=t.defaults.parser,this.filter=t.defaults.filter,this.onData=()=>{},this.onEnd=()=>{},this._requestId=0,this._chunkSize=t.defaults.chunkSize,this._stop=()=>{}}onKeyup=ye;static name="AutoComplete";static defaults={chunkSize:100,parser:function(e){let n=e.value.split(/[,.․‧・｡。{}()<>[\]\\/|'"`!?]|\r\n|\r|\n/),o=e.selectionStart,i=0,a=0;for(let u of n){if(a=i+u.length,o>=i&&o<=a)break;i=a+1}let s=e.value.substring(0,i),r=e.value.substring(i,a),d=e.value.substring(a),l=r.match(/^(\s*)(.*?)(\s*)$/);return l&&(s=s+(l[1]||""),r=l[2],d=(l[3]||"")+d),{head:s,body:r,tail:d}},filter:function(e,n,o,i){let{tag:a,query:s}=e,r=s.body;return a.key.indexOf(r)>-1}};compare(e,n){return W(e,n)}stop(e){let n=this._stop;n?.(e)}set(e){let n=e.query.head.length+e.tag.value.length,o=e.query.head.length+e.tag.value.length,i=e.query.head+e.tag.value+e.query.tail,a={short:n,long:o,value:i};this.parent.setState(a)}};var we=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:o,shiftKey:i}=M(t);if(!(o&&!n&&e==="Enter"))return;t.preventDefault();let s=this.element,{short:r,long:d,dir:l,isReversed:u}=x(s),c=E(s),h=c.filter(m=>m.isSelected),g=t.shiftKey?h[0]:h[h.length-1],v=c[c.length-1].index===h[h.length-1].index,p=[],f=r,y=d;for(let m of c){if(!(g.index===m.index)){p.push(m.value);continue}i?(p.push(`
`+m.value),f=m.startIndex,y=m.startIndex):(p.push(m.value+`
`),f=m.endIndex,y=m.endIndex)}!i&&v&&(f+=1,y+=1),this.setState({isReversed:!1,short:f,long:y,dir:"none",value:p.join("")}),this.addHistory()},D=class t extends K{constructor(e){super(e,t.name)}onKeydown=we;static name="LineBreak";static defaults={}};var xe=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:o,shiftKey:i}=M(t);if(!(o&&!n&&i&&e.toLowerCase()==="k"))return;t.preventDefault();let s=this.element,r=E(s),d=r.filter(p=>p.isSelected),l=d[0],u=[],c=0,h=0;for(let p of r)p.isSelected||(p.index===l.index-1&&(c=p.startIndex,h=p.startIndex),u.push(p.value));let g=u.join("");d.length===1&&d[0].value===""&&r[r.length-1].index===d[0].index&&(g=g.substring(0,g.length-1)),this.setState({isReversed:!1,short:c,long:h,dir:"none",value:g}),this.addHistory()},q=class t extends K{constructor(e){super(e,t.name)}onKeydown=xe;static name="LineRemove";static defaults={}};var Me=!!navigator.clipboard?.writeText,Ke=function(t){if(t.defaultPrevented)return;if(!Me){console.warn("navigator.clipboard.writeText not found");return}let e=this.element,{key:n,altKey:o,ctrlKey:i,shiftKey:a}=M(t),{short:s,long:r,dir:d,isReversed:l}=x(e);if(!(!(s!==r)&&i&&!o&&!a&&n.toLowerCase()==="x"))return;t.preventDefault();let h=E(e),g="",v=[],p=s,f=r;for(let y of h)y.isSelected?(p=y.startIndex,f=y.startIndex,g=y.value):v.push(y.value);if(!g){console.warn("No data selected");return}navigator.clipboard.writeText(g).then(()=>{this.setState({isReversed:!1,short:p,long:f,dir:"none",value:v.join("")}),this.addHistory()})},$=class t extends K{constructor(e){super(e,t.name)}onKeydown=Ke;static name="LineCut";static defaults={}};var Se=!!navigator.clipboard?.writeText,be=function(t){if(t.defaultPrevented)return;if(!Se){console.warn("navigator.clipboard.writeText not found");return}let e=this.element,{key:n,altKey:o,ctrlKey:i,shiftKey:a}=M(t),{short:s,long:r,dir:d,isReversed:l}=x(e);if(!(!(s!==r)&&i&&!o&&!a&&n.toLowerCase()==="c"))return;t.preventDefault();let g=E(e).find(v=>v.isSelected)?.value;if(!g){console.warn("No data selected");return}navigator.clipboard.writeText(g)},z=class t extends K{constructor(e){super(e,t.name)}onKeydown=be;static name="LineCopy";static defaults={}};var F=class{element;modules;moduleOrder;_keydownState;_keydownEvent;_keyupEvent;_focusEvent;_blurEvent;constructor(e){this.element=e,this.modules={},this.modules[G.name]=new G(this),this.modules[k.name]=new k(this),this.modules[H.name]=new H(this),this.modules[D.name]=new D(this),this.modules[q.name]=new q(this),this.modules[$.name]=new $(this),this.modules[z.name]=new z(this),this.modules[_.name]=new _(this),this.modules[R.name]=new R(this),this.modules[j.name]=new j(this),this.moduleOrder=[],this._keydownState=null,this._keydownEvent=o=>{for(let i of this.moduleOrder)i.onKeydown?.call(this,o);o.defaultPrevented?this._clearKeydownState():["Meta","Control","Alt","Shift"].includes(o.key)||this._setKeydownState(o)},this._keyupEvent=o=>{for(let i of this.moduleOrder)i.onKeyup?.call(this,o)};let n=o=>{this.addHistory(!1)};this._focusEvent=o=>{setTimeout(()=>{this.addHistory(!1),this.element.addEventListener("pointerup",n,!0)},0)},this._blurEvent=o=>{this.element.removeEventListener("pointerup",n,!0)},this.element.addEventListener("keydown",this._keydownEvent,!0),this.element.addEventListener("keyup",this._keyupEvent,!0),this.element.addEventListener("focus",this._focusEvent,!0),this.element.addEventListener("blur",this._blurEvent,!0),this.initOrder()}initOrder(){this.moduleOrder=Object.values(this.modules).sort((e,n)=>e.index-n.index)}getModule(e){return this.modules[e]}getState(e){return x(this.element,e)}setState(e){N(this.element,e)}addHistory(e=!0){this.getModule(G.name)?.add(e)}_clearKeydownState(){this._keydownState=null}_setKeydownState(e){this._keydownState={value:this.element.value,state:x(this.element),key:e.key}}};return re(Ie);})();
