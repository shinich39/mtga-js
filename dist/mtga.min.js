"use strict";var mtgaJs=(()=>{var F=Object.defineProperty;var ne=Object.getOwnPropertyDescriptor;var se=Object.getOwnPropertyNames;var oe=Object.prototype.hasOwnProperty;var ie=(e,t)=>{for(var n in t)F(e,n,{get:t[n],enumerable:!0})},re=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of se(t))!oe.call(e,s)&&s!==n&&F(e,s,{get:()=>t[s],enumerable:!(o=ne(t,s))||o.enumerable});return e};var ae=e=>re(F({},"__esModule",{value:!0}),e);var Ae={};ie(Ae,{AutoCompleteModule:()=>H,AutoIndentModule:()=>O,AutoPairModule:()=>_,CommentModule:()=>G,HistoryModule:()=>P,IndentModule:()=>V,LineBreakModule:()=>j,LineCopyModule:()=>z,LineCutModule:()=>U,LinePasteModule:()=>Q,LineRemoveModule:()=>D,MTGA:()=>q,MTGAModule:()=>x});var x=class{parent;name;index;onKeydown;onKeydownAsync;onKeyup;onKeyupAsync;onPaste;onPasteAsync;constructor(t,n,o=9999){this.parent=t,this.name=n,this.index=o}static defaults={}};var B=function(e,t){let n=e.selectionStart>e.selectionEnd,o=Math.min(e.selectionStart,e.selectionEnd),s=Math.max(e.selectionStart,e.selectionEnd),r=e.selectionDirection;return t?{isReversed:n,short:o,long:s,dir:r,value:e.value}:{isReversed:n,short:o,long:s,dir:r}},J=function(e,t){typeof t.value=="string"&&(e.value=t.value),t.isReversed?e.setSelectionRange(t.long,t.short,t.dir):e.setSelectionRange(t.short,t.long,t.dir),e.focus()};var S=function(e){let t=e.key,n=e.altKey,o=e.shiftKey,s=e.ctrlKey||e.metaKey;return{key:t,altKey:n,shiftKey:o,ctrlKey:s}};function $(e,t,n){let o=function(a,u){return a.repeat(Math.ceil(u/a.length)).slice(0,u)},s=Object.keys(e).join(""),r=Object.values(e).join("");for(let a=n.length-1;a>=0;a--){let u=n[a];for(let c=u.length-1;c>=0;c--){let i=u[c];if(r.includes(i)){let l=u.match(/^\s*/)?.[0].length||0;return o(t,l)}if(s.includes(i)){let l=(u.match(/^\s*/)?.[0].length||0)+t.length;return o(t,l)}}}return""}var le=function(e){if(e.defaultPrevented)return;let t=this.parent,{key:n,altKey:o,ctrlKey:s,shiftKey:r}=S(e);if(!(s&&!o&&n.toLowerCase()==="z"))return;e.preventDefault();let u;r?u=this.next():u=this.prev(),u&&t.setState(u,!1,!1)},de=function(e){let t=this.parent,n=t._keydownState;if(t._removeKeydownState(),!n)return;let o=t.element,s=n.value,r=o.value;if(s!==r)t.addHistory();else{let a=n.state,u=t.getState();(a.short!==u.short||a.long!==u.long)&&t.addHistory(!1)}},P=class e extends x{items;maxCount;_i;constructor(t){super(t,e.name,0),this.items=[],this.maxCount=e.defaults.maxCount,this._i=1}static name="History";static defaults={maxCount:390};onKeydown=le;onKeyup=de;prune(){this._i>1&&(this.items=this.items.slice(0,this.items.length-(this._i-1)),this._i=1)}add(t=!0){let n=this.parent;if(t)this.prune();else if(this._i!==1)return;let o=this.items[this.items.length-1],s=n.getState(!0);(!o||o.short!==s.short||o.long!==s.long||o.value!==s.value)&&(this.items.push(s),this.items.length>this.maxCount&&this.items.shift())}remove(){this.items.pop()}prev(){return this._i<this.items.length&&(this._i+=1),this.curr()}next(){return this._i>1&&(this._i-=1),this.curr()}curr(){return this.items[this.items.length-this._i]}};var I=function(e){let{short:t,long:n}=B(e),o=e.value.split(/\n/),s=[],r=0;for(let a=0;a<o.length;a++){let u=o[a],c=a===o.length-1,i=c?u:u+`
`,l=r,h=l+i.length,v=-1,g=-1,d="";t>=l&&t<h&&(v=t-l),n>l&&(c?n<=h:n<h)&&(g=n-l),t<=l&&n>=h&&(v=0,g=i.length),v>-1&&g===-1&&(g=i.length),g>-1&&v===-1&&(v=0);let p={isSelected:v>-1&&g>-1,index:a,startIndex:l,endIndex:h,value:i,selectionStart:v,selectionEnd:g};s.push(p),r=h}return s};var ue=function(e){if(e.defaultPrevented)return;let t=this.parent,n=this.parent.element,{key:o,altKey:s,ctrlKey:r,shiftKey:a}=S(e);if(!(r&&!s&&!a&&o==="/"))return;e.preventDefault();let{pattern:c,value:i}=this,l=I(n),{short:h,long:v,dir:g,isReversed:d}=t.getState(),m=l.filter(b=>b.isSelected),p=m.filter(b=>!b.value.trim()),w=m.length>1,y=w&&m.length!==p.length,f=!0;for(let b of m)if(!(y&&p.some(A=>A.index===b.index))&&!b.value.startsWith("//")){f=!1;break}let K=h,M=v,E=[];for(let b=0;b<l.length;b++){let A=l[b],{startIndex:T,endIndex:W}=A,L=A.value;if(!A.isSelected){E.push(A.value);continue}let C;w?f?C=A.value.replace(c,""):y&&p.some(te=>te.index===A.index)?C=A.value:C=i+A.value:f?C=A.value.replace(c,""):C=i+A.value;let R=C.length-L.length;h>=T&&h<W?R>=0?(K+=R,M+=R):(K+=Math.max(R,T-h),M+=Math.max(R,T-v)):v>=T&&h<W?R>=0?M+=R:M+=Math.max(R,T-v):(K+=R,M+=R),E.push(C)}t.setState({isReversed:d,short:K,long:M,dir:g,value:E.join("")},!1,!0)},ce=function(e){if(e.defaultPrevented)return;let t=this.parent,n=this.parent.element,{key:o,altKey:s,ctrlKey:r,shiftKey:a}=S(e);if(!(!r&&!s&&a&&o==="*"))return;let{short:c,long:i,dir:l,isReversed:h}=t.getState();if(c!==i||n.value.charAt(c-1)!=="/")return;e.preventDefault();let d=c+1,m=i+1,p=n.value.substring(0,c)+"**/"+n.value.substring(i);t.setState({isReversed:h,short:d,long:m,dir:l,value:p})},he=function(e){ue.call(this,e),ce.call(this,e)},G=class e extends x{pattern;value;constructor(t){super(t,e.name),this.pattern=e.defaults.pattern,this.value=e.defaults.value}static name="Comment";static defaults={pattern:/^\/\/\s?/,value:"// "};onKeydown=he};var fe=function(e){if(e.defaultPrevented)return;let t=this.parent,n=this.parent.element,{key:o,altKey:s,ctrlKey:r,shiftKey:a}=S(e);if(!(!r&&!s&&o==="Tab"))return;e.preventDefault();let{pattern:c,value:i}=this,l=I(n),{short:h,long:v,dir:g,isReversed:d}=t.getState(),p=l.filter(M=>M.isSelected).length>1,w=e.shiftKey,y=h,f=v,K=[];for(let M=0;M<l.length;M++){let E=l[M],{startIndex:b,endIndex:A}=E,T=E.value;if(!E.isSelected){K.push(E.value);continue}let L;if(p){let C=!E.value.trim();w?L=E.value.replace(c,""):C?L=E.value:L=i+E.value}else w?L=E.value.replace(c,""):L=i+E.value;let k=L.length-T.length;h>=b&&h<A?k>=0?(y+=k,f+=k):(y+=Math.max(k,b-h),f+=Math.max(k,b-v)):v>=b&&h<A?k>=0?f+=k:f+=Math.max(k,b-v):(y+=k,f+=k),K.push(L)}t.setState({isReversed:d,short:y,long:f,dir:g,value:K.join("")})},V=class e extends x{pattern;value;constructor(t){super(t,e.name),this.pattern=e.defaults.pattern,this.value=e.defaults.value}onKeydown=fe;static name="Indent";static defaults={pattern:/^[^\S\n\r][^\S\n\r]?/,value:"  "}};var N=function(e,t){return Object.keys(e).includes(t)},X=function(e,t){return Object.values(e).includes(t)},Y=function(e,t,n){return!!e[t]&&e[t]===n};var Z=function(e,t){return e[t]};var pe=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:o,shiftKey:s}=S(e);if(!(!o&&!n&&t==="Enter"))return;e.preventDefault();let a=this.parent,u=this.parent.element,{pairs:c,indentUnit:i}=this,{short:l,long:h,dir:v,isReversed:g}=a.getState(),d=u.value.charAt(l),m=u.value.substring(0,l),p=`
`,w=u.value.substring(h),y=m.split(/\r\n|\r|\n/),f=$(c,i,y),K=l+1;if(X(c,d)){let b=f.substring(0,f.length-i.length);p+=f+`
`+b,K+=f.length}else p+=f,K+=f.length;let M=m+p+w,E=K;a.setState({isReversed:!1,short:K,long:E,value:M},!1,!0)},O=class e extends x{pairs;indentUnit;constructor(t){super(t,e.name),this.pairs=e.defaults.pairs,this.indentUnit=e.defaults.indentUnit}onKeydown=pe;static name="AutoIndent";static defaults={pairs:{"(":")","[":"]","{":"}"},indentUnit:"  "}};var me=function(e){if(e.defaultPrevented)return;let t=this.parent,n=this.parent.element,o=this.pairs,{key:s,altKey:r,ctrlKey:a,shiftKey:u}=S(e);if(!(!a&&!r&&N(o,s)))return;e.preventDefault();let{short:i,long:l,dir:h,isReversed:v}=t.getState(),g=i!==l,d=s,m=Z(o,d),p=n.value.substring(0,i),w=n.value.substring(i,l),y=n.value.substring(l),f,K,M;if(g)M=p+d+w+m+y,f=(p+d).length,K=(p+d+w).length;else{let E=(p+d).length;M=p+d+m+y,f=E,K=E}t.setState({isReversed:v,short:f,long:K,dir:h,value:M})},ve=function(e){if(e.defaultPrevented)return;let t=this.parent,n=this.parent.element,o=this.pairs,{key:s,altKey:r,ctrlKey:a,shiftKey:u}=S(e);if(!(!a&&!r&&s==="Backspace"))return;let{short:i,long:l}=t.getState();if(i!==l)return;let v=n.value.charAt(i-1),g=n.value.charAt(i);if(!Y(o,v,g))return;e.preventDefault();let d=n.value.substring(0,i-1),m=n.value.substring(i+1),p=d+m,w=d.length,y=d.length;t.setState({isReversed:!1,short:w,long:y,dir:"forward",value:p})},ge=function(e){me.call(this,e),ve.call(this,e)},_=class e extends x{pairs;constructor(t){super(t,e.name),this.pairs={...e.defaults.pairs}}onKeydown=ge;static name="AutoPair";static defaults={pairs:{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}}};var ye=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:o,shiftKey:s}=S(e);if(!(!o&&!n&&(t.length===1||t==="Backspace")))return;this.kill();let a=this.chunkSize,u=!1,c=!1,i=0,l=p=>{u=!0,c=p||!1};this._stop=l;let h=this.parser.call(this,e),v=h?.body;if(!v){this.query=null,this.candidates=[],this.result=[];return}let g=this.getIndex(v)?.tags||this.tags,d=[];this.query=h,this.candidates=g,this.result=d;let m=()=>{let p=[],w=i+a;for(;i<w&&i<g.length;){let y=g[i];if(c||u)break;this.filter?.call(this,h,y,i,g)&&(p.push(y),d.push(y)),i++}if(!c){if(u||i>=g.length){this.onData?.call(this,p),this.onEnd?.call(this);return}this.onData?.call(this,p),setTimeout(m,0)}};m()},H=class e extends x{tags;indexes;chunkSize;query;candidates;result;parser;filter;onData;onEnd;_stop;constructor(t){super(t,e.name,1),this.tags=[],this.indexes=[],this.chunkSize=e.defaults.chunkSize,this.query=null,this.candidates=[],this.result=[],this.parser=e.defaults.parser,this.filter=e.defaults.filter,this.onData=()=>{},this.onEnd=()=>{},this._stop=()=>{}}onKeyup=ye;static name="AutoComplete";static defaults={chunkSize:100,parser:function(t){let n=t.target,o=n.value.split(/[,.․‧・｡。{}()<>[\]\\/|'"`!?]|\r\n|\r|\n/),s=n.selectionStart,r=0,a=0;for(let h of o){if(a=r+h.length,s>=r&&s<=a)break;r=a+1}let u=n.value.substring(0,r),c=n.value.substring(r,a),i=n.value.substring(a),l=c.match(/^(\s*)(.*?)(\s*)$/);return l&&(u=u+(l[1]||""),c=l[2],i=(l[3]||"")+i),{head:u,body:c,tail:i}},filter:function(t,n,o,s){let r=t.body;return n.key.indexOf(r)>-1}};getIndex(t){return this.indexes.find(n=>typeof n.pattern=="string"?n.pattern===t:n.pattern.test(t))}stop(){let t=this._stop;t?.(!1)}kill(){let t=this._stop;t?.(!0)}set(t,n){let o=this.parent;if(n||(n=this.query),!n)throw new Error("Query not found");let s=n.head.length+t.value.length,r=n.head.length+t.value.length,a=n.head+t.value+n.tail;o.setState({short:s,long:r,value:a})}};var we=function(e){if(e.defaultPrevented)return;let t=this.parent,n=this.parent.element,{pairs:o,indentUnit:s}=this,{key:r,altKey:a,ctrlKey:u,shiftKey:c}=S(e);if(!(u&&!a&&r==="Enter"))return;e.preventDefault();let{short:l,long:h,dir:v,isReversed:g}=t.getState(),d=I(n),m=d.filter(T=>T.isSelected),p=e.shiftKey?m[0]:m[m.length-1],w=d[d.length-1].index===m[m.length-1].index,y=[],f=l,K=h;for(let T of d){if(!(p.index===T.index)){y.push(T.value);continue}c?(y.push(`
`+T.value),f=T.startIndex,K=T.startIndex):(y.push(T.value+`
`),f=T.endIndex,K=T.endIndex)}!c&&w&&(f+=1,K+=1);let M=y.join(""),b=M.substring(0,f).split(/\r\n|\r|\n/),A=$(o,s,b);M=M.substring(0,f)+A+M.substring(K),f+=A.length,K+=A.length,t.setState({isReversed:!1,short:f,long:K,value:M})},j=class e extends x{pairs;indentUnit;constructor(t){super(t,e.name),this.pairs=e.defaults.pairs,this.indentUnit=e.defaults.indentUnit}onKeydown=we;static name="LineBreak";static defaults={pairs:{"(":")","[":"]","{":"}"},indentUnit:"  "}};var xe=function(e){if(e.defaultPrevented)return;let t=this.parent,n=this.parent.element,{key:o,altKey:s,ctrlKey:r,shiftKey:a}=S(e);if(!(r&&!s&&a&&o.toLowerCase()==="k"))return;e.preventDefault();let c=I(n),i=c.filter(f=>f.isSelected),l=i[0],h=i[i.length-1],v=[],g=0,d=0,m=0;for(let f of c)f.isSelected||(f.index===l.index-1?(g=f.endIndex,d=f.endIndex):f.index===h.index+1&&(m=f.value.length),v.push(f.value));let p=Math.min(Math.max(0,h.selectionStart,h.selectionEnd-1),Math.max(0,m-1));g+=p,d+=p;let w=v.join("");i.length===1&&i[0].value===""&&c[c.length-1].index===i[0].index&&(w=w.substring(0,w.length-1)),t.setState({isReversed:!1,short:g,long:d,value:w})},D=class e extends x{constructor(t){super(t,e.name)}onKeydown=xe;static name="LineRemove";static defaults={}};var Ke=!!navigator.clipboard?.writeText,Me=async function(e){if(e.defaultPrevented)return;if(!Ke){console.warn("navigator.clipboard.writeText not found");return}let t=this.parent,n=this.parent.element,{key:o,altKey:s,ctrlKey:r,shiftKey:a}=S(e),{short:u,long:c,dir:i,isReversed:l}=t.getState();if(!(!(u!==c)&&r&&!s&&!a&&o.toLowerCase()==="x"))return;e.preventDefault();let g=I(n),d="",m=[],p=u,w=c;for(let y of g)y.isSelected?(p=y.startIndex,w=y.startIndex,d=y.value):m.push(y.value);d&&(d.endsWith(`
`)||(d+=`
`),await navigator.clipboard.writeText(d),t.setState({isReversed:!1,short:p,long:w,value:m.join("")}))},U=class e extends x{constructor(t){super(t,e.name)}onKeydownAsync=Me;static name="LineCut";static defaults={}};var Se=!!navigator.clipboard?.writeText,Ee=async function(e){if(e.defaultPrevented)return;if(!Se){console.warn("navigator.clipboard.writeText not found");return}let t=this.parent,n=this.parent.element,{key:o,altKey:s,ctrlKey:r,shiftKey:a}=S(e),{short:u,long:c,dir:i,isReversed:l}=t.getState();if(!(!(u!==c)&&r&&!s&&!a&&o.toLowerCase()==="c"))return;e.preventDefault();let d=I(n).find(m=>m.isSelected)?.value;d&&(d.endsWith(`
`)||(d+=`
`),await navigator.clipboard.writeText(d))},z=class e extends x{constructor(t){super(t,e.name)}onKeydownAsync=Ee;static name="LineCopy";static defaults={}};var be=function(e){if(e.defaultPrevented)return;let t=this.parent,n=this.parent.element,{short:o,long:s,dir:r,isReversed:a}=t.getState();if(!!(o!==s))return;let i=e.clipboardData?.getData("text");if(!i)return;i=i.replace(/\r\n|\r/g,`
`);let l=i.split(`
`),h=l.length===2,v=l[l.length-1]==="";if(!h||!v)return;e.preventDefault();let g=I(n),d=[],m=o+i.length,p=s+i.length;for(let w of g)w.isSelected&&d.push(i),d.push(w.value);t.setState({isReversed:a,short:m,long:p,dir:r,value:d.join("")})},Q=class e extends x{constructor(t){super(t,e.name)}onPaste=be;static name="LinePaste";static defaults={}};var ee=new WeakMap,q=class e{element;modules;moduleOrder;_keydownState;_keydownEvent;_keyupEvent;_pasteEvent;_focusEvent;_blurEvent;static getMTGA(t){return ee.get(t)}static defaults={eventListenerOptions:{capture:!0,once:!1,passive:!1}};constructor(t){let n=e.getMTGA(t);if(n){console.warn("Already initialized"),this.element=n.element,this.modules=n.modules,this.moduleOrder=n.moduleOrder,this._keydownState=n._keydownState,this._keydownEvent=n._keydownEvent,this._keyupEvent=n._keyupEvent,this._pasteEvent=n._pasteEvent,this._focusEvent=n._focusEvent,this._blurEvent=n._blurEvent;return}this.element=t,this.moduleOrder=[],this.modules={},this.modules[P.name]=new P(this),this.modules[G.name]=new G(this),this.modules[V.name]=new V(this),this.modules[j.name]=new j(this),this.modules[D.name]=new D(this),this.modules[U.name]=new U(this),this.modules[z.name]=new z(this),this.modules[Q.name]=new Q(this),this.modules[O.name]=new O(this),this.modules[_.name]=new _(this),this.modules[H.name]=new H(this),this._keydownState=null,this._keydownEvent=async s=>{for(let r of this.moduleOrder)r.onKeydown?.call(r,s),await r.onKeydownAsync?.call(r,s);s.defaultPrevented?this._removeKeydownState():["Meta","Control","Alt","Shift"].includes(s.key)||this._setKeydownState(s)},this._keyupEvent=async s=>{for(let r of this.moduleOrder)r.onKeyup?.call(r,s),await r.onKeyupAsync?.call(r,s)},this._pasteEvent=async s=>{for(let r of this.moduleOrder)r.onPaste?.call(r,s),await r.onPasteAsync?.call(r,s)};let o=s=>{this.addHistory(!1)};this._focusEvent=s=>{setTimeout(()=>{this.addHistory(!1),this.element.addEventListener("pointerup",o,e.defaults.eventListenerOptions)},0)},this._blurEvent=s=>{this.element.removeEventListener("pointerup",o,e.defaults.eventListenerOptions)},this.setEvents(),this.setModuleOrder(),ee.set(t,this)}setEvents(){this.element.addEventListener("keydown",this._keydownEvent,e.defaults.eventListenerOptions),this.element.addEventListener("keyup",this._keyupEvent,e.defaults.eventListenerOptions),this.element.addEventListener("paste",this._pasteEvent,e.defaults.eventListenerOptions),this.element.addEventListener("focus",this._focusEvent,e.defaults.eventListenerOptions),this.element.addEventListener("blur",this._blurEvent,e.defaults.eventListenerOptions)}removeEvents(){this.element.removeEventListener("keydown",this._keydownEvent),this.element.removeEventListener("keyup",this._keyupEvent),this.element.removeEventListener("paste",this._pasteEvent),this.element.removeEventListener("focus",this._focusEvent),this.element.removeEventListener("blur",this._blurEvent)}setModuleOrder(){this.moduleOrder=Object.values(this.modules).sort((t,n)=>t.index-n.index)}getModule(t){return this.modules[t]}setModule(t){this.modules[t.name]=t,this.setModuleOrder()}removeModule(t){this.modules[t]&&(delete this.modules[t],this.setModuleOrder())}getState(t){return B(this.element,t)}setState(t,n=!0,o=!0){n&&this.addHistory(),J(this.element,t),o&&this.addHistory()}addHistory(t=!0){this.getModule(P.name)?.add(t)}removeHistory(){this.getModule(P.name)?.remove()}_setKeydownState(t){this._keydownState={value:this.element.value,state:B(this.element),key:t.key}}_removeKeydownState(){this._keydownState=null}};return ae(Ae);})();
