"use strict";var MtgaJs=(()=>{var H=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var U=Object.getOwnPropertyNames;var W=Object.prototype.hasOwnProperty;var $=(t,e)=>{for(var n in e)H(t,n,{get:e[n],enumerable:!0})},F=(t,e,n,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of U(e))!W.call(t,o)&&o!==n&&H(t,o,{get:()=>e[o],enumerable:!(i=Q(e,o))||i.enumerable});return t};var J=t=>F(H({},"__esModule",{value:!0}),t);var ae={};$(ae,{Breakify:()=>_,Commentify:()=>R,History:()=>C,Indentify:()=>G,MTGA:()=>D,Pairify:()=>A,Tagify:()=>V});var x=function(t,e){let n=t.selectionStart>t.selectionEnd,i=Math.min(t.selectionStart,t.selectionEnd),o=Math.max(t.selectionStart,t.selectionEnd),a=t.selectionDirection;return e?{isReversed:n,short:i,long:o,dir:a,value:t.value}:{isReversed:n,short:i,long:o,dir:a}},K=function(t,e){e.value&&(t.value=e.value),e.isReversed?t.setSelectionRange(e.long,e.short,e.dir||"none"):t.setSelectionRange(e.short,e.long,e.dir||"none"),t.focus()},b=function(t){let e=t.key,n=t.altKey,i=t.shiftKey,o=t.ctrlKey||t.metaKey;return{key:e,altKey:n,shiftKey:i,ctrlKey:o}};function z(t,e){let n=Array.from({length:t.length+1},()=>Array(e.length+1).fill(0));for(let c=1;c<=t.length;c++)for(let l=1;l<=e.length;l++)t[c-1]===e[l-1]?n[c][l]=n[c-1][l-1]+1:n[c][l]=Math.max(n[c-1][l],n[c][l-1]);let i=[],o=0,a=t.length,s=e.length,r=null,h=[],u=function(){r!==null&&h.length>0&&i.push([r,h.reverse().join("")]),r=null,h=[]};for(;a>0||s>0;){let c=t[a-1],l=e[s-1];a>0&&s>0&&c===l?(r!==0&&u(),r=0,h.push(c),o++,a--,s--):s>0&&(a===0||n[a][s-1]>=n[a-1][s])?(r!==1&&u(),r=1,h.push(l),s--):a>0&&(r!==-1&&u(),r=-1,h.push(c),a--)}return u(),{accuracy:o*2/(t.length+e.length),score:o,match:i.reverse()}}var E=function(t){let{short:e,long:n}=x(t),i=t.value.split(/\n/),o=[],a=[],s=0;for(let r=0;r<i.length;r++){let h=i[r],c=r===i.length-1?h:h+`
`,l=s,f=s+h.length+1,g=-1,v=-1,T="";e>=l&&e<f&&(g=e-l),n>l&&n<f&&(v=n-l),e<=l&&n>=f&&(g=0,v=c.length),g>-1&&v===-1&&(v=c.length),v>-1&&g===-1&&(g=0);let p=g>-1&&v>-1;p&&(T=c.substring(g,v));let m={rowIndex:r,startIndex:l,endIndex:f,value:c,selectionStart:g,selectionEnd:v,selectionValue:T};o.push(m),p&&a.push(m),s=f}return{rows:o,selectedRows:a}};var B=function(t,e){return Object.keys(t).includes(e)};var q=function(t,e){return t[e]},N=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:i,shiftKey:o}=b(t),a=this.element,s=this.pairify.pairs;if(!(!i&&!n&&B(s,e)))return;t.preventDefault();let{short:h,long:u,dir:c,isReversed:l}=x(a),f=h!==u,g=e,v=q(s,g),T=a.value.substring(0,h),p=a.value.substring(h,u),m=a.value.substring(u),y,S,M;if(f)M=T+g+p+v+m,y=(T+g).length,S=(T+g+p).length;else{let d=(T+g).length;M=T+g+v+m,y=d,S=d}K(a,{isReversed:l,short:y,long:S,dir:c,value:M}),this.history.add()},X=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:i,shiftKey:o}=b(t);if(!(!i&&!n&&!o&&e==="Backspace"))return;let s=this.element,r=this.pairify.pairs,{short:h,long:u,dir:c,isReversed:l}=x(s);if(h!==u)return;let g=s.value.charAt(u-1),v=q(r,g);if(!(B(r,g)&&q(r,g)===v))return;t.preventDefault();let p=s.value.substring(0,u-1),m=s.value.substring(u+1),y=p+m,S=p.length,M=p.length;K(s,{isReversed:!1,short:S,long:M,dir:"forward",value:y}),this.history.add()},A=class t{parent;pairs;constructor(e){this.parent=e,this.pairs={...t.defaults.pairs},e.modules.push({name:"ClosePair",onKeydown:N},{name:"ClearPair",onKeydown:X})}static defaults={pairs:{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}}};var Y=function(t){for(let e of t)if(e.value.startsWith("//"))return!0;return!1},Z=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:i,shiftKey:o}=b(t);if(!(i&&!n&&!o&&e==="/"))return;t.preventDefault();let s=this.element,{pattern:r,value:h}=this.commentify,{rows:u,selectedRows:c}=E(s),{short:l,long:f,dir:g,isReversed:v}=x(s),T=c.length>1,p=Y(c),m=l,y=f,S=[];for(let M=0;M<u.length;M++){let d=u[M],{startIndex:k,endIndex:P}=d,L=d.value;if(!(d.selectionStart>-1||d.selectionEnd>-1)){S.push(d.value);continue}let I;if(T){let j=!d.value.trim();p?I=d.value.replace(r,""):j?I=d.value:I=h+d.value}else p?I=d.value.replace(r,""):I=h+d.value;let w=I.length-L.length;l>=k&&l<P?w>=0?(m+=w,y+=w):(m+=Math.max(w,k-l),y+=Math.max(w,k-f)):f>=k&&l<P?w>=0?y+=w:y+=Math.max(w,k-f):y+=w,S.push(I)}K(s,{isReversed:v,short:m,long:y,dir:g,value:S.join("")}),this.history.add()},R=class t{parent;pattern;value;constructor(e){this.parent=e,this.pattern=t.defaults.pattern,this.value=t.defaults.value,e.modules.push({name:"Commentify",onKeydown:Z})}static defaults={pattern:/^\/\/\s?/,value:"// "}};var ee=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:i,shiftKey:o}=b(t);if(!(!i&&!n&&e==="Tab"))return;t.preventDefault();let s=this.element,{pattern:r,value:h}=this.indentify,{rows:u,selectedRows:c}=E(s),{short:l,long:f,dir:g,isReversed:v}=x(s),T=c.length>1,p=t.shiftKey,m=l,y=f,S=[];for(let M=0;M<u.length;M++){let d=u[M],{startIndex:k,endIndex:P}=d,L=d.value;if(!(d.selectionStart>-1||d.selectionEnd>-1)){S.push(d.value);continue}let I;if(T){let j=!d.value.trim();p?I=d.value.replace(r,""):j?I=d.value:I=h+d.value}else p?I=d.value.replace(r,""):I=h+d.value;let w=I.length-L.length;l>=k&&l<P?w>=0?(m+=w,y+=w):(m+=Math.max(w,k-l),y+=Math.max(w,k-f)):f>=k&&l<P?w>=0?y+=w:y+=Math.max(w,k-f):y+=w,S.push(I)}K(s,{isReversed:v,short:m,long:y,dir:g,value:S.join("")}),this.history.add()},G=class t{parent;pattern;value;constructor(e){this.parent=e,this.pattern=t.defaults.pattern,this.value=t.defaults.value,e.modules.push({name:"Indentify",onKeydown:ee})}static defaults={pattern:/^[^\S\n\r][^\S\n\r]?/,value:"  "}};var te=function(t,e){for(let n of t)if(n.pattern.test(e))return n},ne=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:i,shiftKey:o}=b(t);if(!(!i&&(e.length===1||e==="Backspace")))return;let s=this.tagify;s.stop(!0);let r=s._requestId+1,h=s._chunkSize,u=[],c=!1,l=!1,f=0,g=y=>{c=!0,l=y||!1};s._requestId=r,s._stop=g;let v=s.parser.call(this,this.element),T=v.body,p=[];if(T){let y=te(s.indexes,T);y?p=y.tags:p=s.tags}let m=()=>{let y=[],S=f+h;for(;f<S&&f<p.length;){let d={tag:p[f],query:v};s.filter?.call(this,d,f,p,u)&&(y.push(d),u.push(d)),f++}if(!(l||s._requestId!==r)){if(c||f>=p.length){s.onData?.call(this,y,u),s.onEnd?.call(this,u);return}s.onData?.call(this,y,u),setTimeout(m,0)}};m()},V=class t{parent;tags;indexes;parser;filter;onData;onEnd;_requestId;_chunkSize;_stop;constructor(e){this.parent=e,this.tags=[],this.indexes=[],this.parser=t.defaults.parser,this.filter=t.defaults.filter,this.onData=()=>{},this.onEnd=()=>{},this._requestId=0,this._chunkSize=t.defaults.chunkSize,this._stop=()=>{},e.modules.push({name:"Tagify",onKeyup:ne})}static defaults={chunkSize:100,parser:e=>{let n=e.value.split(/[,.․‧・｡。{}()<>[\]\\/|'"`!?]|\r\n|\r|\n/),i=e.selectionStart,o=0,a=0;for(let c of n){if(a=o+c.length,i>=o&&i<=a)break;o=a+1}let s=e.value.substring(0,o),r=e.value.substring(o,a),h=e.value.substring(a),u=r.match(/^(\s*)(.*?)(\s*)$/);return u&&(s=s+(u[1]||""),r=u[2],h=(u[3]||"")+h),{head:s,body:r,tail:h}},filter:()=>!0};compare(e,n){return z(e,n)}stop(e){let n=this._stop;n?.(e)}set(e){let n=e.query.head.length+e.tag.value.length,i=e.query.head.length+e.tag.value.length,o=e.query.head+e.tag.value+e.query.tail,a={short:n,long:i,value:o};K(this.parent.element,a)}};var se=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:i,shiftKey:o}=b(t);if(!(i&&!n&&!o&&e.toLowerCase()==="z"))return;t.preventDefault();let s=this.element,r=this.history.prev();r&&K(s,r)},ie=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:i,shiftKey:o}=b(t);if(!(i&&!n&&o&&e.toLowerCase()==="z"))return;t.preventDefault();let s=this.element,r=this.history.next();r&&K(s,r)},oe=function(t){let e=this._keydownState;if(this._clearKeydownState(),!e)return;let n=this.element;if(e.value!==n.value)this.history.add();else{let o=e.state,a=x(n);(o.short!==a.short||o.long!==a.long)&&this.history.add(!1)}},C=class t{parent;items;index;maxCount;constructor(e){this.parent=e,this.items=[],this.index=1,this.maxCount=t.defaults.maxCount,e.modules.push({name:"Undo",onKeydown:se},{name:"Redo",onKeydown:ie},{name:"History",onKeyup:oe})}static defaults={maxCount:390};prune(){this.index>1&&(this.items=this.items.slice(0,this.items.length-(this.index-1)),this.index=1)}add(e=!0){let n=this.parent.element;if(e)this.prune();else if(this.index!==1)return;let i=x(n,!0);this.items.push(i),this.items.length>this.maxCount&&this.items.shift()}prev(){return this.index<this.items.length&&(this.index+=1),this.curr()}next(){return this.index>1&&(this.index-=1),this.curr()}curr(){return this.items[this.items.length-this.index]}};var re=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:i,shiftKey:o}=b(t);if(!(i&&!n&&e==="Enter"))return;t.preventDefault();let s=this.element,{short:r,long:h,dir:u,isReversed:c}=x(s),{rows:l,selectedRows:f}=E(s),g=t.shiftKey?f[0]:f[f.length-1],v=[],T=r,p=h;for(let m of l){if(!(g.rowIndex===m.rowIndex)){v.push(m.value);continue}t.shiftKey?(v.push(`
`+m.value),T=m.startIndex,p=m.startIndex):(v.push(m.value+`
`),T=m.endIndex,p=m.endIndex)}K(s,{isReversed:!1,short:T,long:p,dir:"none",value:v.join("")}),this.history.add()},_=class{parent;constructor(e){this.parent=e,e.modules.push({name:"Breakify",onKeydown:re})}static defaults={}};var D=class{element;modules;_keydownState;_keydownEvent;_keyupEvent;_mouseupEvent;constructor(e){this.element=e,this.modules=[],this.history=new C(this),this.commentify=new R(this),this.indentify=new G(this),this.breakify=new _(this),this.pairify=new A(this),this.tagify=new V(this),this._keydownState=null,this._keydownEvent=n=>{for(let i of this.modules)if(i.onKeydown?.call(this,n),n.defaultPrevented){this._clearKeydownState();return}["Meta","Control","Alt","Shift"].includes(n.key)||this._setKeydownState(n)},this._keyupEvent=n=>{let i=this.element;for(let s of this.modules)if(s.onKeyup?.call(this,n),n.defaultPrevented)break;let o=this._keydownState;if(this._clearKeydownState(),!o)return;if(o.value!==i.value)this.history.add();else{let s=o.state,r=x(i);(s.short!==r.short||s.long!==r.long)&&this.history.add(!1)}},this._mouseupEvent=n=>{this.history.add(!1)},this.element.addEventListener("keydown",this._keydownEvent,!0),this.element.addEventListener("keyup",this._keyupEvent,!0),this.element.addEventListener("mouseup",this._mouseupEvent,!0)}getState(e){return x(this.element,e)}setState(e){K(this.element,e)}_clearKeydownState(){this._keydownState=null}_setKeydownState(e){this._keydownState={value:this.element.value,state:x(this.element),key:e.key}}};return J(ae);})();
