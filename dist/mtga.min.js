"use strict";var MtgaJs=(()=>{var D=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames;var $=Object.prototype.hasOwnProperty;var F=(t,e)=>{for(var n in e)D(t,n,{get:e[n],enumerable:!0})},J=(t,e,n,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of W(e))!$.call(t,o)&&o!==n&&D(t,o,{get:()=>e[o],enumerable:!(i=U(e,o))||i.enumerable});return t};var N=t=>J(D({},"__esModule",{value:!0}),t);var ue={};F(ue,{Breakify:()=>_,Commentify:()=>R,History:()=>C,Indentify:()=>G,MTGA:()=>z,Pairify:()=>A,Removify:()=>L,Tagify:()=>V});var K=function(t,e){let n=t.selectionStart>t.selectionEnd,i=Math.min(t.selectionStart,t.selectionEnd),o=Math.max(t.selectionStart,t.selectionEnd),l=t.selectionDirection;return e?{isReversed:n,short:i,long:o,dir:l,value:t.value}:{isReversed:n,short:i,long:o,dir:l}},S=function(t,e){typeof e.value=="string"&&(t.value=e.value),e.isReversed?t.setSelectionRange(e.long,e.short,e.dir||"none"):t.setSelectionRange(e.short,e.long,e.dir||"none"),t.focus()},I=function(t){let e=t.key,n=t.altKey,i=t.shiftKey,o=t.ctrlKey||t.metaKey;return{key:e,altKey:n,shiftKey:i,ctrlKey:o}};function B(t,e){let n=Array.from({length:t.length+1},()=>Array(e.length+1).fill(0));for(let a=1;a<=t.length;a++)for(let c=1;c<=e.length;c++)t[a-1]===e[c-1]?n[a][c]=n[a-1][c-1]+1:n[a][c]=Math.max(n[a-1][c],n[a][c-1]);let i=[],o=0,l=t.length,s=e.length,r=null,f=[],u=function(){r!==null&&f.length>0&&i.push([r,f.reverse().join("")]),r=null,f=[]};for(;l>0||s>0;){let a=t[l-1],c=e[s-1];l>0&&s>0&&a===c?(r!==0&&u(),r=0,f.push(a),o++,l--,s--):s>0&&(l===0||n[l][s-1]>=n[l-1][s])?(r!==1&&u(),r=1,f.push(c),s--):l>0&&(r!==-1&&u(),r=-1,f.push(a),l--)}return u(),{accuracy:o*2/(t.length+e.length),score:o,match:i.reverse()}}var E=function(t){let{short:e,long:n}=K(t),i=t.value.split(/\n/),o=[],l=0;for(let s=0;s<i.length;s++){let r=i[s],f=s===i.length-1,u=f?r:r+`
`,a=l,c=a+u.length,h=-1,d=-1,w="";e>=a&&e<c&&(h=e-a),n>a&&(f?n<=c:n<c)&&(d=n-a),e<=a&&n>=c&&(h=0,d=u.length),h>-1&&d===-1&&(d=u.length),d>-1&&h===-1&&(h=0);let m=h>-1&&d>-1;m&&(w=u.substring(h,d));let v={isSelected:m,index:s,startIndex:a,endIndex:c,value:u,selectionStart:h,selectionEnd:d,selectionValue:w};o.push(v),l=c}return o};var O=function(t,e){return Object.keys(t).includes(e)};var q=function(t,e){return t[e]},X=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:i,shiftKey:o}=I(t),l=this.element,s=this.pairify.pairs;if(!(!i&&!n&&O(s,e)))return;t.preventDefault();let{short:f,long:u,dir:a,isReversed:c}=K(l),h=f!==u,d=e,w=q(s,d),m=l.value.substring(0,f),v=l.value.substring(f,u),g=l.value.substring(u),y,b,x;if(h)x=m+d+v+w+g,y=(m+d).length,b=(m+d+v).length;else{let p=(m+d).length;x=m+d+w+g,y=p,b=p}S(l,{isReversed:c,short:y,long:b,dir:a,value:x}),this.history.add()},Y=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:i,shiftKey:o}=I(t);if(!(!i&&!n&&!o&&e==="Backspace"))return;let s=this.element,r=this.pairify.pairs,{short:f,long:u,dir:a,isReversed:c}=K(s);if(f!==u)return;let d=s.value.charAt(u-1),w=q(r,d);if(!(O(r,d)&&q(r,d)===w))return;t.preventDefault();let v=s.value.substring(0,u-1),g=s.value.substring(u+1),y=v+g,b=v.length,x=v.length;S(s,{isReversed:!1,short:b,long:x,dir:"forward",value:y}),this.history.add()},A=class t{parent;pairs;constructor(e){this.parent=e,this.pairs={...t.defaults.pairs},e.modules.push({name:"ClosePair",onKeydown:X},{name:"ClearPair",onKeydown:Y})}static defaults={pairs:{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}}};var Z=function(t){for(let e of t)if(e.value.startsWith("//"))return!0;return!1},ee=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:i,shiftKey:o}=I(t);if(!(i&&!n&&!o&&e==="/"))return;t.preventDefault();let s=this.element,{pattern:r,value:f}=this.commentify,u=E(s),{short:a,long:c,dir:h,isReversed:d}=K(s),w=u.filter(x=>x.isSelected),m=w.length>1,v=Z(w),g=a,y=c,b=[];for(let x=0;x<u.length;x++){let p=u[x],{startIndex:M,endIndex:P}=p,j=p.value;if(!p.isSelected){b.push(p.value);continue}let k;if(m){let H=!p.value.trim();v?k=p.value.replace(r,""):H?k=p.value:k=f+p.value}else v?k=p.value.replace(r,""):k=f+p.value;let T=k.length-j.length;a>=M&&a<P?T>=0?(g+=T,y+=T):(g+=Math.max(T,M-a),y+=Math.max(T,M-c)):c>=M&&a<P?T>=0?y+=T:y+=Math.max(T,M-c):(g+=T,y+=T),b.push(k)}S(s,{isReversed:d,short:g,long:y,dir:h,value:b.join("")}),this.history.add()},R=class t{parent;pattern;value;constructor(e){this.parent=e,this.pattern=t.defaults.pattern,this.value=t.defaults.value,e.modules.push({name:"Commentify",onKeydown:ee})}static defaults={pattern:/^\/\/\s?/,value:"// "}};var te=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:i,shiftKey:o}=I(t);if(!(!i&&!n&&e==="Tab"))return;t.preventDefault();let s=this.element,{pattern:r,value:f}=this.indentify,u=E(s),{short:a,long:c,dir:h,isReversed:d}=K(s),m=u.filter(x=>x.isSelected).length>1,v=t.shiftKey,g=a,y=c,b=[];for(let x=0;x<u.length;x++){let p=u[x],{startIndex:M,endIndex:P}=p,j=p.value;if(!p.isSelected){b.push(p.value);continue}let k;if(m){let H=!p.value.trim();v?k=p.value.replace(r,""):H?k=p.value:k=f+p.value}else v?k=p.value.replace(r,""):k=f+p.value;let T=k.length-j.length;a>=M&&a<P?T>=0?(g+=T,y+=T):(g+=Math.max(T,M-a),y+=Math.max(T,M-c)):c>=M&&a<P?T>=0?y+=T:y+=Math.max(T,M-c):(g+=T,y+=T),b.push(k)}S(s,{isReversed:d,short:g,long:y,dir:h,value:b.join("")}),this.history.add()},G=class t{parent;pattern;value;constructor(e){this.parent=e,this.pattern=t.defaults.pattern,this.value=t.defaults.value,e.modules.push({name:"Indentify",onKeydown:te})}static defaults={pattern:/^[^\S\n\r][^\S\n\r]?/,value:"  "}};var ne=function(t,e){for(let n of t)if(n.pattern.test(e))return n},se=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:i,shiftKey:o}=I(t);if(!(!i&&(e.length===1||e==="Backspace")))return;let s=this.tagify;s.stop(!0);let r=s._requestId+1,f=s._chunkSize,u=[],a=!1,c=!1,h=0,d=y=>{a=!0,c=y||!1};s._requestId=r,s._stop=d;let w=s.parser.call(this,this.element),m=w.body,v=[];if(m){let y=ne(s.indexes,m);y?v=y.tags:v=s.tags}let g=()=>{let y=[],b=h+f;for(;h<b&&h<v.length;){let p={tag:v[h],query:w};s.filter?.call(this,p,h,v,u)&&(y.push(p),u.push(p)),h++}if(!(c||s._requestId!==r)){if(a||h>=v.length){s.onData?.call(this,y,u),s.onEnd?.call(this,u);return}s.onData?.call(this,y,u),setTimeout(g,0)}};g()},V=class t{parent;tags;indexes;parser;filter;onData;onEnd;_requestId;_chunkSize;_stop;constructor(e){this.parent=e,this.tags=[],this.indexes=[],this.parser=t.defaults.parser,this.filter=t.defaults.filter,this.onData=()=>{},this.onEnd=()=>{},this._requestId=0,this._chunkSize=t.defaults.chunkSize,this._stop=()=>{},e.modules.push({name:"Tagify",onKeyup:se})}static defaults={chunkSize:100,parser:e=>{let n=e.value.split(/[,.․‧・｡。{}()<>[\]\\/|'"`!?]|\r\n|\r|\n/),i=e.selectionStart,o=0,l=0;for(let a of n){if(l=o+a.length,i>=o&&i<=l)break;o=l+1}let s=e.value.substring(0,o),r=e.value.substring(o,l),f=e.value.substring(l),u=r.match(/^(\s*)(.*?)(\s*)$/);return u&&(s=s+(u[1]||""),r=u[2],f=(u[3]||"")+f),{head:s,body:r,tail:f}},filter:()=>!0};compare(e,n){return B(e,n)}stop(e){let n=this._stop;n?.(e)}set(e){let n=e.query.head.length+e.tag.value.length,i=e.query.head.length+e.tag.value.length,o=e.query.head+e.tag.value+e.query.tail,l={short:n,long:i,value:o};S(this.parent.element,l)}};var ie=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:i,shiftKey:o}=I(t);if(!(i&&!n&&!o&&e.toLowerCase()==="z"))return;t.preventDefault();let s=this.element,r=this.history.prev();r&&S(s,r)},oe=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:i,shiftKey:o}=I(t);if(!(i&&!n&&o&&e.toLowerCase()==="z"))return;t.preventDefault();let s=this.element,r=this.history.next();r&&S(s,r)},re=function(t){let e=this._keydownState;if(this._clearKeydownState(),!e)return;let n=this.element;if(e.value!==n.value)this.history.add();else{let o=e.state,l=K(n);(o.short!==l.short||o.long!==l.long)&&this.history.add(!1)}},C=class t{parent;items;index;maxCount;constructor(e){this.parent=e,this.items=[],this.index=1,this.maxCount=t.defaults.maxCount,e.modules.push({name:"Undo",onKeydown:ie},{name:"Redo",onKeydown:oe},{name:"History",onKeyup:re})}static defaults={maxCount:390};prune(){this.index>1&&(this.items=this.items.slice(0,this.items.length-(this.index-1)),this.index=1)}add(e=!0){let n=this.parent.element;if(e)this.prune();else if(this.index!==1)return;let i=K(n,!0);this.items.push(i),this.items.length>this.maxCount&&this.items.shift()}prev(){return this.index<this.items.length&&(this.index+=1),this.curr()}next(){return this.index>1&&(this.index-=1),this.curr()}curr(){return this.items[this.items.length-this.index]}};var ae=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:i,shiftKey:o}=I(t);if(!(i&&!n&&e==="Enter"))return;t.preventDefault();let s=this.element,{short:r,long:f,dir:u,isReversed:a}=K(s),c=E(s),h=c.filter(g=>g.isSelected),d=t.shiftKey?h[0]:h[h.length-1],w=[],m=r,v=f;for(let g of c){if(!(d.index===g.index)){w.push(g.value);continue}t.shiftKey?(w.push(`
`+g.value),m=g.startIndex,v=g.startIndex):(w.push(g.value+`
`),m=g.endIndex,v=g.endIndex)}S(s,{isReversed:!1,short:m,long:v,dir:"none",value:w.join("")}),this.history.add()},_=class{parent;constructor(e){this.parent=e,e.modules.push({name:"Breakify",onKeydown:ae})}static defaults={}};var le=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:i,shiftKey:o}=I(t);if(!(i&&!n&&o&&e.toLowerCase()==="k"))return;t.preventDefault();let s=this.element,r=E(s),f=r.filter(m=>m.isSelected),u=f[0],a=[],c=0,h=0;for(let m of r)m.isSelected||(m.index===u.index-1&&(c=m.startIndex,h=m.startIndex),a.push(m.value));let d=a.join("");f.length===1&&f[0].value===""&&r[r.length-1].index===f[0].index&&(d=d.substring(0,d.length-1)),S(s,{isReversed:!1,short:c,long:h,dir:"none",value:d}),this.history.add()},L=class{parent;constructor(e){this.parent=e,e.modules.push({name:"Removify",onKeydown:le})}static defaults={}};var z=class{element;modules;_keydownState;_keydownEvent;_keyupEvent;_mouseupEvent;constructor(e){this.element=e,this.modules=[],this.history=new C(this),this.commentify=new R(this),this.indentify=new G(this),this.breakify=new _(this),this.removify=new L(this),this.pairify=new A(this),this.tagify=new V(this),this._keydownState=null,this._keydownEvent=n=>{for(let i of this.modules)i.onKeydown?.call(this,n);n.defaultPrevented?this._clearKeydownState():["Meta","Control","Alt","Shift"].includes(n.key)||this._setKeydownState(n)},this._keyupEvent=n=>{for(let s of this.modules)s.onKeyup?.call(this,n);let i=this.element,o=this._keydownState;if(this._clearKeydownState(),!o)return;if(o.value!==i.value)this.history.add();else{let s=o.state,r=K(i);(s.short!==r.short||s.long!==r.long)&&this.history.add(!1)}},this._mouseupEvent=n=>{this.history.add(!1)},this.element.addEventListener("keydown",this._keydownEvent,!0),this.element.addEventListener("keyup",this._keyupEvent,!0),this.element.addEventListener("mouseup",this._mouseupEvent,!0)}getState(e){return K(this.element,e)}setState(e){S(this.element,e)}_clearKeydownState(){this._keydownState=null}_setKeydownState(e){this._keydownState={value:this.element.value,state:K(this.element),key:e.key}}};return N(ue);})();
