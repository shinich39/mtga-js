"use strict";var MtgaJs=(()=>{var G=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var q=Object.prototype.hasOwnProperty;var D=(e,t)=>{for(var n in t)G(e,n,{get:t[n],enumerable:!0})},z=(e,t,n,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of j(t))!q.call(e,r)&&r!==n&&G(e,r,{get:()=>t[r],enumerable:!(i=L(t,r))||i.enumerable});return e};var O=e=>z(G({},"__esModule",{value:!0}),e);var Z={};D(Z,{Commentify:()=>k,History:()=>A,Indentify:()=>E,MTGA:()=>_,Pairify:()=>w,Tagify:()=>M});var T=function(e,t){let n=e.selectionStart>e.selectionEnd,i=Math.min(e.selectionStart,e.selectionEnd),r=Math.max(e.selectionStart,e.selectionEnd),a=e.selectionDirection;return t?{isReversed:n,short:i,long:r,dir:a,value:e.value}:{isReversed:n,short:i,long:r,dir:a}},v=function(e,t){t.value&&(e.value=t.value),t.isReversed?e.setSelectionRange(t.long,t.short,t.dir||"none"):e.setSelectionRange(t.short,t.long,t.dir||"none"),e.focus()},S=function(e){let t=e.key,n=e.altKey,i=e.shiftKey,r=e.ctrlKey||e.metaKey;return{key:t,altKey:n,shiftKey:i,ctrlKey:r}};function P(e,t){let n=Array.from({length:e.length+1},()=>Array(t.length+1).fill(0));for(let c=1;c<=e.length;c++)for(let f=1;f<=t.length;f++)e[c-1]===t[f-1]?n[c][f]=n[c-1][f-1]+1:n[c][f]=Math.max(n[c-1][f],n[c][f-1]);let i=[],r=0,a=e.length,s=t.length,o=null,u=[],h=function(){o!==null&&u.length>0&&i.push([o,u.reverse().join("")]),o=null,u=[]};for(;a>0||s>0;){let c=e[a-1],f=t[s-1];a>0&&s>0&&c===f?(o!==0&&h(),o=0,u.push(c),r++,a--,s--):s>0&&(a===0||n[a][s-1]>=n[a-1][s])?(o!==1&&h(),o=1,u.push(f),s--):a>0&&(o!==-1&&h(),o=-1,u.push(c),a--)}return h(),{accuracy:r*2/(e.length+t.length),score:r,match:i.reverse()}}var R=function(e){let{short:t,long:n}=T(e),i=e.value.split(/\n/),r=[],a=[],s=0;for(let o=0;o<i.length;o++){let u=i[o],c=o===i.length-1?u:u+`
`,f=s,y=s+u.length+1,d=-1,l=-1,m="";t>=f&&t<y&&(d=t-f),n>f&&n<y&&(l=n-f),t<=f&&n>=y&&(d=0,l=c.length),d>-1&&l===-1&&(l=c.length),l>-1&&d===-1&&(d=0);let g=d>-1&&l>-1;g&&(m=c.substring(d,l));let x={rowIndex:o,startIndex:f,endIndex:y,value:c,selectionStart:d,selectionEnd:l,selectionValue:m};r.push(x),g&&a.push(x),s=y}return{rows:r,selectedRows:a}},C=function(e,t,n){let{short:i,long:r,dir:a,isReversed:s}=T(e),o=i,u=r,h=[];for(let c of t){let{startIndex:f,endIndex:y}=c,d=c.value,l=n(c),m=l.length-d.length;i>=f&&i<y?m>=0?(o+=m,u+=m):(o+=Math.max(m,f-i),u+=Math.max(m,f-r)):r>=f&&i<y?m>=0?u+=m:u+=Math.max(m,f-r):u+=m,h.push(l)}return{isReversed:s,short:o,long:u,dir:a,value:h.join("")}};var H=function(e,t){return Object.keys(e).includes(t)};var V=function(e,t){return e[t]},Q=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:i,shiftKey:r}=S(e),a=this.element,s=this.pairify.pairs;if(!(!i&&!n&&H(s,t)))return;e.preventDefault();let{short:u,long:h,dir:c,isReversed:f}=T(a),y=u!==h,d=t,l=V(s,d),m=a.value.substring(0,u),g=a.value.substring(u,h),x=a.value.substring(h),p,K,I;if(y)I=m+d+g+l+x,p=(m+d).length,K=(m+d+g).length;else{let b=(m+d).length;I=m+d+l+x,p=b,K=b}v(a,{isReversed:f,short:p,long:K,dir:c,value:I}),this.history.add()},B=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:i,shiftKey:r}=S(e);if(!(!i&&!n&&!r&&t==="Backspace"))return;let s=this.element,o=this.pairify.pairs,{short:u,long:h,dir:c,isReversed:f}=T(s);if(u!==h)return;let d=s.value.charAt(h-1),l=V(o,d);if(!(H(o,d)&&V(o,d)===l))return;e.preventDefault();let g=s.value.substring(0,h-1),x=s.value.substring(h+1),p=g+x,K=g.length,I=g.length;v(s,{isReversed:!1,short:K,long:I,dir:"forward",value:p}),this.history.add()},w=class e{parent;pairs;constructor(t){this.parent=t,this.pairs={...e.defaults.pairs},t.modules.push({name:"ClosePair",onKeydown:Q},{name:"ClearPair",onKeydown:B})}static defaults={pairs:{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}}};var U=function(e){for(let t of e)if(t.value.startsWith("//"))return!0;return!1},W=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:i,shiftKey:r}=S(e);if(!(i&&!n&&!r&&t==="/"))return;e.preventDefault();let s=this.element,{pattern:o,value:u}=this.commentify,{rows:h,selectedRows:c}=R(s),f=c.length>1,y=U(c),d=C(s,h,l=>{if(!(l.selectionStart>-1||l.selectionEnd>-1))return l.value;if(f){let g=!l.value.trim();return y?l.value.replace(o,""):g?l.value:u+l.value}else return y?l.value.replace(o,""):u+l.value});v(s,d),this.history.add()},k=class e{parent;pattern;value;constructor(t){this.parent=t,this.pattern=e.defaults.pattern,this.value=e.defaults.value,t.modules.push({name:"Commentify",onKeydown:W})}static defaults={pattern:/^\/\/\s?/,value:"// "}};var $=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:i,shiftKey:r}=S(e);if(!(!i&&!n&&t==="Tab"))return;e.preventDefault();let s=this.element,{pattern:o,value:u}=this.indentify,{rows:h,selectedRows:c}=R(s),f=c.length>1,y=e.shiftKey,d=C(s,h,l=>{if(!(l.selectionStart>-1||l.selectionEnd>-1))return l.value;if(f){let g=!l.value.trim();return y?l.value.replace(o,""):g?l.value:u+l.value}else return y?l.value.replace(o,""):u+l.value});v(s,d),this.history.add()},E=class e{parent;pattern;value;constructor(t){this.parent=t,this.pattern=e.defaults.pattern,this.value=e.defaults.value,t.modules.push({name:"Indentify",onKeydown:$})}static defaults={pattern:/^[^\S\n\r][^\S\n\r]?/,value:"  "}};var F=function(e,t){for(let n of e)if(n.pattern.test(t))return n},J=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:i,shiftKey:r}=S(e);if(!(!i&&(t.length===1||t==="Backspace")))return;let s=this.tagify;s.stop(!0);let o=s._requestId+1,u=s._chunkSize,h=[],c=!1,f=!1,y=0,d=p=>{c=!0,f=p||!1};s._requestId=o,s._stop=d;let l=s.parser.call(this,this.element),m=l.body,g=[];if(m){let p=F(s.indexes,m);p?g=p.tags:g=s.tags}let x=()=>{let p=[],K=y+u;for(;y<K&&y<g.length;){let b={tag:g[y],query:l};s.filter?.call(this,b,y,g,h)&&(p.push(b),h.push(b)),y++}if(!(f||s._requestId!==o)){if(c||y>=g.length){s.onData?.call(this,p,h),s.onEnd?.call(this,h);return}s.onData?.call(this,p,h),setTimeout(x,0)}};x()},M=class e{parent;tags;indexes;parser;filter;onData;onEnd;_requestId;_chunkSize;_stop;constructor(t){this.parent=t,this.tags=[],this.indexes=[],this.parser=e.defaults.parser,this.filter=e.defaults.filter,this.onData=()=>{},this.onEnd=()=>{},this._requestId=0,this._chunkSize=e.defaults.chunkSize,this._stop=()=>{},t.modules.push({name:"Tagify",onKeyup:J})}static defaults={chunkSize:100,parser:t=>{let n=t.value.split(/[,.․‧・｡。{}()<>[\]\\/|'"`!?]|\r\n|\r|\n/),i=t.selectionStart,r=0,a=0;for(let c of n){if(a=r+c.length,i>=r&&i<=a)break;r=a+1}let s=t.value.substring(0,r),o=t.value.substring(r,a),u=t.value.substring(a),h=o.match(/^(\s*)(.*?)(\s*)$/);return h&&(s=s+(h[1]||""),o=h[2],u=(h[3]||"")+u),{head:s,body:o,tail:u}},filter:()=>!0};compare(t,n){return P(t,n)}stop(t){let n=this._stop;n?.(t)}set(t){let n=t.query.head.length+t.tag.value.length,i=t.query.head.length+t.tag.value.length,r=t.query.head+t.tag.value+t.query.tail,a={short:n,long:i,value:r};v(this.parent.element,a)}};var N=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:i,shiftKey:r}=S(e);if(!(i&&!n&&!r&&t.toLowerCase()==="z"))return;e.preventDefault();let s=this.element,o=this.history.prev();o&&v(s,o)},X=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:i,shiftKey:r}=S(e);if(!(i&&!n&&r&&t.toLowerCase()==="z"))return;e.preventDefault();let s=this.element,o=this.history.next();o&&v(s,o)},Y=function(e){let t=this._keydownState;if(this._clearKeydownState(),!t)return;let n=this.element;if(t.value!==n.value)this.history.add();else{let r=t.state,a=T(n);(r.short!==a.short||r.long!==a.long)&&this.history.add(!1)}},A=class e{parent;items;index;maxCount;constructor(t){this.parent=t,this.items=[],this.index=1,this.maxCount=e.defaults.maxCount,t.modules.push({name:"Undo",onKeydown:N},{name:"Redo",onKeydown:X},{name:"History",onKeyup:Y})}static defaults={maxCount:390};prune(){this.index>1&&(this.items=this.items.slice(0,this.items.length-(this.index-1)),this.index=1)}add(t=!0){let n=this.parent.element;if(t)this.prune();else if(this.index!==1)return;let i=T(n,!0);this.items.push(i),this.items.length>this.maxCount&&this.items.shift()}prev(){return this.index<this.items.length&&(this.index+=1),this.curr()}next(){return this.index>1&&(this.index-=1),this.curr()}curr(){return this.items[this.items.length-this.index]}};var _=class{element;modules;_keydownState;_keydownEvent;_keyupEvent;_mouseupEvent;constructor(t){this.element=t,this.modules=[],this.history=new A(this),this.commentify=new k(this),this.indentify=new E(this),this.pairify=new w(this),this.tagify=new M(this),this._keydownState=null,this._keydownEvent=n=>{for(let i of this.modules)if(i.onKeydown?.call(this,n),n.defaultPrevented){this._clearKeydownState();return}["Meta","Control","Alt","Shift"].includes(n.key)||this._setKeydownState(n)},this._keyupEvent=n=>{let i=this.element;for(let s of this.modules)if(s.onKeyup?.call(this,n),n.defaultPrevented)break;let r=this._keydownState;if(this._clearKeydownState(),!r)return;if(r.value!==i.value)this.history.add();else{let s=r.state,o=T(i);(s.short!==o.short||s.long!==o.long)&&this.history.add(!1)}},this._mouseupEvent=n=>{this.history.add(!1)},this.element.addEventListener("keydown",this._keydownEvent,!0),this.element.addEventListener("keyup",this._keyupEvent,!0),this.element.addEventListener("mouseup",this._mouseupEvent,!0)}getState(t){return T(this.element,t)}setState(t){v(this.element,t)}_clearKeydownState(){this._keydownState=null}_setKeydownState(t){this._keydownState={value:this.element.value,state:T(this.element),key:t.key}}};return O(Z);})();
