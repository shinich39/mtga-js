var y=function(i,t){let e=i.selectionStart>i.selectionEnd,s=Math.min(i.selectionStart,i.selectionEnd),n=Math.max(i.selectionStart,i.selectionEnd),r=i.selectionDirection;return t?{isReversed:e,short:s,long:n,dir:r,value:i.value}:{isReversed:e,short:s,long:n,dir:r}},p=function(i,t){t.value&&(i.value=t.value),t.isReversed?i.setSelectionRange(t.long,t.short,t.dir||"none"):i.setSelectionRange(t.short,t.long,t.dir||"none"),i.focus()},v=function(i){let t=i.key,e=i.altKey,s=i.shiftKey,n=i.ctrlKey||i.metaKey;return{key:t,altKey:e,shiftKey:s,ctrlKey:n}};function k(i,t){let e=Array.from({length:i.length+1},()=>Array(t.length+1).fill(0));for(let l=1;l<=i.length;l++)for(let u=1;u<=t.length;u++)i[l-1]===t[u-1]?e[l][u]=e[l-1][u-1]+1:e[l][u]=Math.max(e[l-1][u],e[l][u-1]);let s=[],n=0,r=i.length,a=t.length,c=null,o=[],h=function(){c!==null&&o.length>0&&s.push([c,o.reverse().join("")]),c=null,o=[]};for(;r>0||a>0;){let l=i[r-1],u=t[a-1];r>0&&a>0&&l===u?(c!==0&&h(),c=0,o.push(l),n++,r--,a--):a>0&&(r===0||e[r][a-1]>=e[r-1][a])?(c!==1&&h(),c=1,o.push(u),a--):r>0&&(c!==-1&&h(),c=-1,o.push(l),r--)}return h(),{accuracy:n*2/(i.length+t.length),score:n,match:s.reverse()}}function _(i){let t=[],e=i.length;for(let s=1;s<1<<e;s++){let n=[];for(let r=0;r<e;r++)s>>r&1&&n.push(i[r]);t.push(n)}return t}var b=function(i){let{short:t,long:e}=y(i),s=i.value.split(/\n/),n=[],r=[],a=0;for(let c=0;c<s.length;c++){let o=s[c],l=c===s.length-1?o:o+`
`,u=a,m=a+o.length+1,d=-1,f=-1,g="";t>=u&&t<m&&(d=t-u),e>u&&e<m&&(f=e-u),t<=u&&e>=m&&(d=0,f=l.length),d>-1&&f===-1&&(f=l.length),f>-1&&d===-1&&(d=0);let x=d>-1&&f>-1;x&&(g=l.substring(d,f));let S={rowIndex:c,startIndex:u,endIndex:m,value:l,selectionStart:d,selectionEnd:f,selectionValue:g};n.push(S),x&&r.push(S),a=m}return{rows:n,selectedRows:r}},K=function(i,t,e){let{short:s,long:n,dir:r,isReversed:a}=y(i),c=s,o=n,h=[];for(let l of t){let{startIndex:u,endIndex:m}=l,d=l.value,f=e(l),g=f.length-d.length;s>=u&&s<m?g>=0?(c+=g,o+=g):(c+=Math.max(g,u-s),o+=Math.max(g,u-n)):n>=u&&s<m?g>=0?o+=g:o+=Math.max(g,u-n):o+=g,h.push(f)}return{isReversed:a,short:c,long:o,dir:r,value:h.join("")}};var L=function(i,t){return Object.keys(i).includes(t)};var H=function(i,t){return i[t]},w=class{element;pairs;constructor(t,e){this.element=t,this.pairs=e}isInsert(t){let{key:e,altKey:s,ctrlKey:n,shiftKey:r}=v(t);return!s&&!n&&L(this.pairs,e)}isDelete(t){let e=this.element,s=this.pairs,{key:n,altKey:r,ctrlKey:a,shiftKey:c}=v(t);if(r||a||c||n!=="Backspace")return!1;let{short:o,long:h,dir:l,isReversed:u}=y(e);if(o!==h)return!1;let d=e.value.charAt(h-1),f=e.value.charAt(h);return L(s,d)&&H(s,d)===f}insert(t){let e=this.element,s=this.pairs,{key:n}=v(t),{short:r,long:a,dir:c,isReversed:o}=y(e),h=r!==a,l=n,u=H(s,l),m=e.value.substring(0,r),d=e.value.substring(r,a),f=e.value.substring(a),g,x,S;if(h)S=m+l+d+u+f,g=(m+l).length,x=(m+l+d).length;else{let A=(m+l).length;S=m+l+u+f,g=A,x=A}p(e,{isReversed:o,short:g,long:x,dir:c,value:S})}delete(t){let e=this.element,s=this.pairs,{long:n}=y(e),r=e.value.substring(0,n-1),a=e.value.substring(n+1),c=r+a,o=r.length,h=r.length;p(e,{isReversed:!1,short:o,long:h,dir:"forward",value:c})}};var C=function(i){let{key:t,altKey:e,ctrlKey:s,shiftKey:n}=v(i);return s&&!n&&t.toLowerCase()==="z"},M=function(i){let{key:t,altKey:e,ctrlKey:s,shiftKey:n}=v(i);return s&&n&&t.toLowerCase()==="z"},I=class{element;histories;index;maxCount;constructor(t){this.element=t,this.histories=[],this.index=1,this.maxCount=390}prune(){this.index>1&&(this.histories=this.histories.slice(0,this.histories.length-(this.index-1)),this.index=1)}add(t=!0){let e=this.element;if(t)this.prune();else if(this.index!==1)return;let s=y(e,!0);this.histories.push(s),this.histories.length>this.maxCount&&this.histories.shift()}prev(){this.index<this.histories.length&&(this.index+=1)}next(){this.index>1&&(this.index-=1)}curr(){return this.histories[this.histories.length-this.index]}undo(t){let e=this.element;this.prev();let s=this.curr();s&&p(e,s)}redo(t){let e=this.element;this.next();let s=this.curr();s&&p(e,s)}};var V=function(i){for(let t of i)if(t.value.startsWith("//"))return!0;return!1},E=class{element;key;removePattern;newValue;constructor(t){this.element=t,this.key="/",this.removePattern=/^\/\/\s?/,this.newValue="// "}isValid(t){let{key:e,altKey:s,shiftKey:n}=t;return(t.ctrlKey||t.metaKey)&&!s&&!n&&e===this.key}exec(t){let e=this.element,{rows:s,selectedRows:n}=b(e),r=n.length>1,a=V(n),c=K(e,s,o=>{if(!(o.selectionStart>-1||o.selectionEnd>-1))return o.value;if(r){let l=!o.value.trim();return a?o.value.replace(this.removePattern,""):l?o.value:this.newValue+o.value}else return a?o.value.replace(this.removePattern,""):this.newValue+o.value});p(e,c)}};var R=class{element;key;removePattern;newValue;constructor(t){this.element=t,this.key="Tab",this.removePattern=/^[^\S\n\r][^\S\n\r]?/,this.newValue="  "}isValid(t){let{key:e,altKey:s,shiftKey:n}=t;return!(t.ctrlKey||t.metaKey)&&!s&&e===this.key}exec(t){let e=this.element,{rows:s,selectedRows:n}=b(e),r=n.length>1,a=t.shiftKey,c=K(e,s,o=>{if(!(o.selectionStart>-1||o.selectionEnd>-1))return o.value;if(r){let l=!o.value.trim();return a?o.value.replace(this.removePattern,""):l?o.value:this.newValue+o.value}else return a?o.value.replace(this.removePattern,""):this.newValue+o.value});p(e,c)}};var j=function(i,t){let e=Object.keys(i).sort((s,n)=>n.length-s.length);for(let s of e){let{score:n}=k(s,t);if(n===s.length)return i[s]}},D=function(i,t){let e={};if(t>0)for(let s of i){let{key:n,value:r}=s,a=[],c=_(n.split(""));for(let h of c)h.length<=t&&a.push(h.join(""));let o=[...new Set(a)];for(let h of o)e[h]?e[h].push(s):e[h]=[s]}return e},T=class{element;tags;index;result;parser;filter;onLoad;_state;_stop;constructor(t){this.element=t,this.tags=[],this.index={},this._state=y(t,!0),this.result=[],this.parser=e=>{let s=e.value.split(/[,.\s․‧・｡。{}()<>[\]\\/|'"`!?]/),n=e.selectionStart,r=0,a=0;for(let l of s){if(a=r+l.length,n>=r&&n<=a)break;r=a+1}let c=e.value.substring(0,r),o=e.value.substring(r,a).trim().replace(/\s/g,"_"),h=e.value.substring(a);return{head:c,body:o,tail:h}},this.filter=()=>!0,this._stop=null,this.onLoad=null}stop(t){this._stop&&this._stop(t)}clear(){this._stop&&this._stop(!0),this.result=[]}createIndex(t=1){this.index=D(this.tags,t)}reset(){p(this.element,this._state)}set(t){let e=t.parts.head.length+t.tag.value.length,s=t.parts.head.length+t.tag.value.length,n=t.parts.head+t.tag.value+t.parts.tail,r={short:e,long:s,value:n};p(this.element,r)}exec(){this.clear(),this._state=y(this.element,!0);let t=!1,e=!1;this._stop=o=>{t=!0,e=o||!1,this._stop=null};let s=this._stop,n=this.result,r=this.parser(this.element),a=r.body,c=a?j(this.index,a)||this.tags:[];for(let o=0;o<c.length;o++){let h=c[o],l={...k(a,h.key),tag:h,parts:r};if(this.filter(l,o,c,s)&&n.push(l),t)break}return e||this.onLoad?.(n),n}};var P=class{element;_keydownState;History;Commentify;Indentify;AutoPairing;AutoComplete;constructor(t){this.element=t,this._keydownState=null,this.History=new I(t),this.Commentify=new E(t),this.Indentify=new R(t),this.AutoPairing=new w(t,{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}),this.AutoComplete=new T(t),t.addEventListener("keydown",e=>{C(e)?(e.preventDefault(),this.History.undo(e),this._clearKeydownState()):M(e)?(e.preventDefault(),this.History.redo(e),this._clearKeydownState()):this.AutoPairing.isInsert(e)?(e.preventDefault(),this.AutoPairing.insert(e),this.History.add(),this._clearKeydownState()):this.AutoPairing.isDelete(e)?(e.preventDefault(),this.AutoPairing.delete(e),this.History.add(),this._clearKeydownState()):this.Commentify.isValid(e)?(e.preventDefault(),this.Commentify.exec(e),this.History.add(),this._clearKeydownState()):this.Indentify.isValid(e)?(e.preventDefault(),this.Indentify.exec(e),this.History.add(),this._clearKeydownState()):["Meta","Control","Alt","Shift"].includes(e.key)||this._setKeydownState(e)}),t.addEventListener("keyup",e=>{let s=this._keydownState;if(this._clearKeydownState(),!s)return;if(s.value!==t.value)this.History.add(),this.AutoComplete.exec();else{let r=s.state,a=y(t);(r.short!==a.short||r.long!==a.long)&&this.History.add(!1)}}),this.element.addEventListener("mouseup",e=>{this.History.add(!1)})}getState(t){return y(this.element,t)}setState(t){p(this.element,t)}_clearKeydownState(){this._keydownState=null}_setKeydownState(t){this._keydownState={value:this.element.value,state:y(this.element),key:t.key}}};export{P as MTGA};
