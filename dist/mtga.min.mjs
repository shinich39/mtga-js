var B=function(t,e){let n=t.selectionStart>t.selectionEnd,s=Math.min(t.selectionStart,t.selectionEnd),o=Math.max(t.selectionStart,t.selectionEnd),u=t.selectionDirection;return e?{isReversed:n,short:s,long:o,dir:u,value:t.value}:{isReversed:n,short:s,long:o,dir:u}},F=function(t,e){typeof e.value=="string"&&(t.value=e.value),e.isReversed?t.setSelectionRange(e.long,e.short,e.dir):t.setSelectionRange(e.short,e.long,e.dir),t.focus()};var x=class{parent;name;index;onKeydown;onKeydownAsync;onKeyup;onKeyupAsync;onPaste;onPasteAsync;constructor(e,n,s=9999){this.parent=e,this.name=n,this.index=s}static defaults={}};var S=function(t){let e=t.key,n=t.altKey,s=t.shiftKey,o=t.ctrlKey||t.metaKey;return{key:e,altKey:n,shiftKey:s,ctrlKey:o}};function $(t,e,n){let s=function(r,d){return r.repeat(Math.ceil(d/r.length)).slice(0,d)},o=Object.keys(t).join(""),u=Object.values(t).join("");for(let r=n.length-1;r>=0;r--){let d=n[r];for(let c=d.length-1;c>=0;c--){let i=d[c];if(u.includes(i)){let a=d.match(/^\s*/)?.[0].length||0;return s(e,a)}if(o.includes(i)){let a=(d.match(/^\s*/)?.[0].length||0)+e.length;return s(e,a)}}}return""}var ee=function(t){if(t.defaultPrevented)return;let e=this.parent,{key:n,altKey:s,ctrlKey:o,shiftKey:u}=S(t);if(!(o&&!s&&n.toLowerCase()==="z"))return;t.preventDefault();let d;u?d=this.next():d=this.prev(),d&&e.setState(d,!1,!1)},te=function(t){let e=this.parent,n=e._keydownState;if(e._removeKeydownState(),!n)return;let s=e.element,o=n.value,u=s.value;if(o!==u)e.addHistory();else{let r=n.state,d=e.getState();(r.short!==d.short||r.long!==d.long)&&e.addHistory(!1)}},P=class t extends x{items;maxCount;_i;constructor(e){super(e,t.name,0),this.items=[],this.maxCount=t.defaults.maxCount,this._i=1}static name="History";static defaults={maxCount:390};onKeydown=ee;onKeyup=te;prune(){this._i>1&&(this.items=this.items.slice(0,this.items.length-(this._i-1)),this._i=1)}add(e=!0){let n=this.parent;if(e)this.prune();else if(this._i!==1)return;let s=this.items[this.items.length-1],o=n.getState(!0);(!s||s.short!==o.short||s.long!==o.long||s.value!==o.value)&&(this.items.push(o),this.items.length>this.maxCount&&this.items.shift())}remove(){this.items.pop()}prev(){return this._i<this.items.length&&(this._i+=1),this.curr()}next(){return this._i>1&&(this._i-=1),this.curr()}curr(){return this.items[this.items.length-this._i]}};var I=function(t){let{short:e,long:n}=B(t),s=t.value.split(/\n/),o=[],u=0;for(let r=0;r<s.length;r++){let d=s[r],c=r===s.length-1,i=c?d:d+`
`,a=u,h=a+i.length,g=-1,v=-1,l="";e>=a&&e<h&&(g=e-a),n>a&&(c?n<=h:n<h)&&(v=n-a),e<=a&&n>=h&&(g=0,v=i.length),g>-1&&v===-1&&(v=i.length),v>-1&&g===-1&&(g=0);let m={isSelected:g>-1&&v>-1,index:r,startIndex:a,endIndex:h,value:i,selectionStart:g,selectionEnd:v};o.push(m),u=h}return o};var ne=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:u,shiftKey:r}=S(t);if(!(u&&!o&&!r&&s==="/"))return;t.preventDefault();let{pattern:c,value:i}=this,a=I(n),{short:h,long:g,dir:v,isReversed:l}=e.getState(),p=a.filter(E=>E.isSelected),m=p.filter(E=>!E.value.trim()),w=p.length>1,y=w&&p.length!==m.length,f=!0;for(let E of p)if(!(y&&m.some(A=>A.index===E.index))&&!E.value.startsWith("//")){f=!1;break}let K=h,M=g,b=[];for(let E=0;E<a.length;E++){let A=a[E],{startIndex:T,endIndex:W}=A,C=A.value;if(!A.isSelected){b.push(A.value);continue}let L;w?f?L=A.value.replace(c,""):y&&m.some(Z=>Z.index===A.index)?L=A.value:L=i+A.value:f?L=A.value.replace(c,""):L=i+A.value;let k=L.length-C.length;h>=T&&h<W?k>=0?(K+=k,M+=k):(K+=Math.max(k,T-h),M+=Math.max(k,T-g)):g>=T&&h<W?k>=0?M+=k:M+=Math.max(k,T-g):(K+=k,M+=k),b.push(L)}e.setState({isReversed:l,short:K,long:M,dir:v,value:b.join("")},!1,!0)},se=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:u,shiftKey:r}=S(t);if(!(!u&&!o&&r&&s==="*"))return;let{short:c,long:i,dir:a,isReversed:h}=e.getState();if(c!==i||n.value.charAt(c-1)!=="/")return;t.preventDefault();let l=c+1,p=i+1,m=n.value.substring(0,c)+"**/"+n.value.substring(i);e.setState({isReversed:h,short:l,long:p,dir:a,value:m})},oe=function(t){ne.call(this,t),se.call(this,t)},V=class t extends x{pattern;value;constructor(e){super(e,t.name),this.pattern=t.defaults.pattern,this.value=t.defaults.value}static name="Comment";static defaults={pattern:/^\/\/\s?/,value:"// "};onKeydown=oe};var ie=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:u,shiftKey:r}=S(t);if(!(!u&&!o&&s==="Tab"))return;t.preventDefault();let{pattern:c,value:i}=this,a=I(n),{short:h,long:g,dir:v,isReversed:l}=e.getState(),m=a.filter(M=>M.isSelected).length>1,w=t.shiftKey,y=h,f=g,K=[];for(let M=0;M<a.length;M++){let b=a[M],{startIndex:E,endIndex:A}=b,T=b.value;if(!b.isSelected){K.push(b.value);continue}let C;if(m){let L=!b.value.trim();w?C=b.value.replace(c,""):L?C=b.value:C=i+b.value}else w?C=b.value.replace(c,""):C=i+b.value;let R=C.length-T.length;h>=E&&h<A?R>=0?(y+=R,f+=R):(y+=Math.max(R,E-h),f+=Math.max(R,E-g)):g>=E&&h<A?R>=0?f+=R:f+=Math.max(R,E-g):(y+=R,f+=R),K.push(C)}e.setState({isReversed:l,short:y,long:f,dir:v,value:K.join("")})},G=class t extends x{pattern;value;constructor(e){super(e,t.name),this.pattern=t.defaults.pattern,this.value=t.defaults.value}onKeydown=ie;static name="Indent";static defaults={pattern:/^[^\S\n\r][^\S\n\r]?/,value:"  "}};var q=function(t,e){return Object.keys(t).includes(e)},J=function(t,e){return Object.values(t).includes(e)},N=function(t,e,n){return t[e]&&t[e]===n};var X=function(t,e){return t[e]};var re=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:s,shiftKey:o}=S(t);if(!(!s&&!n&&e==="Enter"))return;t.preventDefault();let r=this.parent,d=this.parent.element,{pairs:c,indentUnit:i}=this,{short:a,long:h,dir:g,isReversed:v}=r.getState(),l=d.value.charAt(a),p=d.value.substring(0,a),m=`
`,w=d.value.substring(h),y=p.split(/\r\n|\r|\n/),f=$(c,i,y),K=a+1;if(J(c,l)){let E=f.substring(0,f.length-i.length);m+=f+`
`+E,K+=f.length}else m+=f,K+=f.length;let M=p+m+w,b=K;r.setState({isReversed:!1,short:K,long:b,value:M},!1,!0)},_=class t extends x{pairs;indentUnit;constructor(e){super(e,t.name),this.pairs=t.defaults.pairs,this.indentUnit=t.defaults.indentUnit}onKeydown=re;static name="AutoIndent";static defaults={pairs:{"(":")","[":"]","{":"}"},indentUnit:"  "}};var ae=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,s=this.pairs,{key:o,altKey:u,ctrlKey:r,shiftKey:d}=S(t);if(!(!r&&!u&&q(s,o)))return;t.preventDefault();let{short:i,long:a,dir:h,isReversed:g}=e.getState(),v=i!==a,l=o,p=X(s,l),m=n.value.substring(0,i),w=n.value.substring(i,a),y=n.value.substring(a),f,K,M;if(v)M=m+l+w+p+y,f=(m+l).length,K=(m+l+w).length;else{let b=(m+l).length;M=m+l+p+y,f=b,K=b}e.setState({isReversed:g,short:f,long:K,dir:h,value:M})},le=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,s=this.pairs,{key:o,altKey:u,ctrlKey:r,shiftKey:d}=S(t);if(!(!r&&!u&&o==="Backspace"))return;let{short:i,long:a}=e.getState();if(i!==a)return;let g=n.value.charAt(i-1),v=n.value.charAt(i);if(!N(s,g,v))return;t.preventDefault();let l=n.value.substring(0,i-1),p=n.value.substring(i+1),m=l+p,w=l.length,y=l.length;e.setState({isReversed:!1,short:w,long:y,dir:"forward",value:m})},ue=function(t){ae.call(this,t),le.call(this,t)},H=class t extends x{pairs;constructor(e){super(e,t.name),this.pairs={...t.defaults.pairs}}onKeydown=ue;static name="AutoPair";static defaults={pairs:{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}}};var de=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:s,shiftKey:o}=S(t);if(!(!s&&!n&&(e.length===1||e==="Backspace")))return;this.kill();let r=this.chunkSize,d=!1,c=!1,i=0,a=m=>{d=!0,c=m||!1};this._stop=a;let h=this.parser.call(this,t),g=h?.body;if(!g){this.query=null,this.candidates=[],this.result=[];return}let v=this.getIndex(g)?.tags||this.tags,l=[];this.query=h,this.candidates=v,this.result=l;let p=()=>{let m=[],w=i+r;for(;i<w&&i<v.length;){let y=v[i];if(c||d)break;this.filter?.call(this,h,y,i,v)&&(m.push(y),l.push(y)),i++}if(!c){if(d||i>=v.length){this.onData?.call(this,m),this.onEnd?.call(this);return}this.onData?.call(this,m),setTimeout(p,0)}};p()},O=class t extends x{tags;indexes;chunkSize;query;candidates;result;parser;filter;onData;onEnd;_stop;constructor(e){super(e,t.name,1),this.tags=[],this.indexes=[],this.chunkSize=t.defaults.chunkSize,this.query=null,this.candidates=[],this.result=[],this.parser=t.defaults.parser,this.filter=t.defaults.filter,this.onData=()=>{},this.onEnd=()=>{},this._stop=()=>{}}onKeyup=de;static name="AutoComplete";static defaults={chunkSize:100,parser:function(e){let n=e.target,s=n.value.split(/[,.․‧・｡。{}()<>[\]\\/|'"`!?]|\r\n|\r|\n/),o=n.selectionStart,u=0,r=0;for(let h of s){if(r=u+h.length,o>=u&&o<=r)break;u=r+1}let d=n.value.substring(0,u),c=n.value.substring(u,r),i=n.value.substring(r),a=c.match(/^(\s*)(.*?)(\s*)$/);return a&&(d=d+(a[1]||""),c=a[2],i=(a[3]||"")+i),{head:d,body:c,tail:i}},filter:function(e,n,s,o){let u=e.body;return n.key.indexOf(u)>-1}};getIndex(e){return this.indexes.find(n=>typeof n.pattern=="string"?n.pattern===e:n.pattern.test(e))}stop(){let e=this._stop;e?.(!1)}kill(){let e=this._stop;e?.(!0)}set(e,n){let s=this.parent;if(n||(n=this.query),!n)throw new Error("Query not found");let o=n.head.length+e.value.length,u=n.head.length+e.value.length,r=n.head+e.value+n.tail;s.setState({short:o,long:u,value:r})}};var ce=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{pairs:s,indentUnit:o}=this,{key:u,altKey:r,ctrlKey:d,shiftKey:c}=S(t);if(!(d&&!r&&u==="Enter"))return;t.preventDefault();let{short:a,long:h,dir:g,isReversed:v}=e.getState(),l=I(n),p=l.filter(T=>T.isSelected),m=t.shiftKey?p[0]:p[p.length-1],w=l[l.length-1].index===p[p.length-1].index,y=[],f=a,K=h;for(let T of l){if(!(m.index===T.index)){y.push(T.value);continue}c?(y.push(`
`+T.value),f=T.startIndex,K=T.startIndex):(y.push(T.value+`
`),f=T.endIndex,K=T.endIndex)}!c&&w&&(f+=1,K+=1);let M=y.join(""),E=M.substring(0,f).split(/\r\n|\r|\n/),A=$(s,o,E);M=M.substring(0,f)+A+M.substring(K),f+=A.length,K+=A.length,e.setState({isReversed:!1,short:f,long:K,value:M})},D=class t extends x{pairs;indentUnit;constructor(e){super(e,t.name),this.pairs=t.defaults.pairs,this.indentUnit=t.defaults.indentUnit}onKeydown=ce;static name="LineBreak";static defaults={pairs:{"(":")","[":"]","{":"}"},indentUnit:"  "}};var he=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:u,shiftKey:r}=S(t);if(!(u&&!o&&r&&s.toLowerCase()==="k"))return;t.preventDefault();let c=I(n),i=c.filter(f=>f.isSelected),a=i[0],h=i[i.length-1],g=[],v=0,l=0,p=0;for(let f of c)f.isSelected||(f.index===a.index-1?(v=f.endIndex,l=f.endIndex):f.index===h.index+1&&(p=f.value.length),g.push(f.value));let m=Math.min(Math.max(0,h.selectionStart,h.selectionEnd-1),Math.max(0,p-1));v+=m,l+=m;let w=g.join("");i.length===1&&i[0].value===""&&c[c.length-1].index===i[0].index&&(w=w.substring(0,w.length-1)),e.setState({isReversed:!1,short:v,long:l,value:w})},j=class t extends x{constructor(e){super(e,t.name)}onKeydown=he;static name="LineRemove";static defaults={}};var fe=!!navigator.clipboard?.writeText,me=async function(t){if(t.defaultPrevented)return;if(!fe){console.warn("navigator.clipboard.writeText not found");return}let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:u,shiftKey:r}=S(t),{short:d,long:c,dir:i,isReversed:a}=e.getState();if(!(!(d!==c)&&u&&!o&&!r&&s.toLowerCase()==="x"))return;t.preventDefault();let v=I(n),l="",p=[],m=d,w=c;for(let y of v)y.isSelected?(m=y.startIndex,w=y.startIndex,l=y.value):p.push(y.value);l&&(l.endsWith(`
`)||(l+=`
`),await navigator.clipboard.writeText(l),e.setState({isReversed:!1,short:m,long:w,value:p.join("")}))},U=class t extends x{constructor(e){super(e,t.name)}onKeydownAsync=me;static name="LineCut";static defaults={}};var pe=!!navigator.clipboard?.writeText,ge=async function(t){if(t.defaultPrevented)return;if(!pe){console.warn("navigator.clipboard.writeText not found");return}let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:u,shiftKey:r}=S(t),{short:d,long:c,dir:i,isReversed:a}=e.getState();if(!(!(d!==c)&&u&&!o&&!r&&s.toLowerCase()==="c"))return;t.preventDefault();let l=I(n).find(p=>p.isSelected)?.value;l&&(l.endsWith(`
`)||(l+=`
`),await navigator.clipboard.writeText(l))},z=class t extends x{constructor(e){super(e,t.name)}onKeydownAsync=ge;static name="LineCopy";static defaults={}};var ve=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{short:s,long:o,dir:u,isReversed:r}=e.getState();if(!!(s!==o))return;let i=t.clipboardData?.getData("text");if(!i)return;i=i.replace(/\r\n|\r/g,`
`);let a=i.split(`
`),h=a.length===2,g=a[a.length-1]==="";if(!h||!g)return;t.preventDefault();let v=I(n),l=[],p=s+i.length,m=o+i.length;for(let w of v)w.isSelected&&l.push(i),l.push(w.value);e.setState({isReversed:r,short:p,long:m,dir:u,value:l.join("")})},Q=class t extends x{constructor(e){super(e,t.name)}onPaste=ve;static name="LinePaste";static defaults={}};var Y=class{element;modules;moduleOrder;_keydownState;_keydownEvent;_keyupEvent;_pasteEvent;_focusEvent;_blurEvent;constructor(e){this.element=e,this.moduleOrder=[],this.modules={},this.modules[P.name]=new P(this),this.modules[V.name]=new V(this),this.modules[G.name]=new G(this),this.modules[D.name]=new D(this),this.modules[j.name]=new j(this),this.modules[U.name]=new U(this),this.modules[z.name]=new z(this),this.modules[Q.name]=new Q(this),this.modules[_.name]=new _(this),this.modules[H.name]=new H(this),this.modules[O.name]=new O(this),this._keydownState=null,this._keydownEvent=async s=>{for(let o of this.moduleOrder)o.onKeydown?.call(o,s),await o.onKeydownAsync?.call(o,s);s.defaultPrevented?this._removeKeydownState():["Meta","Control","Alt","Shift"].includes(s.key)||this._setKeydownState(s)},this._keyupEvent=async s=>{for(let o of this.moduleOrder)o.onKeyup?.call(o,s),await o.onKeyupAsync?.call(o,s)},this._pasteEvent=async s=>{for(let o of this.moduleOrder)o.onPaste?.call(o,s),await o.onPasteAsync?.call(o,s)};let n=s=>{this.addHistory(!1)};this._focusEvent=s=>{setTimeout(()=>{this.addHistory(!1),this.element.addEventListener("pointerup",n,!0)},0)},this._blurEvent=s=>{this.element.removeEventListener("pointerup",n,!0)},this.setEvents(),this.setModuleOrder()}setEvents(){this.element.addEventListener("keydown",this._keydownEvent,!0),this.element.addEventListener("keyup",this._keyupEvent,!0),this.element.addEventListener("paste",this._pasteEvent,!0),this.element.addEventListener("focus",this._focusEvent,!0),this.element.addEventListener("blur",this._blurEvent,!0)}removeEvents(){this.element.removeEventListener("keydown",this._keydownEvent),this.element.removeEventListener("keyup",this._keyupEvent),this.element.removeEventListener("paste",this._pasteEvent),this.element.removeEventListener("focus",this._focusEvent),this.element.removeEventListener("blur",this._blurEvent)}setModuleOrder(){this.moduleOrder=Object.values(this.modules).sort((e,n)=>e.index-n.index)}getModule(e){return this.modules[e]}setModule(e){this.modules[e.name]=e,this.setModuleOrder()}removeModule(e){this.modules[e]&&(delete this.modules[e],this.setModuleOrder())}getState(e){return B(this.element,e)}setState(e,n=!0,s=!0){n&&this.addHistory(),F(this.element,e),s&&this.addHistory()}addHistory(e=!0){this.getModule(P.name)?.add(e)}removeHistory(){this.getModule(P.name)?.remove()}_setKeydownState(e){this._keydownState={value:this.element.value,state:B(this.element),key:e.key}}_removeKeydownState(){this._keydownState=null}};export{O as AutoCompleteModule,_ as AutoIndentModule,H as AutoPairModule,V as CommentModule,P as HistoryModule,G as IndentModule,D as LineBreakModule,z as LineCopyModule,U as LineCutModule,Q as LinePasteModule,j as LineRemoveModule,Y as MTGA,x as MTGAModule};
