var T=function(e,t){let n=e.selectionStart>e.selectionEnd,i=Math.min(e.selectionStart,e.selectionEnd),o=Math.max(e.selectionStart,e.selectionEnd),a=e.selectionDirection;return t?{isReversed:n,short:i,long:o,dir:a,value:e.value}:{isReversed:n,short:i,long:o,dir:a}},v=function(e,t){t.value&&(e.value=t.value),t.isReversed?e.setSelectionRange(t.long,t.short,t.dir||"none"):e.setSelectionRange(t.short,t.long,t.dir||"none"),e.focus()},S=function(e){let t=e.key,n=e.altKey,i=e.shiftKey,o=e.ctrlKey||e.metaKey;return{key:t,altKey:n,shiftKey:i,ctrlKey:o}};function V(e,t){let n=Array.from({length:e.length+1},()=>Array(t.length+1).fill(0));for(let f=1;f<=e.length;f++)for(let u=1;u<=t.length;u++)e[f-1]===t[u-1]?n[f][u]=n[f-1][u-1]+1:n[f][u]=Math.max(n[f-1][u],n[f][u-1]);let i=[],o=0,a=e.length,s=t.length,r=null,c=[],h=function(){r!==null&&c.length>0&&i.push([r,c.reverse().join("")]),r=null,c=[]};for(;a>0||s>0;){let f=e[a-1],u=t[s-1];a>0&&s>0&&f===u?(r!==0&&h(),r=0,c.push(f),o++,a--,s--):s>0&&(a===0||n[a][s-1]>=n[a-1][s])?(r!==1&&h(),r=1,c.push(u),s--):a>0&&(r!==-1&&h(),r=-1,c.push(f),a--)}return h(),{accuracy:o*2/(e.length+t.length),score:o,match:i.reverse()}}var R=function(e){let{short:t,long:n}=T(e),i=e.value.split(/\n/),o=[],a=[],s=0;for(let r=0;r<i.length;r++){let c=i[r],f=r===i.length-1?c:c+`
`,u=s,y=s+c.length+1,d=-1,l=-1,m="";t>=u&&t<y&&(d=t-u),n>u&&n<y&&(l=n-u),t<=u&&n>=y&&(d=0,l=f.length),d>-1&&l===-1&&(l=f.length),l>-1&&d===-1&&(d=0);let g=d>-1&&l>-1;g&&(m=f.substring(d,l));let x={rowIndex:r,startIndex:u,endIndex:y,value:f,selectionStart:d,selectionEnd:l,selectionValue:m};o.push(x),g&&a.push(x),s=y}return{rows:o,selectedRows:a}},C=function(e,t,n){let{short:i,long:o,dir:a,isReversed:s}=T(e),r=i,c=o,h=[];for(let f of t){let{startIndex:u,endIndex:y}=f,d=f.value,l=n(f),m=l.length-d.length;i>=u&&i<y?m>=0?(r+=m,c+=m):(r+=Math.max(m,u-i),c+=Math.max(m,u-o)):o>=u&&i<y?m>=0?c+=m:c+=Math.max(m,u-o):c+=m,h.push(l)}return{isReversed:s,short:r,long:c,dir:a,value:h.join("")}};var _=function(e,t){return Object.keys(e).includes(t)};var G=function(e,t){return e[t]},H=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:i,shiftKey:o}=S(e),a=this.element,s=this.pairify.pairs;if(!(!i&&!n&&_(s,t)))return;e.preventDefault();let{short:c,long:h,dir:f,isReversed:u}=T(a),y=c!==h,d=t,l=G(s,d),m=a.value.substring(0,c),g=a.value.substring(c,h),x=a.value.substring(h),p,K,I;if(y)I=m+d+g+l+x,p=(m+d).length,K=(m+d+g).length;else{let b=(m+d).length;I=m+d+l+x,p=b,K=b}v(a,{isReversed:u,short:p,long:K,dir:f,value:I}),this.history.add()},L=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:i,shiftKey:o}=S(e);if(!(!i&&!n&&!o&&t==="Backspace"))return;let s=this.element,r=this.pairify.pairs,{short:c,long:h,dir:f,isReversed:u}=T(s);if(c!==h)return;let d=s.value.charAt(h-1),l=G(r,d);if(!(_(r,d)&&G(r,d)===l))return;e.preventDefault();let g=s.value.substring(0,h-1),x=s.value.substring(h+1),p=g+x,K=g.length,I=g.length;v(s,{isReversed:!1,short:K,long:I,dir:"forward",value:p}),this.history.add()},w=class e{parent;pairs;constructor(t){this.parent=t,this.pairs={...e.defaults.pairs},t.modules.push({name:"ClosePair",onKeydown:H},{name:"ClearPair",onKeydown:L})}static defaults={pairs:{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}}};var j=function(e){for(let t of e)if(t.value.startsWith("//"))return!0;return!1},q=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:i,shiftKey:o}=S(e);if(!(i&&!n&&!o&&t==="/"))return;e.preventDefault();let s=this.element,{pattern:r,value:c}=this.commentify,{rows:h,selectedRows:f}=R(s),u=f.length>1,y=j(f),d=C(s,h,l=>{if(!(l.selectionStart>-1||l.selectionEnd>-1))return l.value;if(u){let g=!l.value.trim();return y?l.value.replace(r,""):g?l.value:c+l.value}else return y?l.value.replace(r,""):c+l.value});v(s,d),this.history.add()},k=class e{parent;pattern;value;constructor(t){this.parent=t,this.pattern=e.defaults.pattern,this.value=e.defaults.value,t.modules.push({name:"Commentify",onKeydown:q})}static defaults={pattern:/^\/\/\s?/,value:"// "}};var D=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:i,shiftKey:o}=S(e);if(!(!i&&!n&&t==="Tab"))return;e.preventDefault();let s=this.element,{pattern:r,value:c}=this.indentify,{rows:h,selectedRows:f}=R(s),u=f.length>1,y=e.shiftKey,d=C(s,h,l=>{if(!(l.selectionStart>-1||l.selectionEnd>-1))return l.value;if(u){let g=!l.value.trim();return y?l.value.replace(r,""):g?l.value:c+l.value}else return y?l.value.replace(r,""):c+l.value});v(s,d),this.history.add()},E=class e{parent;pattern;value;constructor(t){this.parent=t,this.pattern=e.defaults.pattern,this.value=e.defaults.value,t.modules.push({name:"Indentify",onKeydown:D})}static defaults={pattern:/^[^\S\n\r][^\S\n\r]?/,value:"  "}};var z=function(e,t){for(let n of e)if(n.pattern.test(t))return n},O=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:i,shiftKey:o}=S(e);if(!(!i&&(t.length===1||t==="Backspace")))return;let s=this.tagify;s.stop(!0);let r=s._requestId+1,c=s._chunkSize,h=[],f=!1,u=!1,y=0,d=p=>{f=!0,u=p||!1};s._requestId=r,s._stop=d;let l=s.parser.call(this,this.element),m=l.body,g=[];if(m){let p=z(s.indexes,m);p?g=p.tags:g=s.tags}let x=()=>{let p=[],K=y+c;for(;y<K&&y<g.length;){let b={tag:g[y],query:l};s.filter?.call(this,b,y,g,h)&&(p.push(b),h.push(b)),y++}if(!(u||s._requestId!==r)){if(f||y>=g.length){s.onData?.call(this,p,h),s.onEnd?.call(this,h);return}s.onData?.call(this,p,h),setTimeout(x,0)}};x()},M=class e{parent;tags;indexes;parser;filter;onData;onEnd;_requestId;_chunkSize;_stop;constructor(t){this.parent=t,this.tags=[],this.indexes=[],this.parser=e.defaults.parser,this.filter=e.defaults.filter,this.onData=()=>{},this.onEnd=()=>{},this._requestId=0,this._chunkSize=e.defaults.chunkSize,this._stop=()=>{},t.modules.push({name:"Tagify",onKeyup:O})}static defaults={chunkSize:100,parser:t=>{let n=t.value.split(/[,.․‧・｡。{}()<>[\]\\/|'"`!?]|\r\n|\r|\n/),i=t.selectionStart,o=0,a=0;for(let h of n){if(a=o+h.length,i>=o&&i<=a)break;o=a+1}let s=t.value.substring(0,o),r=t.value.substring(o,a).trim(),c=t.value.substring(a);return{head:s,body:r,tail:c}},filter:()=>!0};compare(t,n){return V(t,n)}stop(t){let n=this._stop;n?.(t)}set(t){let n=t.query.head.length+t.tag.value.length,i=t.query.head.length+t.tag.value.length,o=t.query.head+t.tag.value+t.query.tail,a={short:n,long:i,value:o};v(this.parent.element,a)}};var Q=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:i,shiftKey:o}=S(e);if(!(i&&!n&&!o&&t.toLowerCase()==="z"))return;e.preventDefault();let s=this.element,r=this.history.prev();r&&v(s,r)},B=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:i,shiftKey:o}=S(e);if(!(i&&!n&&o&&t.toLowerCase()==="z"))return;e.preventDefault();let s=this.element,r=this.history.next();r&&v(s,r)},U=function(e){let t=this._keydownState;if(this._clearKeydownState(),!t)return;let n=this.element;if(t.value!==n.value)this.history.add();else{let o=t.state,a=T(n);(o.short!==a.short||o.long!==a.long)&&this.history.add(!1)}},A=class e{parent;items;index;maxCount;constructor(t){this.parent=t,this.items=[],this.index=1,this.maxCount=e.defaults.maxCount,t.modules.push({name:"Undo",onKeydown:Q},{name:"Redo",onKeydown:B},{name:"History",onKeyup:U})}static defaults={maxCount:390};prune(){this.index>1&&(this.items=this.items.slice(0,this.items.length-(this.index-1)),this.index=1)}add(t=!0){let n=this.parent.element;if(t)this.prune();else if(this.index!==1)return;let i=T(n,!0);this.items.push(i),this.items.length>this.maxCount&&this.items.shift()}prev(){return this.index<this.items.length&&(this.index+=1),this.curr()}next(){return this.index>1&&(this.index-=1),this.curr()}curr(){return this.items[this.items.length-this.index]}};var P=class{element;modules;_keydownState;_keydownEvent;_keyupEvent;_mouseupEvent;constructor(t){this.element=t,this.modules=[],this.history=new A(this),this.commentify=new k(this),this.indentify=new E(this),this.pairify=new w(this),this.tagify=new M(this),this._keydownState=null,this._keydownEvent=n=>{for(let i of this.modules)if(i.onKeydown?.call(this,n),n.defaultPrevented){this._clearKeydownState();return}["Meta","Control","Alt","Shift"].includes(n.key)||this._setKeydownState(n)},this._keyupEvent=n=>{let i=this.element;for(let s of this.modules)if(s.onKeyup?.call(this,n),n.defaultPrevented)break;let o=this._keydownState;if(this._clearKeydownState(),!o)return;if(o.value!==i.value)this.history.add();else{let s=o.state,r=T(i);(s.short!==r.short||s.long!==r.long)&&this.history.add(!1)}},this._mouseupEvent=n=>{this.history.add(!1)},this.element.addEventListener("keydown",this._keydownEvent,!0),this.element.addEventListener("keyup",this._keyupEvent,!0),this.element.addEventListener("mouseup",this._mouseupEvent,!0)}getState(t){return T(this.element,t)}setState(t){v(this.element,t)}_clearKeydownState(){this._keydownState=null}_setKeydownState(t){this._keydownState={value:this.element.value,state:T(this.element),key:t.key}}};export{k as Commentify,A as History,E as Indentify,P as MTGA,w as Pairify,M as Tagify};
