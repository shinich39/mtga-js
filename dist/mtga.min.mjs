var B=function(t,e){let n=t.selectionStart>t.selectionEnd,s=Math.min(t.selectionStart,t.selectionEnd),o=Math.max(t.selectionStart,t.selectionEnd),u=t.selectionDirection;return e?{isReversed:n,short:s,long:o,dir:u,value:t.value}:{isReversed:n,short:s,long:o,dir:u}},F=function(t,e){typeof e.value=="string"&&(t.value=e.value),e.isReversed?t.setSelectionRange(e.long,e.short,e.dir):t.setSelectionRange(e.short,e.long,e.dir),t.focus()};var S=class{parent;name;index;onKeydown;onKeydownAsync;onKeyup;onKeyupAsync;onPaste;onPasteAsync;constructor(e,n,s=9999){this.parent=e,this.name=n,this.index=s}static defaults={}};var M=function(t){let e=t.key,n=t.altKey,s=t.shiftKey,o=t.ctrlKey||t.metaKey;return{key:e,altKey:n,shiftKey:s,ctrlKey:o}};function $(t,e){let n=Array.from({length:t.length+1},()=>Array(e.length+1).fill(0));for(let r=1;r<=t.length;r++)for(let l=1;l<=e.length;l++)t[r-1]===e[l-1]?n[r][l]=n[r-1][l-1]+1:n[r][l]=Math.max(n[r-1][l],n[r][l-1]);let s=[],o=0,u=t.length,a=e.length,c=null,d=[],i=function(){c!==null&&d.length>0&&s.push([c,d.reverse().join("")]),c=null,d=[]};for(;u>0||a>0;){let r=t[u-1],l=e[a-1];u>0&&a>0&&r===l?(c!==0&&i(),c=0,d.push(r),o++,u--,a--):a>0&&(u===0||n[u][a-1]>=n[u-1][a])?(c!==1&&i(),c=1,d.push(l),a--):u>0&&(c!==-1&&i(),c=-1,d.push(r),u--)}return i(),{accuracy:o*2/(t.length+e.length),score:o,match:s.reverse()}}function W(t,e,n){let s=function(a,c){return a.repeat(Math.ceil(c/a.length)).slice(0,c)},o=Object.keys(t).join(""),u=Object.values(t).join("");for(let a=n.length-1;a>=0;a--){let c=n[a];for(let d=c.length-1;d>=0;d--){let i=c[d];if(u.includes(i)){let r=c.match(/^\s*/)?.[0].length||0;return s(e,r)}if(o.includes(i)){let r=(c.match(/^\s*/)?.[0].length||0)+e.length;return s(e,r)}}}return""}var te=function(t){if(t.defaultPrevented)return;let e=this.parent,{key:n,altKey:s,ctrlKey:o,shiftKey:u}=M(t);if(!(o&&!s&&n.toLowerCase()==="z"))return;t.preventDefault();let c;u?c=this.next():c=this.prev(),c&&e.setState(c,!1,!1)},ne=function(t){let e=this.parent,n=e._keydownState;if(e._removeKeydownState(),!n)return;let s=e.element,o=n.value,u=s.value;if(o!==u)e.addHistory();else{let a=n.state,c=e.getState();(a.short!==c.short||a.long!==c.long)&&e.addHistory(!1)}},P=class t extends S{items;maxCount;_i;constructor(e){super(e,t.name,0),this.items=[],this.maxCount=t.defaults.maxCount,this._i=1}static name="History";static defaults={maxCount:390};onKeydown=te;onKeyup=ne;prune(){this._i>1&&(this.items=this.items.slice(0,this.items.length-(this._i-1)),this._i=1)}add(e=!0){let n=this.parent;if(e)this.prune();else if(this._i!==1)return;let s=this.items[this.items.length-1],o=n.getState(!0);(!s||s.short!==o.short||s.long!==o.long||s.value!==o.value)&&(this.items.push(o),this.items.length>this.maxCount&&this.items.shift())}remove(){this.items.pop()}prev(){return this._i<this.items.length&&(this._i+=1),this.curr()}next(){return this._i>1&&(this._i-=1),this.curr()}curr(){return this.items[this.items.length-this._i]}};var T=function(t){let{short:e,long:n}=B(t),s=t.value.split(/\n/),o=[],u=0;for(let a=0;a<s.length;a++){let c=s[a],d=a===s.length-1,i=d?c:c+`
`,r=u,l=r+i.length,v=-1,y=-1,h="";e>=r&&e<l&&(v=e-r),n>r&&(d?n<=l:n<l)&&(y=n-r),e<=r&&n>=l&&(v=0,y=i.length),v>-1&&y===-1&&(y=i.length),y>-1&&v===-1&&(v=0);let p={isSelected:v>-1&&y>-1,index:a,startIndex:r,endIndex:l,value:i,selectionStart:v,selectionEnd:y};o.push(p),u=l}return o};var se=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:u,shiftKey:a}=M(t);if(!(u&&!o&&!a&&s==="/"))return;t.preventDefault();let{pattern:d,value:i}=this,r=T(n),{short:l,long:v,dir:y,isReversed:h}=e.getState(),m=r.filter(E=>E.isSelected),p=m.filter(E=>!E.value.trim()),g=m.length>1,w=g&&m.length!==p.length,f=!0;for(let E of m)if(!(w&&p.some(A=>A.index===E.index))&&!E.value.startsWith("//")){f=!1;break}let x=l,K=v,b=[];for(let E=0;E<r.length;E++){let A=r[E],{startIndex:I,endIndex:Q}=A,R=A.value;if(!A.isSelected){b.push(A.value);continue}let L;g?f?L=A.value.replace(d,""):w&&p.some(ee=>ee.index===A.index)?L=A.value:L=i+A.value:f?L=A.value.replace(d,""):L=i+A.value;let k=L.length-R.length;l>=I&&l<Q?k>=0?(x+=k,K+=k):(x+=Math.max(k,I-l),K+=Math.max(k,I-v)):v>=I&&l<Q?k>=0?K+=k:K+=Math.max(k,I-v):(x+=k,K+=k),b.push(L)}e.setState({isReversed:h,short:x,long:K,dir:y,value:b.join("")},!1,!0)},oe=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:u,shiftKey:a}=M(t);if(!(!u&&!o&&a&&s==="*"))return;let{short:d,long:i,dir:r,isReversed:l}=e.getState();if(d!==i||n.value.charAt(d-1)!=="/")return;t.preventDefault();let h=d+1,m=i+1,p=n.value.substring(0,d)+"**/"+n.value.substring(i);e.setState({isReversed:l,short:h,long:m,dir:r,value:p})},re=function(t){se.call(this,t),oe.call(this,t)},V=class t extends S{pattern;value;constructor(e){super(e,t.name),this.pattern=t.defaults.pattern,this.value=t.defaults.value}static name="Comment";static defaults={pattern:/^\/\/\s?/,value:"// "};onKeydown=re};var ie=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:u,shiftKey:a}=M(t);if(!(!u&&!o&&s==="Tab"))return;t.preventDefault();let{pattern:d,value:i}=this,r=T(n),{short:l,long:v,dir:y,isReversed:h}=e.getState(),p=r.filter(K=>K.isSelected).length>1,g=t.shiftKey,w=l,f=v,x=[];for(let K=0;K<r.length;K++){let b=r[K],{startIndex:E,endIndex:A}=b,I=b.value;if(!b.isSelected){x.push(b.value);continue}let R;if(p){let L=!b.value.trim();g?R=b.value.replace(d,""):L?R=b.value:R=i+b.value}else g?R=b.value.replace(d,""):R=i+b.value;let C=R.length-I.length;l>=E&&l<A?C>=0?(w+=C,f+=C):(w+=Math.max(C,E-l),f+=Math.max(C,E-v)):v>=E&&l<A?C>=0?f+=C:f+=Math.max(C,E-v):(w+=C,f+=C),x.push(R)}e.setState({isReversed:h,short:w,long:f,dir:y,value:x.join("")})},G=class t extends S{pattern;value;constructor(e){super(e,t.name),this.pattern=t.defaults.pattern,this.value=t.defaults.value}onKeydown=ie;static name="Indent";static defaults={pattern:/^[^\S\n\r][^\S\n\r]?/,value:"  "}};var J=function(t,e){return Object.keys(t).includes(e)},N=function(t,e){return Object.values(t).includes(e)},X=function(t,e,n){return t[e]&&t[e]===n};var Y=function(t,e){return t[e]};var ae=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:s,shiftKey:o}=M(t);if(!(!s&&!n&&e==="Enter"))return;t.preventDefault();let a=this.parent,c=this.parent.element,{pairs:d,indentUnit:i}=this,{short:r,long:l,dir:v,isReversed:y}=a.getState(),h=c.value.charAt(r),m=c.value.substring(0,r),p=`
`,g=c.value.substring(l),w=m.split(/\r\n|\r|\n/),f=W(d,i,w),x=r+1;if(N(d,h)){let E=f.substring(0,f.length-i.length);p+=f+`
`+E,x+=f.length}else p+=f,x+=f.length;let K=m+p+g,b=x;a.setState({isReversed:!1,short:x,long:b,value:K},!1,!0)},_=class t extends S{pairs;indentUnit;constructor(e){super(e,t.name),this.pairs=t.defaults.pairs,this.indentUnit=t.defaults.indentUnit}onKeydown=ae;static name="AutoIndent";static defaults={pairs:{"(":")","[":"]","{":"}"},indentUnit:"  "}};var le=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,s=this.pairs,{key:o,altKey:u,ctrlKey:a,shiftKey:c}=M(t);if(!(!a&&!u&&J(s,o)))return;t.preventDefault();let{short:i,long:r,dir:l,isReversed:v}=e.getState(),y=i!==r,h=o,m=Y(s,h),p=n.value.substring(0,i),g=n.value.substring(i,r),w=n.value.substring(r),f,x,K;if(y)K=p+h+g+m+w,f=(p+h).length,x=(p+h+g).length;else{let b=(p+h).length;K=p+h+m+w,f=b,x=b}e.setState({isReversed:v,short:f,long:x,dir:l,value:K})},ue=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,s=this.pairs,{key:o,altKey:u,ctrlKey:a,shiftKey:c}=M(t);if(!(!a&&!u&&o==="Backspace"))return;let{short:i,long:r}=e.getState();if(i!==r)return;let v=n.value.charAt(i-1),y=n.value.charAt(i);if(!X(s,v,y))return;t.preventDefault();let h=n.value.substring(0,i-1),m=n.value.substring(i+1),p=h+m,g=h.length,w=h.length;e.setState({isReversed:!1,short:g,long:w,dir:"forward",value:p})},ce=function(t){le.call(this,t),ue.call(this,t)},H=class t extends S{pairs;constructor(e){super(e,t.name),this.pairs={...t.defaults.pairs}}onKeydown=ce;static name="AutoPair";static defaults={pairs:{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}}};var de=function(t,e){for(let n of t)if(n.pattern.test(e))return n},he=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:s,shiftKey:o}=M(t);if(!(!s&&!n&&(e.length===1||e==="Backspace")))return;this.stop(!0);let a=this._requestId+1,c=this._chunkSize,d=[],i=!1,r=!1,l=0,v=g=>{i=!0,r=g||!1};this._requestId=a,this._stop=v;let y=this.parser.call(this,t),h=y.body,m=[];if(h){let g=de(this.indexes,h);g?m=g.tags:m=this.tags}let p=()=>{let g=[],w=l+c;for(;l<w&&l<m.length;){let x={tag:m[l],query:y};this.filter?.call(this,x,d,l,m)&&(g.push(x),d.push(x)),l++}if(!(r||this._requestId!==a)){if(i||l>=m.length){this.onData?.call(this,g,d),this.onEnd?.call(this,d);return}this.onData?.call(this,g,d),setTimeout(p,0)}};p()},O=class t extends S{tags;indexes;parser;filter;onData;onEnd;_requestId;_chunkSize;_stop;constructor(e){super(e,t.name,1),this.tags=[],this.indexes=[],this.parser=t.defaults.parser,this.filter=t.defaults.filter,this.onData=()=>{},this.onEnd=()=>{},this._requestId=0,this._chunkSize=t.defaults.chunkSize,this._stop=()=>{}}onKeyup=he;static name="AutoComplete";static defaults={chunkSize:100,parser:function(e){let n=e.target,s=n.value.split(/[,.․‧・｡。{}()<>[\]\\/|'"`!?]|\r\n|\r|\n/),o=n.selectionStart,u=0,a=0;for(let l of s){if(a=u+l.length,o>=u&&o<=a)break;u=a+1}let c=n.value.substring(0,u),d=n.value.substring(u,a),i=n.value.substring(a),r=d.match(/^(\s*)(.*?)(\s*)$/);return r&&(c=c+(r[1]||""),d=r[2],i=(r[3]||"")+i),{head:c,body:d,tail:i}},filter:function(e,n,s,o){let{tag:u,query:a}=e,c=a.body;return u.key.indexOf(c)>-1}};compare(e,n){return $(e,n)}stop(e){let n=this._stop;n?.(e)}set(e){let n=e.query.head.length+e.tag.value.length,s=e.query.head.length+e.tag.value.length,o=e.query.head+e.tag.value+e.query.tail,u={short:n,long:s,value:o};this.parent.setState(u)}};var fe=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{pairs:s,indentUnit:o}=this,{key:u,altKey:a,ctrlKey:c,shiftKey:d}=M(t);if(!(c&&!a&&u==="Enter"))return;t.preventDefault();let{short:r,long:l,dir:v,isReversed:y}=e.getState(),h=T(n),m=h.filter(I=>I.isSelected),p=t.shiftKey?m[0]:m[m.length-1],g=h[h.length-1].index===m[m.length-1].index,w=[],f=r,x=l;for(let I of h){if(!(p.index===I.index)){w.push(I.value);continue}d?(w.push(`
`+I.value),f=I.startIndex,x=I.startIndex):(w.push(I.value+`
`),f=I.endIndex,x=I.endIndex)}!d&&g&&(f+=1,x+=1);let K=w.join(""),E=K.substring(0,f).split(/\r\n|\r|\n/),A=W(s,o,E);K=K.substring(0,f)+A+K.substring(x),f+=A.length,x+=A.length,e.setState({isReversed:!1,short:f,long:x,value:K})},D=class t extends S{pairs;indentUnit;constructor(e){super(e,t.name),this.pairs=t.defaults.pairs,this.indentUnit=t.defaults.indentUnit}onKeydown=fe;static name="LineBreak";static defaults={pairs:{"(":")","[":"]","{":"}"},indentUnit:"  "}};var me=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:u,shiftKey:a}=M(t);if(!(u&&!o&&a&&s.toLowerCase()==="k"))return;t.preventDefault();let d=T(n),i=d.filter(f=>f.isSelected),r=i[0],l=i[i.length-1],v=[],y=0,h=0,m=0;for(let f of d)f.isSelected||(f.index===r.index-1?(y=f.endIndex,h=f.endIndex):f.index===l.index+1&&(m=f.value.length),v.push(f.value));let p=Math.min(Math.max(0,l.selectionStart,l.selectionEnd-1),Math.max(0,m-1));y+=p,h+=p;let g=v.join("");i.length===1&&i[0].value===""&&d[d.length-1].index===i[0].index&&(g=g.substring(0,g.length-1)),e.setState({isReversed:!1,short:y,long:h,value:g})},j=class t extends S{constructor(e){super(e,t.name)}onKeydown=me;static name="LineRemove";static defaults={}};var pe=!!navigator.clipboard?.writeText,ge=async function(t){if(t.defaultPrevented)return;if(!pe){console.warn("navigator.clipboard.writeText not found");return}let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:u,shiftKey:a}=M(t),{short:c,long:d,dir:i,isReversed:r}=e.getState();if(!(!(c!==d)&&u&&!o&&!a&&s.toLowerCase()==="x"))return;t.preventDefault();let y=T(n),h="",m=[],p=c,g=d;for(let w of y)w.isSelected?(p=w.startIndex,g=w.startIndex,h=w.value):m.push(w.value);h&&(h.endsWith(`
`)||(h+=`
`),await navigator.clipboard.writeText(h),e.setState({isReversed:!1,short:p,long:g,value:m.join("")}))},q=class t extends S{constructor(e){super(e,t.name)}onKeydownAsync=ge;static name="LineCut";static defaults={}};var ve=!!navigator.clipboard?.writeText,ye=async function(t){if(t.defaultPrevented)return;if(!ve){console.warn("navigator.clipboard.writeText not found");return}let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:u,shiftKey:a}=M(t),{short:c,long:d,dir:i,isReversed:r}=e.getState();if(!(!(c!==d)&&u&&!o&&!a&&s.toLowerCase()==="c"))return;t.preventDefault();let h=T(n).find(m=>m.isSelected)?.value;h&&(h.endsWith(`
`)||(h+=`
`),await navigator.clipboard.writeText(h))},U=class t extends S{constructor(e){super(e,t.name)}onKeydownAsync=ye;static name="LineCopy";static defaults={}};var we=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{short:s,long:o,dir:u,isReversed:a}=e.getState();if(!!(s!==o))return;let i=t.clipboardData?.getData("text");if(!i)return;i=i.replace(/\r\n|\r/g,`
`);let r=i.split(`
`),l=r.length===2,v=r[r.length-1]==="";if(!l||!v)return;t.preventDefault();let y=T(n),h=[],m=s+i.length,p=o+i.length;for(let g of y)g.isSelected&&h.push(i),h.push(g.value);e.setState({isReversed:a,short:m,long:p,dir:u,value:h.join("")})},z=class t extends S{constructor(e){super(e,t.name)}onPaste=we;static name="LinePaste";static defaults={}};var Z=class{element;modules;moduleOrder;_keydownState;_keydownEvent;_keyupEvent;_pasteEvent;_focusEvent;_blurEvent;constructor(e){this.element=e,this.moduleOrder=[],this.modules={},this.modules[P.name]=new P(this),this.modules[V.name]=new V(this),this.modules[G.name]=new G(this),this.modules[D.name]=new D(this),this.modules[j.name]=new j(this),this.modules[q.name]=new q(this),this.modules[U.name]=new U(this),this.modules[z.name]=new z(this),this.modules[_.name]=new _(this),this.modules[H.name]=new H(this),this.modules[O.name]=new O(this),this._keydownState=null,this._keydownEvent=async s=>{for(let o of this.moduleOrder)o.onKeydown?.call(o,s),await o.onKeydownAsync?.call(o,s);s.defaultPrevented?this._removeKeydownState():["Meta","Control","Alt","Shift"].includes(s.key)||this._setKeydownState(s)},this._keyupEvent=async s=>{for(let o of this.moduleOrder)o.onKeyup?.call(o,s),await o.onKeyupAsync?.call(o,s)},this._pasteEvent=async s=>{for(let o of this.moduleOrder)o.onPaste?.call(o,s),await o.onPasteAsync?.call(o,s)};let n=s=>{this.addHistory(!1)};this._focusEvent=s=>{setTimeout(()=>{this.addHistory(!1),this.element.addEventListener("pointerup",n,!0)},0)},this._blurEvent=s=>{this.element.removeEventListener("pointerup",n,!0)},this.setEvents(),this.setModuleOrder()}setEvents(){this.element.addEventListener("keydown",this._keydownEvent,!0),this.element.addEventListener("keyup",this._keyupEvent,!0),this.element.addEventListener("paste",this._pasteEvent,!0),this.element.addEventListener("focus",this._focusEvent,!0),this.element.addEventListener("blur",this._blurEvent,!0)}removeEvents(){this.element.removeEventListener("keydown",this._keydownEvent),this.element.removeEventListener("keyup",this._keyupEvent),this.element.removeEventListener("paste",this._pasteEvent),this.element.removeEventListener("focus",this._focusEvent),this.element.removeEventListener("blur",this._blurEvent)}setModuleOrder(){this.moduleOrder=Object.values(this.modules).sort((e,n)=>e.index-n.index)}getModule(e){return this.modules[e]}setModule(e){this.modules[e.name]=e,this.setModuleOrder()}removeModule(e){this.modules[e]&&(delete this.modules[e],this.setModuleOrder())}getState(e){return B(this.element,e)}setState(e,n=!0,s=!0){n&&this.addHistory(),F(this.element,e),s&&this.addHistory()}addHistory(e=!0){this.getModule(P.name)?.add(e)}removeHistory(){this.getModule(P.name)?.remove()}_setKeydownState(e){this._keydownState={value:this.element.value,state:B(this.element),key:e.key}}_removeKeydownState(){this._keydownState=null}};export{O as AutoCompleteModule,_ as AutoIndentModule,H as AutoPairModule,V as CommentModule,P as HistoryModule,G as IndentModule,D as LineBreakModule,U as LineCopyModule,q as LineCutModule,z as LinePasteModule,j as LineRemoveModule,Z as MTGA,S as MTGAModule};
