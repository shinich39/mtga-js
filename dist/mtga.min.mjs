var B=function(t,e){let n=t.selectionStart>t.selectionEnd,s=Math.min(t.selectionStart,t.selectionEnd),o=Math.max(t.selectionStart,t.selectionEnd),a=t.selectionDirection;return e?{isReversed:n,short:s,long:o,dir:a,value:t.value}:{isReversed:n,short:s,long:o,dir:a}},W=function(t,e){typeof e.value=="string"&&(t.value=e.value),e.isReversed?t.setSelectionRange(e.long,e.short,e.dir):t.setSelectionRange(e.short,e.long,e.dir),t.focus()};var x=class{parent;name;index;onKeydown;onKeydownAsync;onKeyup;onKeyupAsync;onPaste;onPasteAsync;constructor(e,n,s=9999){this.parent=e,this.name=n,this.index=s}static defaults={}};var S=function(t){let e=t.key,n=t.altKey,s=t.shiftKey,o=t.ctrlKey||t.metaKey;return{key:e,altKey:n,shiftKey:s,ctrlKey:o}};function F(t,e){let n=Array.from({length:t.length+1},()=>Array(e.length+1).fill(0));for(let i=1;i<=t.length;i++)for(let h=1;h<=e.length;h++)t[i-1]===e[h-1]?n[i][h]=n[i-1][h-1]+1:n[i][h]=Math.max(n[i-1][h],n[i][h-1]);let s=[],o=0,a=t.length,l=e.length,d=null,c=[],r=function(){d!==null&&c.length>0&&s.push([d,c.reverse().join("")]),d=null,c=[]};for(;a>0||l>0;){let i=t[a-1],h=e[l-1];a>0&&l>0&&i===h?(d!==0&&r(),d=0,c.push(i),o++,a--,l--):l>0&&(a===0||n[a][l-1]>=n[a-1][l])?(d!==1&&r(),d=1,c.push(h),l--):a>0&&(d!==-1&&r(),d=-1,c.push(i),a--)}return r(),{accuracy:o*2/(t.length+e.length),score:o,match:s.reverse()}}var te=function(t){if(t.defaultPrevented)return;let e=this.parent,{key:n,altKey:s,ctrlKey:o,shiftKey:a}=S(t);if(!(o&&!s&&n.toLowerCase()==="z"))return;t.preventDefault();let d;a?d=this.next():d=this.prev(),d&&e.setState(d)},ne=function(t){let e=this.parent,n=e._keydownState;if(e._clearKeydownState(),!n)return;let s=e.element,o=n.value,a=s.value;if(o!==a)e.addHistory();else{let l=n.state,d=e.getState();(l.short!==d.short||l.long!==d.long)&&e.addHistory(!1)}},P=class t extends x{items;maxCount;_i;constructor(e){super(e,t.name,0),this.items=[],this.maxCount=t.defaults.maxCount,this._i=1}static name="History";static defaults={maxCount:390};onKeydown=te;onKeyup=ne;prune(){this._i>1&&(this.items=this.items.slice(0,this.items.length-(this._i-1)),this._i=1)}add(e=!0){let n=this.parent;if(e)this.prune();else if(this._i!==1)return;let s=this.items[this.items.length-1],o=n.getState(!0);(!s||s.short!==o.short||s.long!==o.long||s.value!==o.value)&&(this.items.push(o),this.items.length>this.maxCount&&this.items.shift())}prev(){return this._i<this.items.length&&(this._i+=1),this.curr()}next(){return this._i>1&&(this._i-=1),this.curr()}curr(){return this.items[this.items.length-this._i]}};var I=function(t){let{short:e,long:n}=B(t),s=t.value.split(/\n/),o=[],a=0;for(let l=0;l<s.length;l++){let d=s[l],c=l===s.length-1,r=c?d:d+`
`,i=a,h=i+r.length,p=-1,m=-1,f="";e>=i&&e<h&&(p=e-i),n>i&&(c?n<=h:n<h)&&(m=n-i),e<=i&&n>=h&&(p=0,m=r.length),p>-1&&m===-1&&(m=r.length),m>-1&&p===-1&&(p=0);let g={isSelected:p>-1&&m>-1,index:l,startIndex:i,endIndex:h,value:r,selectionStart:p,selectionEnd:m};o.push(g),a=h}return o};var se=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:a,shiftKey:l}=S(t);if(!(a&&!o&&!l&&s==="/"))return;t.preventDefault();let{pattern:c,value:r}=this,i=I(n),{short:h,long:p,dir:m,isReversed:f}=e.getState(),y=i.filter(E=>E.isSelected),g=y.filter(E=>!E.value.trim()),v=y.length>1,w=v&&y.length!==g.length,u=!0;for(let E of y)if(!(w&&g.some(A=>A.index===E.index))&&!E.value.startsWith("//")){u=!1;break}let M=h,b=p,K=[];for(let E=0;E<i.length;E++){let A=i[E],{startIndex:L,endIndex:Q}=A,k=A.value;if(!A.isSelected){K.push(A.value);continue}let R;v?u?R=A.value.replace(c,""):w&&g.some(ee=>ee.index===A.index)?R=A.value:R=r+A.value:u?R=A.value.replace(c,""):R=r+A.value;let C=R.length-k.length;h>=L&&h<Q?C>=0?(M+=C,b+=C):(M+=Math.max(C,L-h),b+=Math.max(C,L-p)):p>=L&&h<Q?C>=0?b+=C:b+=Math.max(C,L-p):(M+=C,b+=C),K.push(R)}e.setState({isReversed:f,short:M,long:b,dir:m,value:K.join("")}),e.addHistory()},oe=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:a,shiftKey:l}=S(t);if(!(!a&&!o&&l&&s==="*"))return;let{short:c,long:r,dir:i,isReversed:h}=e.getState();if(c!==r||n.value.charAt(c-1)!=="/")return;t.preventDefault();let f=c+1,y=r+1,g=n.value.substring(0,c)+"**/"+n.value.substring(r);e.addHistory(),e.setState({isReversed:h,short:f,long:y,dir:i,value:g}),e.addHistory()},re=function(t){se.call(this,t),oe.call(this,t)},V=class t extends x{pattern;value;constructor(e){super(e,t.name),this.pattern=t.defaults.pattern,this.value=t.defaults.value}static name="Comment";static defaults={pattern:/^\/\/\s?/,value:"// "};onKeydown=re};var ie=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:a,shiftKey:l}=S(t);if(!(!a&&!o&&s==="Tab"))return;t.preventDefault();let{pattern:c,value:r}=this,i=I(n),{short:h,long:p,dir:m,isReversed:f}=e.getState(),g=i.filter(b=>b.isSelected).length>1,v=t.shiftKey,w=h,u=p,M=[];for(let b=0;b<i.length;b++){let K=i[b],{startIndex:E,endIndex:A}=K,L=K.value;if(!K.isSelected){M.push(K.value);continue}let k;if(g){let R=!K.value.trim();v?k=K.value.replace(c,""):R?k=K.value:k=r+K.value}else v?k=K.value.replace(c,""):k=r+K.value;let T=k.length-L.length;h>=E&&h<A?T>=0?(w+=T,u+=T):(w+=Math.max(T,E-h),u+=Math.max(T,E-p)):p>=E&&h<A?T>=0?u+=T:u+=Math.max(T,E-p):(w+=T,u+=T),M.push(k)}e.addHistory(),e.setState({isReversed:f,short:w,long:u,dir:m,value:M.join("")}),e.addHistory()},G=class t extends x{pattern;value;constructor(e){super(e,t.name),this.pattern=t.defaults.pattern,this.value=t.defaults.value}onKeydown=ie;static name="Indent";static defaults={pattern:/^[^\S\n\r][^\S\n\r]?/,value:"  "}};var $=function(t,e){return Object.keys(t).includes(e)},J=function(t,e){return Object.values(t).includes(e)},N=function(t,e,n){return t[e]&&t[e]===n};var X=function(t,e){return t[e]};var Y=function(t,e){return t.repeat(Math.ceil(e/t.length)).slice(0,e)},ae=function(t,e,n){let s=Object.keys(t).join(""),o=Object.values(t).join("");for(let a=n.length-1;a>=0;a--){let l=n[a];for(let d=l.length-1;d>=0;d--){let c=l[d];if(o.includes(c)){let r=l.match(/^\s*/)?.[0].length||0;return Y(e,r)}if(s.includes(c)){let r=(l.match(/^\s*/)?.[0].length||0)+e.length;return Y(e,r)}}}return""},le=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:s,shiftKey:o}=S(t);if(!(!s&&!n&&e==="Enter"))return;t.preventDefault();let l=this.parent,d=this.parent.element,{pairs:c,indentUnit:r}=this,{short:i,long:h,dir:p,isReversed:m}=l.getState(),f=d.value.charAt(i),y=d.value.substring(0,i),g=`
`,v=d.value.substring(h),w=y.split(/\r\n|\r|\n/),u=ae(c,r,w),M=i+1;if(J(c,f)){let E=u.substring(0,u.length-r.length);g+=u+`
`+E,M+=u.length}else g+=u,M+=u.length;let b=y+g+v,K=M;l.setState({isReversed:!1,short:M,long:K,value:b}),l.addHistory()},H=class t extends x{pairs;indentUnit;constructor(e){super(e,t.name),this.pairs=t.defaults.pairs,this.indentUnit=t.defaults.indentUnit}onKeydown=le;static name="AutoIndent";static defaults={pairs:{"(":")","[":"]","{":"}"},indentUnit:"  "}};var ue=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,s=this.pairs,{key:o,altKey:a,ctrlKey:l,shiftKey:d}=S(t);if(!(!l&&!a&&$(s,o)))return;t.preventDefault();let{short:r,long:i,dir:h,isReversed:p}=e.getState(),m=r!==i,f=o,y=X(s,f),g=n.value.substring(0,r),v=n.value.substring(r,i),w=n.value.substring(i),u,M,b;if(m)b=g+f+v+y+w,u=(g+f).length,M=(g+f+v).length;else{let K=(g+f).length;b=g+f+y+w,u=K,M=K}e.addHistory(),e.setState({isReversed:p,short:u,long:M,dir:h,value:b}),e.addHistory()},de=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,s=this.pairs,{key:o,altKey:a,ctrlKey:l,shiftKey:d}=S(t);if(!(!l&&!a&&o==="Backspace"))return;let{short:r,long:i}=e.getState();if(r!==i)return;let p=n.value.charAt(r-1),m=n.value.charAt(r);if(!N(s,p,m))return;t.preventDefault();let f=n.value.substring(0,r-1),y=n.value.substring(r+1),g=f+y,v=f.length,w=f.length;e.addHistory(),e.setState({isReversed:!1,short:v,long:w,dir:"forward",value:g}),e.addHistory()},ce=function(t){ue.call(this,t),de.call(this,t)},_=class t extends x{pairs;constructor(e){super(e,t.name),this.pairs={...t.defaults.pairs}}onKeydown=ce;static name="AutoPair";static defaults={pairs:{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}}};var he=function(t,e){for(let n of t)if(n.pattern.test(e))return n},fe=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:s,shiftKey:o}=S(t);if(!(!s&&!n&&(e.length===1||e==="Backspace")))return;this.stop(!0);let l=this.parent,d=this.parent.element,c=this._requestId+1,r=this._chunkSize,i=[],h=!1,p=!1,m=0,f=u=>{h=!0,p=u||!1};this._requestId=c,this._stop=f;let y=this.parser.call(this,d),g=y.body,v=[];if(g){let u=he(this.indexes,g);u?v=u.tags:v=this.tags}let w=()=>{let u=[],M=m+r;for(;m<M&&m<v.length;){let K={tag:v[m],query:y};this.filter?.call(this,K,i,m,v)&&(u.push(K),i.push(K)),m++}if(!(p||this._requestId!==c)){if(h||m>=v.length){this.onData?.call(this,u,i),this.onEnd?.call(this,i);return}this.onData?.call(this,u,i),setTimeout(w,0)}};w()},O=class t extends x{tags;indexes;parser;filter;onData;onEnd;_requestId;_chunkSize;_stop;constructor(e){super(e,t.name,1),this.tags=[],this.indexes=[],this.parser=t.defaults.parser,this.filter=t.defaults.filter,this.onData=()=>{},this.onEnd=()=>{},this._requestId=0,this._chunkSize=t.defaults.chunkSize,this._stop=()=>{}}onKeyup=fe;static name="AutoComplete";static defaults={chunkSize:100,parser:function(e){let n=e.value.split(/[,.․‧・｡。{}()<>[\]\\/|'"`!?]|\r\n|\r|\n/),s=e.selectionStart,o=0,a=0;for(let i of n){if(a=o+i.length,s>=o&&s<=a)break;o=a+1}let l=e.value.substring(0,o),d=e.value.substring(o,a),c=e.value.substring(a),r=d.match(/^(\s*)(.*?)(\s*)$/);return r&&(l=l+(r[1]||""),d=r[2],c=(r[3]||"")+c),{head:l,body:d,tail:c}},filter:function(e,n,s,o){let{tag:a,query:l}=e,d=l.body;return a.key.indexOf(d)>-1}};compare(e,n){return F(e,n)}stop(e){let n=this._stop;n?.(e)}set(e){let n=e.query.head.length+e.tag.value.length,s=e.query.head.length+e.tag.value.length,o=e.query.head+e.tag.value+e.query.tail,a={short:n,long:s,value:o};this.parent.setState(a)}};var me=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:a,shiftKey:l}=S(t);if(!(a&&!o&&s==="Enter"))return;t.preventDefault();let{short:c,long:r,dir:i,isReversed:h}=e.getState(),p=I(n),m=p.filter(u=>u.isSelected),f=t.shiftKey?m[0]:m[m.length-1],y=p[p.length-1].index===m[m.length-1].index,g=[],v=c,w=r;for(let u of p){if(!(f.index===u.index)){g.push(u.value);continue}l?(g.push(`
`+u.value),v=u.startIndex,w=u.startIndex):(g.push(u.value+`
`),v=u.endIndex,w=u.endIndex)}!l&&y&&(v+=1,w+=1),e.addHistory(),e.setState({isReversed:!1,short:v,long:w,value:g.join("")}),e.addHistory()},D=class t extends x{constructor(e){super(e,t.name)}onKeydown=me;static name="LineBreak";static defaults={}};var pe=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:a,shiftKey:l}=S(t);if(!(a&&!o&&l&&s.toLowerCase()==="k"))return;t.preventDefault();let c=I(n),r=c.filter(u=>u.isSelected),i=r[0],h=r[r.length-1],p=[],m=0,f=0,y=0;for(let u of c)u.isSelected||(u.index===i.index-1?(m=u.endIndex,f=u.endIndex):u.index===h.index+1&&(y=u.value.length),p.push(u.value));let g=Math.min(Math.max(0,h.selectionStart,h.selectionEnd-1),Math.max(0,y-1));m+=g,f+=g;let v=p.join("");r.length===1&&r[0].value===""&&c[c.length-1].index===r[0].index&&(v=v.substring(0,v.length-1)),e.addHistory(),e.setState({isReversed:!1,short:m,long:f,value:v}),e.addHistory()},j=class t extends x{constructor(e){super(e,t.name)}onKeydown=pe;static name="LineRemove";static defaults={}};var ge=!!navigator.clipboard?.writeText,ve=async function(t){if(t.defaultPrevented)return;if(!ge){console.warn("navigator.clipboard.writeText not found");return}let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:a,shiftKey:l}=S(t),{short:d,long:c,dir:r,isReversed:i}=e.getState();if(!(!(d!==c)&&a&&!o&&!l&&s.toLowerCase()==="x"))return;t.preventDefault();let m=I(n),f="",y=[],g=d,v=c;for(let w of m)w.isSelected?(g=w.startIndex,v=w.startIndex,f=w.value):y.push(w.value);f&&(f.endsWith(`
`)||(f+=`
`),await navigator.clipboard.writeText(f),e.addHistory(),e.setState({isReversed:!1,short:g,long:v,value:y.join("")}),e.addHistory())},q=class t extends x{constructor(e){super(e,t.name)}onKeydownAsync=ve;static name="LineCut";static defaults={}};var ye=!!navigator.clipboard?.writeText,we=async function(t){if(t.defaultPrevented)return;if(!ye){console.warn("navigator.clipboard.writeText not found");return}let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:a,shiftKey:l}=S(t),{short:d,long:c,dir:r,isReversed:i}=e.getState();if(!(!(d!==c)&&a&&!o&&!l&&s.toLowerCase()==="c"))return;t.preventDefault();let f=I(n).find(y=>y.isSelected)?.value;f&&(f.endsWith(`
`)||(f+=`
`),await navigator.clipboard.writeText(f))},z=class t extends x{constructor(e){super(e,t.name)}onKeydownAsync=we;static name="LineCopy";static defaults={}};var xe=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{short:s,long:o,dir:a,isReversed:l}=e.getState();if(!!(s!==o))return;let r=t.clipboardData?.getData("text");if(!r)return;r=r.replace(/\r\n|\r/g,`
`);let i=r.split(`
`),h=i.length===2,p=i[i.length-1]==="";if(!h||!p)return;t.preventDefault();let m=I(n),f=[],y=s+r.length,g=o+r.length;for(let v of m)v.isSelected&&f.push(r),f.push(v.value);e.addHistory(),e.setState({isReversed:l,short:y,long:g,dir:a,value:f.join("")}),e.addHistory()},U=class t extends x{constructor(e){super(e,t.name)}onPaste=xe;static name="LinePaste";static defaults={}};var Z=class{element;modules;moduleOrder;_keydownState;_keydownEvent;_keyupEvent;_pasteEvent;_focusEvent;_blurEvent;constructor(e){this.element=e,this.modules={},this.modules[P.name]=new P(this),this.modules[V.name]=new V(this),this.modules[G.name]=new G(this),this.modules[D.name]=new D(this),this.modules[j.name]=new j(this),this.modules[q.name]=new q(this),this.modules[z.name]=new z(this),this.modules[U.name]=new U(this),this.modules[H.name]=new H(this),this.modules[_.name]=new _(this),this.modules[O.name]=new O(this),this.moduleOrder=[],this._keydownState=null,this._keydownEvent=async s=>{for(let o of this.moduleOrder)o.onKeydown?.call(o,s),await o.onKeydownAsync?.call(o,s);s.defaultPrevented?this._clearKeydownState():["Meta","Control","Alt","Shift"].includes(s.key)||this._setKeydownState(s)},this._keyupEvent=async s=>{for(let o of this.moduleOrder)o.onKeyup?.call(o,s),await o.onKeyupAsync?.call(o,s)},this._pasteEvent=async s=>{for(let o of this.moduleOrder)o.onPaste?.call(o,s),await o.onPasteAsync?.call(o,s)};let n=s=>{this.addHistory(!1)};this._focusEvent=s=>{setTimeout(()=>{this.addHistory(!1),this.element.addEventListener("pointerup",n,!0)},0)},this._blurEvent=s=>{this.element.removeEventListener("pointerup",n,!0)},this.element.addEventListener("keydown",this._keydownEvent,!0),this.element.addEventListener("keyup",this._keyupEvent,!0),this.element.addEventListener("paste",this._pasteEvent,!0),this.element.addEventListener("focus",this._focusEvent,!0),this.element.addEventListener("blur",this._blurEvent,!0),this.initModuleOrder()}initModuleOrder(){this.moduleOrder=Object.values(this.modules).sort((e,n)=>e.index-n.index)}getModule(e){return this.modules[e]}setModule(e){this.modules[e.name]=e,this.initModuleOrder()}removeModule(e){this.modules[e]&&(delete this.modules[e],this.initModuleOrder())}getState(e){return B(this.element,e)}setState(e){W(this.element,e)}addHistory(e=!0){this.getModule(P.name)?.add(e)}_clearKeydownState(){this._keydownState=null}_setKeydownState(e){this._keydownState={value:this.element.value,state:B(this.element),key:e.key}}destroy(){this.element.removeEventListener("keydown",this._keydownEvent),this.element.removeEventListener("keyup",this._keyupEvent),this.element.removeEventListener("paste",this._pasteEvent),this.element.removeEventListener("focus",this._focusEvent),this.element.removeEventListener("blur",this._blurEvent)}};export{O as AutoCompleteModule,H as AutoIndentModule,_ as AutoPairModule,V as CommentModule,P as HistoryModule,G as IndentModule,D as LineBreakModule,z as LineCopyModule,q as LineCutModule,U as LinePasteModule,j as LineRemoveModule,Z as MTGA,x as MTGAModule};
