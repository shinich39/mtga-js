var x=function(t,e){let n=t.selectionStart>t.selectionEnd,s=Math.min(t.selectionStart,t.selectionEnd),o=Math.max(t.selectionStart,t.selectionEnd),i=t.selectionDirection;return e?{isReversed:n,short:s,long:o,dir:i,value:t.value}:{isReversed:n,short:s,long:o,dir:i}},Q=function(t,e){typeof e.value=="string"&&(t.value=e.value),e.isReversed?t.setSelectionRange(e.long,e.short,e.dir||"none"):t.setSelectionRange(e.short,e.long,e.dir||"none"),t.focus()};var S=class{parent;name;index;onKeydown;onKeyup;constructor(e,n,s=9999){this.parent=e,this.name=n,this.index=s}static defaults={}};var b=function(t){let e=t.key,n=t.altKey,s=t.shiftKey,o=t.ctrlKey||t.metaKey;return{key:e,altKey:n,shiftKey:s,ctrlKey:o}};function F(t,e){let n=Array.from({length:t.length+1},()=>Array(e.length+1).fill(0));for(let u=1;u<=t.length;u++)for(let d=1;d<=e.length;d++)t[u-1]===e[d-1]?n[u][d]=n[u-1][d-1]+1:n[u][d]=Math.max(n[u-1][d],n[u][d-1]);let s=[],o=0,i=t.length,a=e.length,l=null,c=[],r=function(){l!==null&&c.length>0&&s.push([l,c.reverse().join("")]),l=null,c=[]};for(;i>0||a>0;){let u=t[i-1],d=e[a-1];i>0&&a>0&&u===d?(l!==0&&r(),l=0,c.push(u),o++,i--,a--):a>0&&(i===0||n[i][a-1]>=n[i-1][a])?(l!==1&&r(),l=1,c.push(d),a--):i>0&&(l!==-1&&r(),l=-1,c.push(u),i--)}return r(),{accuracy:o*2/(t.length+e.length),score:o,match:s.reverse()}}var ee=function(t){if(t.defaultPrevented)return;let e=this.parent,{key:n,altKey:s,ctrlKey:o,shiftKey:i}=b(t);if(!(o&&!s&&n.toLowerCase()==="z"))return;t.preventDefault();let l;i?l=this.next():l=this.prev(),l&&e.setState(l)},te=function(t){let e=this.parent,n=e._keydownState;if(e._clearKeydownState(),!n)return;let s=e.element,o=n.value,i=s.value;if(o!==i)e.addHistory();else{let a=n.state,l=x(s);(a.short!==l.short||a.long!==l.long)&&e.addHistory(!1)}},V=class t extends S{items;maxCount;_i;constructor(e){super(e,t.name,0),this.items=[],this.maxCount=t.defaults.maxCount,this._i=1}static name="History";static defaults={maxCount:390};onKeydown=ee;onKeyup=te;prune(){this._i>1&&(this.items=this.items.slice(0,this.items.length-(this._i-1)),this._i=1)}add(e=!0){let n=this.parent.element;if(e)this.prune();else if(this._i!==1)return;let s=this.items[this.items.length-1],o=x(n,!0);(!s||s.short!==o.short||s.long!==o.long||s.value!==o.value)&&(this.items.push(o),this.items.length>this.maxCount&&this.items.shift())}prev(){return this._i<this.items.length&&(this._i+=1),this.curr()}next(){return this._i>1&&(this._i-=1),this.curr()}curr(){return this.items[this.items.length-this._i]}};var A=function(t){let{short:e,long:n}=x(t),s=t.value.split(/\n/),o=[],i=0;for(let a=0;a<s.length;a++){let l=s[a],c=a===s.length-1,r=c?l:l+`
`,u=i,d=u+r.length,f=-1,v=-1,m="";e>=u&&e<d&&(f=e-u),n>u&&(c?n<=d:n<d)&&(v=n-u),e<=u&&n>=d&&(f=0,v=r.length),f>-1&&v===-1&&(v=r.length),v>-1&&f===-1&&(f=0);let h={isSelected:f>-1&&v>-1,index:a,startIndex:u,endIndex:d,value:r,selectionStart:f,selectionEnd:v};o.push(h),i=d}return o};var ne=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:i,shiftKey:a}=b(t);if(!(i&&!o&&!a&&s==="/"))return;t.preventDefault();let{pattern:c,value:r}=this,u=A(n),{short:d,long:f,dir:v,isReversed:m}=x(n),y=u.filter(E=>E.isSelected),h=y.filter(E=>!E.value.trim()),w=y.length>1,g=w&&y.length!==h.length,p=!0;for(let E of y)if(!(g&&h.some(k=>k.index===E.index))&&!E.value.startsWith("//")){p=!1;break}let M=d,K=f,I=[];for(let E=0;E<u.length;E++){let k=u[E],{startIndex:P,endIndex:B}=k,R=k.value;if(!k.isSelected){I.push(k.value);continue}let L;w?p?L=k.value.replace(c,""):g&&h.some(Z=>Z.index===k.index)?L=k.value:L=r+k.value:p?L=k.value.replace(c,""):L=r+k.value;let T=L.length-R.length;d>=P&&d<B?T>=0?(M+=T,K+=T):(M+=Math.max(T,P-d),K+=Math.max(T,P-f)):f>=P&&d<B?T>=0?K+=T:K+=Math.max(T,P-f):(M+=T,K+=T),I.push(L)}e.setState({isReversed:m,short:M,long:K,dir:v,value:I.join("")}),e.addHistory()},se=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:i,shiftKey:a}=b(t);if(!(!i&&!o&&a&&s==="*"))return;let{short:c,long:r,dir:u,isReversed:d}=x(n);if(c!==r||n.value.charAt(c-1)!=="/")return;t.preventDefault();let m=c+1,y=r+1,h=n.value.substring(0,c)+"**/"+n.value.substring(r);e.setState({isReversed:d,short:m,long:y,dir:u,value:h}),e.addHistory()},oe=function(t){ne.call(this,t),se.call(this,t)},_=class t extends S{pattern;value;constructor(e){super(e,t.name),this.pattern=t.defaults.pattern,this.value=t.defaults.value}static name="Comment";static defaults={pattern:/^\/\/\s?/,value:"// "};onKeydown=oe};var re=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:i,shiftKey:a}=b(t);if(!(!i&&!o&&s==="Tab"))return;t.preventDefault();let{pattern:c,value:r}=this,u=A(n),{short:d,long:f,dir:v,isReversed:m}=x(n),h=u.filter(K=>K.isSelected).length>1,w=t.shiftKey,g=d,p=f,M=[];for(let K=0;K<u.length;K++){let I=u[K],{startIndex:E,endIndex:k}=I,P=I.value;if(!I.isSelected){M.push(I.value);continue}let R;if(h){let L=!I.value.trim();w?R=I.value.replace(c,""):L?R=I.value:R=r+I.value}else w?R=I.value.replace(c,""):R=r+I.value;let C=R.length-P.length;d>=E&&d<k?C>=0?(g+=C,p+=C):(g+=Math.max(C,E-d),p+=Math.max(C,E-f)):f>=E&&d<k?C>=0?p+=C:p+=Math.max(C,E-f):(g+=C,p+=C),M.push(R)}e.setState({isReversed:m,short:g,long:p,dir:v,value:M.join("")}),e.addHistory()},H=class t extends S{pattern;value;constructor(e){super(e,t.name),this.pattern=t.defaults.pattern,this.value=t.defaults.value}onKeydown=re;static name="Indent";static defaults={pattern:/^[^\S\n\r][^\S\n\r]?/,value:"  "}};var N=function(t,e){return Object.keys(t).includes(e)},W=function(t,e){return Object.values(t).includes(e)},$=function(t,e,n){return t[e]&&t[e]===n};var J=function(t,e){return t[e]};var X=function(t,e){return t.repeat(Math.ceil(e/t.length)).slice(0,e)},ie=function(t,e,n){let s=Object.keys(t).join(""),o=Object.values(t).join("");for(let i=n.length-1;i>=0;i--){let a=n[i];for(let l=a.length-1;l>=0;l--){let c=a[l];if(o.includes(c)){let r=a.match(/^\s*/)?.[0].length||0;return X(e,r)}if(s.includes(c)){let r=(a.match(/^\s*/)?.[0].length||0)+e.length;return X(e,r)}}}return""},ae=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:s,shiftKey:o}=b(t);if(!(!s&&!n&&!o&&e==="Enter"))return;t.preventDefault();let a=this.parent,l=a.element,{pairs:c,indentUnit:r}=this,{short:u,long:d,dir:f,isReversed:v}=x(l),m=l.value.charAt(u),y=l.value.substring(0,u),h=`
`,w=l.value.substring(d),g=y.split(/\r\n|\r|\n/),p=ie(c,r,g),M=u+1;if(W(c,m)){let E=p.substring(0,p.length-r.length);h+=p+`
`+E,M+=p.length}else h+=p,M+=p.length;let K=y+h+w,I=M;a.setState({isReversed:!1,short:M,long:I,dir:"none",value:K}),a.addHistory()},G=class t extends S{pairs;indentUnit;constructor(e){super(e,t.name),this.pairs=t.defaults.pairs,this.indentUnit=t.defaults.indentUnit}onKeydown=ae;static name="AutoIndent";static defaults={pairs:{"(":")","[":"]","{":"}"},indentUnit:"  "}};var le=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,s=this.pairs,{key:o,altKey:i,ctrlKey:a,shiftKey:l}=b(t);if(!(!a&&!i&&N(s,o)))return;t.preventDefault();let{short:r,long:u,dir:d,isReversed:f}=x(n),v=r!==u,m=o,y=J(s,m),h=n.value.substring(0,r),w=n.value.substring(r,u),g=n.value.substring(u),p,M,K;if(v)K=h+m+w+y+g,p=(h+m).length,M=(h+m+w).length;else{let I=(h+m).length;K=h+m+y+g,p=I,M=I}e.setState({isReversed:f,short:p,long:M,dir:d,value:K}),e.addHistory()},ue=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,s=this.pairs,{key:o,altKey:i,ctrlKey:a,shiftKey:l}=b(t);if(!(!a&&!i&&!l&&o==="Backspace"))return;let{short:r,long:u}=x(n);if(r!==u)return;let f=n.value.charAt(r-1),v=n.value.charAt(r);if(!$(s,f,v))return;t.preventDefault();let m=n.value.substring(0,r-1),y=n.value.substring(r+1),h=m+y,w=m.length,g=m.length;e.setState({isReversed:!1,short:w,long:g,dir:"forward",value:h}),e.addHistory()},ce=function(t){le.call(this,t),ue.call(this,t)},O=class t extends S{pairs;constructor(e){super(e,t.name),this.pairs={...t.defaults.pairs}}onKeydown=ce;static name="AutoPair";static defaults={pairs:{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}}};var de=function(t,e){for(let n of t)if(n.pattern.test(e))return n},he=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:s,shiftKey:o}=b(t);if(!(!s&&!n&&(e.length===1||e==="Backspace")))return;this.stop(!0);let a=this.parent,l=this._requestId+1,c=this._chunkSize,r=[],u=!1,d=!1,f=0,v=g=>{u=!0,d=g||!1};this._requestId=l,this._stop=v;let m=this.parser.call(this,a.element),y=m.body,h=[];if(y){let g=de(this.indexes,y);g?h=g.tags:h=this.tags}let w=()=>{let g=[],p=f+c;for(;f<p&&f<h.length;){let K={tag:h[f],query:m};this.filter?.call(this,K,r,f,h)&&(g.push(K),r.push(K)),f++}if(!(d||this._requestId!==l)){if(u||f>=h.length){this.onData?.call(this,g,r),this.onEnd?.call(this,r);return}this.onData?.call(this,g,r),setTimeout(w,0)}};w()},j=class t extends S{tags;indexes;parser;filter;onData;onEnd;_requestId;_chunkSize;_stop;constructor(e){super(e,t.name,1),this.tags=[],this.indexes=[],this.parser=t.defaults.parser,this.filter=t.defaults.filter,this.onData=()=>{},this.onEnd=()=>{},this._requestId=0,this._chunkSize=t.defaults.chunkSize,this._stop=()=>{}}onKeyup=he;static name="AutoComplete";static defaults={chunkSize:100,parser:function(e){let n=e.value.split(/[,.․‧・｡。{}()<>[\]\\/|'"`!?]|\r\n|\r|\n/),s=e.selectionStart,o=0,i=0;for(let u of n){if(i=o+u.length,s>=o&&s<=i)break;o=i+1}let a=e.value.substring(0,o),l=e.value.substring(o,i),c=e.value.substring(i),r=l.match(/^(\s*)(.*?)(\s*)$/);return r&&(a=a+(r[1]||""),l=r[2],c=(r[3]||"")+c),{head:a,body:l,tail:c}},filter:function(e,n,s,o){let{tag:i,query:a}=e,l=a.body;return i.key.indexOf(l)>-1}};compare(e,n){return F(e,n)}stop(e){let n=this._stop;n?.(e)}set(e){let n=e.query.head.length+e.tag.value.length,s=e.query.head.length+e.tag.value.length,o=e.query.head+e.tag.value+e.query.tail,i={short:n,long:s,value:o};this.parent.setState(i)}};var fe=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:i,shiftKey:a}=b(t);if(!(i&&!o&&s==="Enter"))return;t.preventDefault();let{short:c,long:r,dir:u,isReversed:d}=x(n),f=A(n),v=f.filter(p=>p.isSelected),m=t.shiftKey?v[0]:v[v.length-1],y=f[f.length-1].index===v[v.length-1].index,h=[],w=c,g=r;for(let p of f){if(!(m.index===p.index)){h.push(p.value);continue}a?(h.push(`
`+p.value),w=p.startIndex,g=p.startIndex):(h.push(p.value+`
`),w=p.endIndex,g=p.endIndex)}!a&&y&&(w+=1,g+=1),e.setState({isReversed:!1,short:w,long:g,dir:"none",value:h.join("")}),e.addHistory()},D=class t extends S{constructor(e){super(e,t.name)}onKeydown=fe;static name="LineBreak";static defaults={}};var me=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:i,shiftKey:a}=b(t);if(!(i&&!o&&a&&s.toLowerCase()==="k"))return;t.preventDefault();let c=A(n),r=c.filter(h=>h.isSelected),u=r[0],d=[],f=0,v=0;for(let h of c)h.isSelected||(h.index===u.index-1&&(f=h.startIndex,v=h.startIndex),d.push(h.value));let m=d.join("");r.length===1&&r[0].value===""&&c[c.length-1].index===r[0].index&&(m=m.substring(0,m.length-1)),e.setState({isReversed:!1,short:f,long:v,dir:"none",value:m}),e.addHistory()},q=class t extends S{constructor(e){super(e,t.name)}onKeydown=me;static name="LineRemove";static defaults={}};var pe=!!navigator.clipboard?.writeText,ge=function(t){if(t.defaultPrevented)return;if(!pe){console.warn("navigator.clipboard.writeText not found");return}let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:i,shiftKey:a}=b(t),{short:l,long:c,dir:r,isReversed:u}=x(n);if(!(!(l!==c)&&i&&!o&&!a&&s.toLowerCase()==="x"))return;t.preventDefault();let v=A(n),m="",y=[],h=l,w=c;for(let g of v)g.isSelected?(h=g.startIndex,w=g.startIndex,m=g.value):y.push(g.value);if(!m){console.warn("No data selected");return}navigator.clipboard.writeText(m).then(()=>{e.setState({isReversed:!1,short:h,long:w,dir:"none",value:y.join("")}),e.addHistory()})},z=class t extends S{constructor(e){super(e,t.name)}onKeydown=ge;static name="LineCut";static defaults={}};var ve=!!navigator.clipboard?.writeText,ye=function(t){if(t.defaultPrevented)return;if(!ve){console.warn("navigator.clipboard.writeText not found");return}let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:i,shiftKey:a}=b(t),{short:l,long:c,dir:r,isReversed:u}=x(n);if(!(!(l!==c)&&i&&!o&&!a&&s.toLowerCase()==="c"))return;t.preventDefault();let m=A(n).find(y=>y.isSelected)?.value;if(!m){console.warn("No data selected");return}navigator.clipboard.writeText(m)},U=class t extends S{constructor(e){super(e,t.name)}onKeydown=ye;static name="LineCopy";static defaults={}};var Y=class{element;modules;moduleOrder;_keydownState;_keydownEvent;_keyupEvent;_focusEvent;_blurEvent;constructor(e){this.element=e,this.modules={},this.modules[V.name]=new V(this),this.modules[_.name]=new _(this),this.modules[H.name]=new H(this),this.modules[D.name]=new D(this),this.modules[q.name]=new q(this),this.modules[z.name]=new z(this),this.modules[U.name]=new U(this),this.modules[G.name]=new G(this),this.modules[O.name]=new O(this),this.modules[j.name]=new j(this),this.moduleOrder=[],this._keydownState=null,this._keydownEvent=s=>{for(let o of this.moduleOrder)o.onKeydown?.call(o,s);s.defaultPrevented?this._clearKeydownState():["Meta","Control","Alt","Shift"].includes(s.key)||this._setKeydownState(s)},this._keyupEvent=s=>{for(let o of this.moduleOrder)o.onKeyup?.call(o,s)};let n=s=>{this.addHistory(!1)};this._focusEvent=s=>{setTimeout(()=>{this.addHistory(!1),this.element.addEventListener("pointerup",n,!0)},0)},this._blurEvent=s=>{this.element.removeEventListener("pointerup",n,!0)},this.element.addEventListener("keydown",this._keydownEvent,!0),this.element.addEventListener("keyup",this._keyupEvent,!0),this.element.addEventListener("focus",this._focusEvent,!0),this.element.addEventListener("blur",this._blurEvent,!0),this.initModuleOrder()}initModuleOrder(){this.moduleOrder=Object.values(this.modules).sort((e,n)=>e.index-n.index)}getModule(e){return this.modules[e]}setModule(e){this.modules[e.name]=e,this.initModuleOrder()}removeModule(e){this.modules[e]&&(delete this.modules[e],this.initModuleOrder())}getState(e){return x(this.element,e)}setState(e){Q(this.element,e)}addHistory(e=!0){this.getModule(V.name)?.add(e)}_clearKeydownState(){this._keydownState=null}_setKeydownState(e){this._keydownState={value:this.element.value,state:x(this.element),key:e.key}}destroy(){this.element.removeEventListener("keydown",this._keydownEvent),this.element.removeEventListener("keyup",this._keyupEvent),this.element.removeEventListener("focus",this._focusEvent),this.element.removeEventListener("blur",this._blurEvent)}};export{j as AutoCompleteModule,G as AutoIndentModule,O as AutoPairModule,_ as CommentModule,V as HistoryModule,H as IndentModule,D as LineBreakModule,U as LineCopyModule,z as LineCutModule,q as LineRemoveModule,Y as MTGA};
