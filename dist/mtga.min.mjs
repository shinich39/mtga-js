var B=function(t,e){let n=t.selectionStart>t.selectionEnd,s=Math.min(t.selectionStart,t.selectionEnd),o=Math.max(t.selectionStart,t.selectionEnd),a=t.selectionDirection;return e?{isReversed:n,short:s,long:o,dir:a,value:t.value}:{isReversed:n,short:s,long:o,dir:a}},W=function(t,e){typeof e.value=="string"&&(t.value=e.value),e.isReversed?t.setSelectionRange(e.long,e.short,e.dir||"none"):t.setSelectionRange(e.short,e.long,e.dir||"none"),t.focus()};var x=class{parent;name;index;onKeydown;onKeydownAsync;onKeyup;onKeyupAsync;onPaste;onPasteAsync;constructor(e,n,s=9999){this.parent=e,this.name=n,this.index=s}static defaults={}};var S=function(t){let e=t.key,n=t.altKey,s=t.shiftKey,o=t.ctrlKey||t.metaKey;return{key:e,altKey:n,shiftKey:s,ctrlKey:o}};function F(t,e){let n=Array.from({length:t.length+1},()=>Array(e.length+1).fill(0));for(let i=1;i<=t.length;i++)for(let c=1;c<=e.length;c++)t[i-1]===e[c-1]?n[i][c]=n[i-1][c-1]+1:n[i][c]=Math.max(n[i-1][c],n[i][c-1]);let s=[],o=0,a=t.length,l=e.length,u=null,d=[],r=function(){u!==null&&d.length>0&&s.push([u,d.reverse().join("")]),u=null,d=[]};for(;a>0||l>0;){let i=t[a-1],c=e[l-1];a>0&&l>0&&i===c?(u!==0&&r(),u=0,d.push(i),o++,a--,l--):l>0&&(a===0||n[a][l-1]>=n[a-1][l])?(u!==1&&r(),u=1,d.push(c),l--):a>0&&(u!==-1&&r(),u=-1,d.push(i),a--)}return r(),{accuracy:o*2/(t.length+e.length),score:o,match:s.reverse()}}var te=function(t){if(t.defaultPrevented)return;let e=this.parent,{key:n,altKey:s,ctrlKey:o,shiftKey:a}=S(t);if(!(o&&!s&&n.toLowerCase()==="z"))return;t.preventDefault();let u;a?u=this.next():u=this.prev(),u&&e.setState(u)},ne=function(t){let e=this.parent,n=e._keydownState;if(e._clearKeydownState(),!n)return;let s=e.element,o=n.value,a=s.value;if(o!==a)e.addHistory();else{let l=n.state,u=e.getState();(l.short!==u.short||l.long!==u.long)&&e.addHistory(!1)}},P=class t extends x{items;maxCount;_i;constructor(e){super(e,t.name,0),this.items=[],this.maxCount=t.defaults.maxCount,this._i=1}static name="History";static defaults={maxCount:390};onKeydown=te;onKeyup=ne;prune(){this._i>1&&(this.items=this.items.slice(0,this.items.length-(this._i-1)),this._i=1)}add(e=!0){let n=this.parent;if(e)this.prune();else if(this._i!==1)return;let s=this.items[this.items.length-1],o=n.getState(!0);(!s||s.short!==o.short||s.long!==o.long||s.value!==o.value)&&(this.items.push(o),this.items.length>this.maxCount&&this.items.shift())}prev(){return this._i<this.items.length&&(this._i+=1),this.curr()}next(){return this._i>1&&(this._i-=1),this.curr()}curr(){return this.items[this.items.length-this._i]}};var I=function(t){let{short:e,long:n}=B(t),s=t.value.split(/\n/),o=[],a=0;for(let l=0;l<s.length;l++){let u=s[l],d=l===s.length-1,r=d?u:u+`
`,i=a,c=i+r.length,g=-1,p=-1,h="";e>=i&&e<c&&(g=e-i),n>i&&(d?n<=c:n<c)&&(p=n-i),e<=i&&n>=c&&(g=0,p=r.length),g>-1&&p===-1&&(p=r.length),p>-1&&g===-1&&(g=0);let f={isSelected:g>-1&&p>-1,index:l,startIndex:i,endIndex:c,value:r,selectionStart:g,selectionEnd:p};o.push(f),a=c}return o};var se=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:a,shiftKey:l}=S(t);if(!(a&&!o&&!l&&s==="/"))return;t.preventDefault();let{pattern:d,value:r}=this,i=I(n),{short:c,long:g,dir:p,isReversed:h}=e.getState(),y=i.filter(E=>E.isSelected),f=y.filter(E=>!E.value.trim()),v=y.length>1,w=v&&y.length!==f.length,m=!0;for(let E of y)if(!(w&&f.some(A=>A.index===E.index))&&!E.value.startsWith("//")){m=!1;break}let M=c,b=g,K=[];for(let E=0;E<i.length;E++){let A=i[E],{startIndex:L,endIndex:Q}=A,k=A.value;if(!A.isSelected){K.push(A.value);continue}let R;v?m?R=A.value.replace(d,""):w&&f.some(ee=>ee.index===A.index)?R=A.value:R=r+A.value:m?R=A.value.replace(d,""):R=r+A.value;let C=R.length-k.length;c>=L&&c<Q?C>=0?(M+=C,b+=C):(M+=Math.max(C,L-c),b+=Math.max(C,L-g)):g>=L&&c<Q?C>=0?b+=C:b+=Math.max(C,L-g):(M+=C,b+=C),K.push(R)}e.setState({isReversed:h,short:M,long:b,dir:p,value:K.join("")}),e.addHistory()},oe=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:a,shiftKey:l}=S(t);if(!(!a&&!o&&l&&s==="*"))return;let{short:d,long:r,dir:i,isReversed:c}=e.getState();if(d!==r||n.value.charAt(d-1)!=="/")return;t.preventDefault();let h=d+1,y=r+1,f=n.value.substring(0,d)+"**/"+n.value.substring(r);e.addHistory(),e.setState({isReversed:c,short:h,long:y,dir:i,value:f}),e.addHistory()},re=function(t){se.call(this,t),oe.call(this,t)},V=class t extends x{pattern;value;constructor(e){super(e,t.name),this.pattern=t.defaults.pattern,this.value=t.defaults.value}static name="Comment";static defaults={pattern:/^\/\/\s?/,value:"// "};onKeydown=re};var ie=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:a,shiftKey:l}=S(t);if(!(!a&&!o&&s==="Tab"))return;t.preventDefault();let{pattern:d,value:r}=this,i=I(n),{short:c,long:g,dir:p,isReversed:h}=e.getState(),f=i.filter(b=>b.isSelected).length>1,v=t.shiftKey,w=c,m=g,M=[];for(let b=0;b<i.length;b++){let K=i[b],{startIndex:E,endIndex:A}=K,L=K.value;if(!K.isSelected){M.push(K.value);continue}let k;if(f){let R=!K.value.trim();v?k=K.value.replace(d,""):R?k=K.value:k=r+K.value}else v?k=K.value.replace(d,""):k=r+K.value;let T=k.length-L.length;c>=E&&c<A?T>=0?(w+=T,m+=T):(w+=Math.max(T,E-c),m+=Math.max(T,E-g)):g>=E&&c<A?T>=0?m+=T:m+=Math.max(T,E-g):(w+=T,m+=T),M.push(k)}e.addHistory(),e.setState({isReversed:h,short:w,long:m,dir:p,value:M.join("")}),e.addHistory()},G=class t extends x{pattern;value;constructor(e){super(e,t.name),this.pattern=t.defaults.pattern,this.value=t.defaults.value}onKeydown=ie;static name="Indent";static defaults={pattern:/^[^\S\n\r][^\S\n\r]?/,value:"  "}};var $=function(t,e){return Object.keys(t).includes(e)},J=function(t,e){return Object.values(t).includes(e)},N=function(t,e,n){return t[e]&&t[e]===n};var X=function(t,e){return t[e]};var Y=function(t,e){return t.repeat(Math.ceil(e/t.length)).slice(0,e)},ae=function(t,e,n){let s=Object.keys(t).join(""),o=Object.values(t).join("");for(let a=n.length-1;a>=0;a--){let l=n[a];for(let u=l.length-1;u>=0;u--){let d=l[u];if(o.includes(d)){let r=l.match(/^\s*/)?.[0].length||0;return Y(e,r)}if(s.includes(d)){let r=(l.match(/^\s*/)?.[0].length||0)+e.length;return Y(e,r)}}}return""},le=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:s,shiftKey:o}=S(t);if(!(!s&&!n&&e==="Enter"))return;t.preventDefault();let l=this.parent,u=this.parent.element,{pairs:d,indentUnit:r}=this,{short:i,long:c,dir:g,isReversed:p}=l.getState(),h=u.value.charAt(i),y=u.value.substring(0,i),f=`
`,v=u.value.substring(c),w=y.split(/\r\n|\r|\n/),m=ae(d,r,w),M=i+1;if(J(d,h)){let E=m.substring(0,m.length-r.length);f+=m+`
`+E,M+=m.length}else f+=m,M+=m.length;let b=y+f+v,K=M;l.setState({isReversed:!1,short:M,long:K,dir:"none",value:b}),l.addHistory()},H=class t extends x{pairs;indentUnit;constructor(e){super(e,t.name),this.pairs=t.defaults.pairs,this.indentUnit=t.defaults.indentUnit}onKeydown=le;static name="AutoIndent";static defaults={pairs:{"(":")","[":"]","{":"}"},indentUnit:"  "}};var ue=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,s=this.pairs,{key:o,altKey:a,ctrlKey:l,shiftKey:u}=S(t);if(!(!l&&!a&&$(s,o)))return;t.preventDefault();let{short:r,long:i,dir:c,isReversed:g}=e.getState(),p=r!==i,h=o,y=X(s,h),f=n.value.substring(0,r),v=n.value.substring(r,i),w=n.value.substring(i),m,M,b;if(p)b=f+h+v+y+w,m=(f+h).length,M=(f+h+v).length;else{let K=(f+h).length;b=f+h+y+w,m=K,M=K}e.addHistory(),e.setState({isReversed:g,short:m,long:M,dir:c,value:b}),e.addHistory()},de=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,s=this.pairs,{key:o,altKey:a,ctrlKey:l,shiftKey:u}=S(t);if(!(!l&&!a&&o==="Backspace"))return;let{short:r,long:i}=e.getState();if(r!==i)return;let g=n.value.charAt(r-1),p=n.value.charAt(r);if(!N(s,g,p))return;t.preventDefault();let h=n.value.substring(0,r-1),y=n.value.substring(r+1),f=h+y,v=h.length,w=h.length;e.addHistory(),e.setState({isReversed:!1,short:v,long:w,dir:"forward",value:f}),e.addHistory()},ce=function(t){ue.call(this,t),de.call(this,t)},_=class t extends x{pairs;constructor(e){super(e,t.name),this.pairs={...t.defaults.pairs}}onKeydown=ce;static name="AutoPair";static defaults={pairs:{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}}};var he=function(t,e){for(let n of t)if(n.pattern.test(e))return n},fe=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:s,shiftKey:o}=S(t);if(!(!s&&!n&&(e.length===1||e==="Backspace")))return;this.stop(!0);let l=this.parent,u=this.parent.element,d=this._requestId+1,r=this._chunkSize,i=[],c=!1,g=!1,p=0,h=m=>{c=!0,g=m||!1};this._requestId=d,this._stop=h;let y=this.parser.call(this,u),f=y.body,v=[];if(f){let m=he(this.indexes,f);m?v=m.tags:v=this.tags}let w=()=>{let m=[],M=p+r;for(;p<M&&p<v.length;){let K={tag:v[p],query:y};this.filter?.call(this,K,i,p,v)&&(m.push(K),i.push(K)),p++}if(!(g||this._requestId!==d)){if(c||p>=v.length){this.onData?.call(this,m,i),this.onEnd?.call(this,i);return}this.onData?.call(this,m,i),setTimeout(w,0)}};w()},O=class t extends x{tags;indexes;parser;filter;onData;onEnd;_requestId;_chunkSize;_stop;constructor(e){super(e,t.name,1),this.tags=[],this.indexes=[],this.parser=t.defaults.parser,this.filter=t.defaults.filter,this.onData=()=>{},this.onEnd=()=>{},this._requestId=0,this._chunkSize=t.defaults.chunkSize,this._stop=()=>{}}onKeyup=fe;static name="AutoComplete";static defaults={chunkSize:100,parser:function(e){let n=e.value.split(/[,.․‧・｡。{}()<>[\]\\/|'"`!?]|\r\n|\r|\n/),s=e.selectionStart,o=0,a=0;for(let i of n){if(a=o+i.length,s>=o&&s<=a)break;o=a+1}let l=e.value.substring(0,o),u=e.value.substring(o,a),d=e.value.substring(a),r=u.match(/^(\s*)(.*?)(\s*)$/);return r&&(l=l+(r[1]||""),u=r[2],d=(r[3]||"")+d),{head:l,body:u,tail:d}},filter:function(e,n,s,o){let{tag:a,query:l}=e,u=l.body;return a.key.indexOf(u)>-1}};compare(e,n){return F(e,n)}stop(e){let n=this._stop;n?.(e)}set(e){let n=e.query.head.length+e.tag.value.length,s=e.query.head.length+e.tag.value.length,o=e.query.head+e.tag.value+e.query.tail,a={short:n,long:s,value:o};this.parent.setState(a)}};var me=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:a,shiftKey:l}=S(t);if(!(a&&!o&&s==="Enter"))return;t.preventDefault();let{short:d,long:r,dir:i,isReversed:c}=e.getState(),g=I(n),p=g.filter(m=>m.isSelected),h=t.shiftKey?p[0]:p[p.length-1],y=g[g.length-1].index===p[p.length-1].index,f=[],v=d,w=r;for(let m of g){if(!(h.index===m.index)){f.push(m.value);continue}l?(f.push(`
`+m.value),v=m.startIndex,w=m.startIndex):(f.push(m.value+`
`),v=m.endIndex,w=m.endIndex)}!l&&y&&(v+=1,w+=1),e.addHistory(),e.setState({isReversed:!1,short:v,long:w,dir:"none",value:f.join("")}),e.addHistory()},D=class t extends x{constructor(e){super(e,t.name)}onKeydown=me;static name="LineBreak";static defaults={}};var pe=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:a,shiftKey:l}=S(t);if(!(a&&!o&&l&&s.toLowerCase()==="k"))return;t.preventDefault();let d=I(n),r=d.filter(f=>f.isSelected),i=r[0],c=[],g=0,p=0;for(let f of d)f.isSelected||(f.index===i.index-1&&(g=f.startIndex,p=f.startIndex),c.push(f.value));let h=c.join("");r.length===1&&r[0].value===""&&d[d.length-1].index===r[0].index&&(h=h.substring(0,h.length-1)),e.addHistory(),e.setState({isReversed:!1,short:g,long:p,dir:"none",value:h}),e.addHistory()},j=class t extends x{constructor(e){super(e,t.name)}onKeydown=pe;static name="LineRemove";static defaults={}};var ge=!!navigator.clipboard?.writeText,ve=async function(t){if(t.defaultPrevented)return;if(!ge){console.warn("navigator.clipboard.writeText not found");return}let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:a,shiftKey:l}=S(t),{short:u,long:d,dir:r,isReversed:i}=e.getState();if(!(!(u!==d)&&a&&!o&&!l&&s.toLowerCase()==="x"))return;t.preventDefault();let p=I(n),h="",y=[],f=u,v=d;for(let w of p)w.isSelected?(f=w.startIndex,v=w.startIndex,h=w.value):y.push(w.value);h&&(h.endsWith(`
`)||(h+=`
`),await navigator.clipboard.writeText(h),e.addHistory(),e.setState({isReversed:!1,short:f,long:v,dir:"none",value:y.join("")}),e.addHistory())},q=class t extends x{constructor(e){super(e,t.name)}onKeydownAsync=ve;static name="LineCut";static defaults={}};var ye=!!navigator.clipboard?.writeText,we=async function(t){if(t.defaultPrevented)return;if(!ye){console.warn("navigator.clipboard.writeText not found");return}let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:a,shiftKey:l}=S(t),{short:u,long:d,dir:r,isReversed:i}=e.getState();if(!(!(u!==d)&&a&&!o&&!l&&s.toLowerCase()==="c"))return;t.preventDefault();let h=I(n).find(y=>y.isSelected)?.value;h&&(h.endsWith(`
`)||(h+=`
`),await navigator.clipboard.writeText(h))},z=class t extends x{constructor(e){super(e,t.name)}onKeydownAsync=we;static name="LineCopy";static defaults={}};var xe=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{short:s,long:o,dir:a,isReversed:l}=e.getState();if(!!(s!==o))return;let r=t.clipboardData?.getData("text");if(!r)return;r=r.replace(/\r\n|\r/g,`
`);let i=r.split(`
`),c=i.length===2,g=i[i.length-1]==="";if(!c||!g)return;t.preventDefault();let p=I(n),h=[],y=s+r.length,f=o+r.length;for(let v of p)v.isSelected&&h.push(r),h.push(v.value);e.addHistory(),e.setState({isReversed:l,short:y,long:f,dir:a,value:h.join("")}),e.addHistory()},U=class t extends x{constructor(e){super(e,t.name)}onPaste=xe;static name="LinePaste";static defaults={}};var Z=class{element;modules;moduleOrder;_keydownState;_keydownEvent;_keyupEvent;_pasteEvent;_focusEvent;_blurEvent;constructor(e){this.element=e,this.modules={},this.modules[P.name]=new P(this),this.modules[V.name]=new V(this),this.modules[G.name]=new G(this),this.modules[D.name]=new D(this),this.modules[j.name]=new j(this),this.modules[q.name]=new q(this),this.modules[z.name]=new z(this),this.modules[U.name]=new U(this),this.modules[H.name]=new H(this),this.modules[_.name]=new _(this),this.modules[O.name]=new O(this),this.moduleOrder=[],this._keydownState=null,this._keydownEvent=async s=>{for(let o of this.moduleOrder)o.onKeydown?.call(o,s),await o.onKeydownAsync?.call(o,s);s.defaultPrevented?this._clearKeydownState():["Meta","Control","Alt","Shift"].includes(s.key)||this._setKeydownState(s)},this._keyupEvent=async s=>{for(let o of this.moduleOrder)o.onKeyup?.call(o,s),await o.onKeyupAsync?.call(o,s)},this._pasteEvent=async s=>{for(let o of this.moduleOrder)o.onPaste?.call(o,s),await o.onPasteAsync?.call(o,s)};let n=s=>{this.addHistory(!1)};this._focusEvent=s=>{setTimeout(()=>{this.addHistory(!1),this.element.addEventListener("pointerup",n,!0)},0)},this._blurEvent=s=>{this.element.removeEventListener("pointerup",n,!0)},this.element.addEventListener("keydown",this._keydownEvent,!0),this.element.addEventListener("keyup",this._keyupEvent,!0),this.element.addEventListener("paste",this._pasteEvent,!0),this.element.addEventListener("focus",this._focusEvent,!0),this.element.addEventListener("blur",this._blurEvent,!0),this.initModuleOrder()}initModuleOrder(){this.moduleOrder=Object.values(this.modules).sort((e,n)=>e.index-n.index)}getModule(e){return this.modules[e]}setModule(e){this.modules[e.name]=e,this.initModuleOrder()}removeModule(e){this.modules[e]&&(delete this.modules[e],this.initModuleOrder())}getState(e){return B(this.element,e)}setState(e){W(this.element,e)}addHistory(e=!0){this.getModule(P.name)?.add(e)}_clearKeydownState(){this._keydownState=null}_setKeydownState(e){this._keydownState={value:this.element.value,state:B(this.element),key:e.key}}destroy(){this.element.removeEventListener("keydown",this._keydownEvent),this.element.removeEventListener("keyup",this._keyupEvent),this.element.removeEventListener("paste",this._pasteEvent),this.element.removeEventListener("focus",this._focusEvent),this.element.removeEventListener("blur",this._blurEvent)}};export{O as AutoCompleteModule,H as AutoIndentModule,_ as AutoPairModule,V as CommentModule,P as HistoryModule,G as IndentModule,D as LineBreakModule,z as LineCopyModule,q as LineCutModule,U as LinePasteModule,j as LineRemoveModule,Z as MTGA,x as MTGAModule};
