var T=function(e,t){let n=e.selectionStart>e.selectionEnd,r=Math.min(e.selectionStart,e.selectionEnd),o=Math.max(e.selectionStart,e.selectionEnd),a=e.selectionDirection;return t?{isReversed:n,short:r,long:o,dir:a,value:e.value}:{isReversed:n,short:r,long:o,dir:a}},v=function(e,t){t.value&&(e.value=t.value),t.isReversed?e.setSelectionRange(t.long,t.short,t.dir||"none"):e.setSelectionRange(t.short,t.long,t.dir||"none"),e.focus()},S=function(e){let t=e.key,n=e.altKey,r=e.shiftKey,o=e.ctrlKey||e.metaKey;return{key:t,altKey:n,shiftKey:r,ctrlKey:o}};function V(e,t){let n=Array.from({length:e.length+1},()=>Array(t.length+1).fill(0));for(let c=1;c<=e.length;c++)for(let f=1;f<=t.length;f++)e[c-1]===t[f-1]?n[c][f]=n[c-1][f-1]+1:n[c][f]=Math.max(n[c-1][f],n[c][f-1]);let r=[],o=0,a=e.length,s=t.length,i=null,u=[],h=function(){i!==null&&u.length>0&&r.push([i,u.reverse().join("")]),i=null,u=[]};for(;a>0||s>0;){let c=e[a-1],f=t[s-1];a>0&&s>0&&c===f?(i!==0&&h(),i=0,u.push(c),o++,a--,s--):s>0&&(a===0||n[a][s-1]>=n[a-1][s])?(i!==1&&h(),i=1,u.push(f),s--):a>0&&(i!==-1&&h(),i=-1,u.push(c),a--)}return h(),{accuracy:o*2/(e.length+t.length),score:o,match:r.reverse()}}var R=function(e){let{short:t,long:n}=T(e),r=e.value.split(/\n/),o=[],a=[],s=0;for(let i=0;i<r.length;i++){let u=r[i],c=i===r.length-1?u:u+`
`,f=s,y=s+u.length+1,d=-1,l=-1,m="";t>=f&&t<y&&(d=t-f),n>f&&n<y&&(l=n-f),t<=f&&n>=y&&(d=0,l=c.length),d>-1&&l===-1&&(l=c.length),l>-1&&d===-1&&(d=0);let g=d>-1&&l>-1;g&&(m=c.substring(d,l));let x={rowIndex:i,startIndex:f,endIndex:y,value:c,selectionStart:d,selectionEnd:l,selectionValue:m};o.push(x),g&&a.push(x),s=y}return{rows:o,selectedRows:a}},C=function(e,t,n){let{short:r,long:o,dir:a,isReversed:s}=T(e),i=r,u=o,h=[];for(let c of t){let{startIndex:f,endIndex:y}=c,d=c.value,l=n(c),m=l.length-d.length;r>=f&&r<y?m>=0?(i+=m,u+=m):(i+=Math.max(m,f-r),u+=Math.max(m,f-o)):o>=f&&r<y?m>=0?u+=m:u+=Math.max(m,f-o):u+=m,h.push(l)}return{isReversed:s,short:i,long:u,dir:a,value:h.join("")}};var _=function(e,t){return Object.keys(e).includes(t)};var G=function(e,t){return e[t]},H=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:r,shiftKey:o}=S(e),a=this.element,s=this.pairify.pairs;if(!(!r&&!n&&_(s,t)))return;e.preventDefault();let{short:u,long:h,dir:c,isReversed:f}=T(a),y=u!==h,d=t,l=G(s,d),m=a.value.substring(0,u),g=a.value.substring(u,h),x=a.value.substring(h),p,K,I;if(y)I=m+d+g+l+x,p=(m+d).length,K=(m+d+g).length;else{let b=(m+d).length;I=m+d+l+x,p=b,K=b}v(a,{isReversed:f,short:p,long:K,dir:c,value:I}),this.history.add()},L=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:r,shiftKey:o}=S(e);if(!(!r&&!n&&!o&&t==="Backspace"))return;let s=this.element,i=this.pairify.pairs,{short:u,long:h,dir:c,isReversed:f}=T(s);if(u!==h)return;let d=s.value.charAt(h-1),l=G(i,d);if(!(_(i,d)&&G(i,d)===l))return;e.preventDefault();let g=s.value.substring(0,h-1),x=s.value.substring(h+1),p=g+x,K=g.length,I=g.length;v(s,{isReversed:!1,short:K,long:I,dir:"forward",value:p}),this.history.add()},w=class e{parent;pairs;constructor(t){this.parent=t,this.pairs={...e.defaults.pairs},t.modules.push({name:"ClosePair",onKeydown:H},{name:"ClearPair",onKeydown:L})}static defaults={pairs:{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}}};var j=function(e){for(let t of e)if(t.value.startsWith("//"))return!0;return!1},q=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:r,shiftKey:o}=S(e);if(!(r&&!n&&!o&&t==="/"))return;e.preventDefault();let s=this.element,{pattern:i,value:u}=this.commentify,{rows:h,selectedRows:c}=R(s),f=c.length>1,y=j(c),d=C(s,h,l=>{if(!(l.selectionStart>-1||l.selectionEnd>-1))return l.value;if(f){let g=!l.value.trim();return y?l.value.replace(i,""):g?l.value:u+l.value}else return y?l.value.replace(i,""):u+l.value});v(s,d),this.history.add()},k=class e{parent;pattern;value;constructor(t){this.parent=t,this.pattern=e.defaults.pattern,this.value=e.defaults.value,t.modules.push({name:"Commentify",onKeydown:q})}static defaults={pattern:/^\/\/\s?/,value:"// "}};var D=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:r,shiftKey:o}=S(e);if(!(!r&&!n&&t==="Tab"))return;e.preventDefault();let s=this.element,{pattern:i,value:u}=this.indentify,{rows:h,selectedRows:c}=R(s),f=c.length>1,y=e.shiftKey,d=C(s,h,l=>{if(!(l.selectionStart>-1||l.selectionEnd>-1))return l.value;if(f){let g=!l.value.trim();return y?l.value.replace(i,""):g?l.value:u+l.value}else return y?l.value.replace(i,""):u+l.value});v(s,d),this.history.add()},E=class e{parent;pattern;value;constructor(t){this.parent=t,this.pattern=e.defaults.pattern,this.value=e.defaults.value,t.modules.push({name:"Indentify",onKeydown:D})}static defaults={pattern:/^[^\S\n\r][^\S\n\r]?/,value:"  "}};var z=function(e,t){for(let n of e)if(n.pattern.test(t))return n},O=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:r,shiftKey:o}=S(e);if(!(!r&&(t.length===1||t==="Backspace")))return;let s=this.tagify;s.stop(!0);let i=s._requestId+1,u=s._chunkSize,h=[],c=!1,f=!1,y=0,d=p=>{c=!0,f=p||!1};s._requestId=i,s._stop=d;let l=s.parser.call(this,this.element),m=l.body,g=[];if(m){let p=z(s.indexes,m);p?g=p.tags:g=s.tags}let x=()=>{let p=[],K=y+u;for(;y<K&&y<g.length;){let b={tag:g[y],query:l};s.filter?.call(this,b,y,g,h)&&(p.push(b),h.push(b)),y++}if(!(f||s._requestId!==i)){if(c||y>=g.length){s.onData?.call(this,p,h),s.onEnd?.call(this,h);return}s.onData?.call(this,p,h),setTimeout(x,0)}};x()},M=class e{parent;tags;indexes;parser;filter;onData;onEnd;_requestId;_chunkSize;_stop;constructor(t){this.parent=t,this.tags=[],this.indexes=[],this.parser=e.defaults.parser,this.filter=e.defaults.filter,this.onData=()=>{},this.onEnd=()=>{},this._requestId=0,this._chunkSize=e.defaults.chunkSize,this._stop=()=>{},t.modules.push({name:"Tagify",onKeyup:O})}static defaults={chunkSize:100,parser:t=>{let n=t.value.split(/[,.․‧・｡。{}()<>[\]\\/|'"`!?]|\r\n|\r|\n/),r=t.selectionStart,o=0,a=0;for(let c of n){if(a=o+c.length,r>=o&&r<=a)break;o=a+1}let s=t.value.substring(0,o),i=t.value.substring(o,a),u=t.value.substring(a),h=i.match(/^(\s*)(.*?)(\s*)$/);return h&&(s=s+(h[1]||""),i=h[2],u=(h[3]||"")+u),{head:s,body:i,tail:u}},filter:()=>!0};compare(t,n){return V(t,n)}stop(t){let n=this._stop;n?.(t)}set(t){let n=t.query.head.length+t.tag.value.length,r=t.query.head.length+t.tag.value.length,o=t.query.head+t.tag.value+t.query.tail,a={short:n,long:r,value:o};v(this.parent.element,a)}};var Q=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:r,shiftKey:o}=S(e);if(!(r&&!n&&!o&&t.toLowerCase()==="z"))return;e.preventDefault();let s=this.element,i=this.history.prev();i&&v(s,i)},B=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:r,shiftKey:o}=S(e);if(!(r&&!n&&o&&t.toLowerCase()==="z"))return;e.preventDefault();let s=this.element,i=this.history.next();i&&v(s,i)},U=function(e){let t=this._keydownState;if(this._clearKeydownState(),!t)return;let n=this.element;if(t.value!==n.value)this.history.add();else{let o=t.state,a=T(n);(o.short!==a.short||o.long!==a.long)&&this.history.add(!1)}},A=class e{parent;items;index;maxCount;constructor(t){this.parent=t,this.items=[],this.index=1,this.maxCount=e.defaults.maxCount,t.modules.push({name:"Undo",onKeydown:Q},{name:"Redo",onKeydown:B},{name:"History",onKeyup:U})}static defaults={maxCount:390};prune(){this.index>1&&(this.items=this.items.slice(0,this.items.length-(this.index-1)),this.index=1)}add(t=!0){let n=this.parent.element;if(t)this.prune();else if(this.index!==1)return;let r=T(n,!0);this.items.push(r),this.items.length>this.maxCount&&this.items.shift()}prev(){return this.index<this.items.length&&(this.index+=1),this.curr()}next(){return this.index>1&&(this.index-=1),this.curr()}curr(){return this.items[this.items.length-this.index]}};var P=class{element;modules;_keydownState;_keydownEvent;_keyupEvent;_mouseupEvent;constructor(t){this.element=t,this.modules=[],this.history=new A(this),this.commentify=new k(this),this.indentify=new E(this),this.pairify=new w(this),this.tagify=new M(this),this._keydownState=null,this._keydownEvent=n=>{for(let r of this.modules)if(r.onKeydown?.call(this,n),n.defaultPrevented){this._clearKeydownState();return}["Meta","Control","Alt","Shift"].includes(n.key)||this._setKeydownState(n)},this._keyupEvent=n=>{let r=this.element;for(let s of this.modules)if(s.onKeyup?.call(this,n),n.defaultPrevented)break;let o=this._keydownState;if(this._clearKeydownState(),!o)return;if(o.value!==r.value)this.history.add();else{let s=o.state,i=T(r);(s.short!==i.short||s.long!==i.long)&&this.history.add(!1)}},this._mouseupEvent=n=>{this.history.add(!1)},this.element.addEventListener("keydown",this._keydownEvent,!0),this.element.addEventListener("keyup",this._keyupEvent,!0),this.element.addEventListener("mouseup",this._mouseupEvent,!0)}getState(t){return T(this.element,t)}setState(t){v(this.element,t)}_clearKeydownState(){this._keydownState=null}_setKeydownState(t){this._keydownState={value:this.element.value,state:T(this.element),key:t.key}}};export{k as Commentify,A as History,E as Indentify,P as MTGA,w as Pairify,M as Tagify};
