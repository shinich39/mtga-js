var K=function(t,e){let s=t.selectionStart>t.selectionEnd,r=Math.min(t.selectionStart,t.selectionEnd),u=Math.max(t.selectionStart,t.selectionEnd),a=t.selectionDirection;return e?{isReversed:s,short:r,long:u,dir:a,value:t.value}:{isReversed:s,short:r,long:u,dir:a}},S=function(t,e){typeof e.value=="string"&&(t.value=e.value),e.isReversed?t.setSelectionRange(e.long,e.short,e.dir||"none"):t.setSelectionRange(e.short,e.long,e.dir||"none"),t.focus()},I=function(t){let e=t.key,s=t.altKey,r=t.shiftKey,u=t.ctrlKey||t.metaKey;return{key:e,altKey:s,shiftKey:r,ctrlKey:u}};function q(t,e){let s=Array.from({length:t.length+1},()=>Array(e.length+1).fill(0));for(let o=1;o<=t.length;o++)for(let c=1;c<=e.length;c++)t[o-1]===e[c-1]?s[o][c]=s[o-1][c-1]+1:s[o][c]=Math.max(s[o-1][c],s[o][c-1]);let r=[],u=0,a=t.length,n=e.length,i=null,f=[],l=function(){i!==null&&f.length>0&&r.push([i,f.reverse().join("")]),i=null,f=[]};for(;a>0||n>0;){let o=t[a-1],c=e[n-1];a>0&&n>0&&o===c?(i!==0&&l(),i=0,f.push(o),u++,a--,n--):n>0&&(a===0||s[a][n-1]>=s[a-1][n])?(i!==1&&l(),i=1,f.push(c),n--):a>0&&(i!==-1&&l(),i=-1,f.push(o),a--)}return l(),{accuracy:u*2/(t.length+e.length),score:u,match:r.reverse()}}var E=function(t){let{short:e,long:s}=K(t),r=t.value.split(/\n/),u=[],a=0;for(let n=0;n<r.length;n++){let i=r[n],f=n===r.length-1,l=f?i:i+`
`,o=a,c=o+l.length,h=-1,d=-1,w="";e>=o&&e<c&&(h=e-o),s>o&&(f?s<=c:s<c)&&(d=s-o),e<=o&&s>=c&&(h=0,d=l.length),h>-1&&d===-1&&(d=l.length),d>-1&&h===-1&&(h=0);let m=h>-1&&d>-1;m&&(w=l.substring(h,d));let v={isSelected:m,index:n,startIndex:o,endIndex:c,value:l,selectionStart:h,selectionEnd:d,selectionValue:w};u.push(v),a=c}return u};var z=function(t,e){return Object.keys(t).includes(e)};var D=function(t,e){return t[e]},Q=function(t){if(t.defaultPrevented)return;let{key:e,altKey:s,ctrlKey:r,shiftKey:u}=I(t),a=this.element,n=this.pairify.pairs;if(!(!r&&!s&&z(n,e)))return;t.preventDefault();let{short:f,long:l,dir:o,isReversed:c}=K(a),h=f!==l,d=e,w=D(n,d),m=a.value.substring(0,f),v=a.value.substring(f,l),g=a.value.substring(l),y,b,x;if(h)x=m+d+v+w+g,y=(m+d).length,b=(m+d+v).length;else{let p=(m+d).length;x=m+d+w+g,y=p,b=p}S(a,{isReversed:c,short:y,long:b,dir:o,value:x}),this.history.add()},U=function(t){if(t.defaultPrevented)return;let{key:e,altKey:s,ctrlKey:r,shiftKey:u}=I(t);if(!(!r&&!s&&!u&&e==="Backspace"))return;let n=this.element,i=this.pairify.pairs,{short:f,long:l,dir:o,isReversed:c}=K(n);if(f!==l)return;let d=n.value.charAt(l-1),w=D(i,d);if(!(z(i,d)&&D(i,d)===w))return;t.preventDefault();let v=n.value.substring(0,l-1),g=n.value.substring(l+1),y=v+g,b=v.length,x=v.length;S(n,{isReversed:!1,short:b,long:x,dir:"forward",value:y}),this.history.add()},R=class t{parent;pairs;constructor(e){this.parent=e,this.pairs={...t.defaults.pairs},e.modules.push({name:"ClosePair",onKeydown:Q},{name:"ClearPair",onKeydown:U})}static defaults={pairs:{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}}};var W=function(t){for(let e of t)if(e.value.startsWith("//"))return!0;return!1},$=function(t){if(t.defaultPrevented)return;let{key:e,altKey:s,ctrlKey:r,shiftKey:u}=I(t);if(!(r&&!s&&!u&&e==="/"))return;t.preventDefault();let n=this.element,{pattern:i,value:f}=this.commentify,l=E(n),{short:o,long:c,dir:h,isReversed:d}=K(n),w=l.filter(x=>x.isSelected),m=w.length>1,v=W(w),g=o,y=c,b=[];for(let x=0;x<l.length;x++){let p=l[x],{startIndex:M,endIndex:A}=p,j=p.value;if(!p.isSelected){b.push(p.value);continue}let k;if(m){let H=!p.value.trim();v?k=p.value.replace(i,""):H?k=p.value:k=f+p.value}else v?k=p.value.replace(i,""):k=f+p.value;let T=k.length-j.length;o>=M&&o<A?T>=0?(g+=T,y+=T):(g+=Math.max(T,M-o),y+=Math.max(T,M-c)):c>=M&&o<A?T>=0?y+=T:y+=Math.max(T,M-c):(g+=T,y+=T),b.push(k)}S(n,{isReversed:d,short:g,long:y,dir:h,value:b.join("")}),this.history.add()},G=class t{parent;pattern;value;constructor(e){this.parent=e,this.pattern=t.defaults.pattern,this.value=t.defaults.value,e.modules.push({name:"Commentify",onKeydown:$})}static defaults={pattern:/^\/\/\s?/,value:"// "}};var F=function(t){if(t.defaultPrevented)return;let{key:e,altKey:s,ctrlKey:r,shiftKey:u}=I(t);if(!(!r&&!s&&e==="Tab"))return;t.preventDefault();let n=this.element,{pattern:i,value:f}=this.indentify,l=E(n),{short:o,long:c,dir:h,isReversed:d}=K(n),m=l.filter(x=>x.isSelected).length>1,v=t.shiftKey,g=o,y=c,b=[];for(let x=0;x<l.length;x++){let p=l[x],{startIndex:M,endIndex:A}=p,j=p.value;if(!p.isSelected){b.push(p.value);continue}let k;if(m){let H=!p.value.trim();v?k=p.value.replace(i,""):H?k=p.value:k=f+p.value}else v?k=p.value.replace(i,""):k=f+p.value;let T=k.length-j.length;o>=M&&o<A?T>=0?(g+=T,y+=T):(g+=Math.max(T,M-o),y+=Math.max(T,M-c)):c>=M&&o<A?T>=0?y+=T:y+=Math.max(T,M-c):(g+=T,y+=T),b.push(k)}S(n,{isReversed:d,short:g,long:y,dir:h,value:b.join("")}),this.history.add()},V=class t{parent;pattern;value;constructor(e){this.parent=e,this.pattern=t.defaults.pattern,this.value=t.defaults.value,e.modules.push({name:"Indentify",onKeydown:F})}static defaults={pattern:/^[^\S\n\r][^\S\n\r]?/,value:"  "}};var J=function(t,e){for(let s of t)if(s.pattern.test(e))return s},N=function(t){if(t.defaultPrevented)return;let{key:e,altKey:s,ctrlKey:r,shiftKey:u}=I(t);if(!(!r&&(e.length===1||e==="Backspace")))return;let n=this.tagify;n.stop(!0);let i=n._requestId+1,f=n._chunkSize,l=[],o=!1,c=!1,h=0,d=y=>{o=!0,c=y||!1};n._requestId=i,n._stop=d;let w=n.parser.call(this,this.element),m=w.body,v=[];if(m){let y=J(n.indexes,m);y?v=y.tags:v=n.tags}let g=()=>{let y=[],b=h+f;for(;h<b&&h<v.length;){let p={tag:v[h],query:w};n.filter?.call(this,p,h,v,l)&&(y.push(p),l.push(p)),h++}if(!(c||n._requestId!==i)){if(o||h>=v.length){n.onData?.call(this,y,l),n.onEnd?.call(this,l);return}n.onData?.call(this,y,l),setTimeout(g,0)}};g()},C=class t{parent;tags;indexes;parser;filter;onData;onEnd;_requestId;_chunkSize;_stop;constructor(e){this.parent=e,this.tags=[],this.indexes=[],this.parser=t.defaults.parser,this.filter=t.defaults.filter,this.onData=()=>{},this.onEnd=()=>{},this._requestId=0,this._chunkSize=t.defaults.chunkSize,this._stop=()=>{},e.modules.push({name:"Tagify",onKeyup:N})}static defaults={chunkSize:100,parser:e=>{let s=e.value.split(/[,.․‧・｡。{}()<>[\]\\/|'"`!?]|\r\n|\r|\n/),r=e.selectionStart,u=0,a=0;for(let o of s){if(a=u+o.length,r>=u&&r<=a)break;u=a+1}let n=e.value.substring(0,u),i=e.value.substring(u,a),f=e.value.substring(a),l=i.match(/^(\s*)(.*?)(\s*)$/);return l&&(n=n+(l[1]||""),i=l[2],f=(l[3]||"")+f),{head:n,body:i,tail:f}},filter:()=>!0};compare(e,s){return q(e,s)}stop(e){let s=this._stop;s?.(e)}set(e){let s=e.query.head.length+e.tag.value.length,r=e.query.head.length+e.tag.value.length,u=e.query.head+e.tag.value+e.query.tail,a={short:s,long:r,value:u};S(this.parent.element,a)}};var X=function(t){if(t.defaultPrevented)return;let{key:e,altKey:s,ctrlKey:r,shiftKey:u}=I(t);if(!(r&&!s&&!u&&e.toLowerCase()==="z"))return;t.preventDefault();let n=this.element,i=this.history.prev();i&&S(n,i)},Y=function(t){if(t.defaultPrevented)return;let{key:e,altKey:s,ctrlKey:r,shiftKey:u}=I(t);if(!(r&&!s&&u&&e.toLowerCase()==="z"))return;t.preventDefault();let n=this.element,i=this.history.next();i&&S(n,i)},Z=function(t){let e=this._keydownState;if(this._clearKeydownState(),!e)return;let s=this.element;if(e.value!==s.value)this.history.add();else{let u=e.state,a=K(s);(u.short!==a.short||u.long!==a.long)&&this.history.add(!1)}},_=class t{parent;items;index;maxCount;constructor(e){this.parent=e,this.items=[],this.index=1,this.maxCount=t.defaults.maxCount,e.modules.push({name:"Undo",onKeydown:X},{name:"Redo",onKeydown:Y},{name:"History",onKeyup:Z})}static defaults={maxCount:390};prune(){this.index>1&&(this.items=this.items.slice(0,this.items.length-(this.index-1)),this.index=1)}add(e=!0){let s=this.parent.element;if(e)this.prune();else if(this.index!==1)return;let r=K(s,!0);this.items.push(r),this.items.length>this.maxCount&&this.items.shift()}prev(){return this.index<this.items.length&&(this.index+=1),this.curr()}next(){return this.index>1&&(this.index-=1),this.curr()}curr(){return this.items[this.items.length-this.index]}};var ee=function(t){if(t.defaultPrevented)return;let{key:e,altKey:s,ctrlKey:r,shiftKey:u}=I(t);if(!(r&&!s&&e==="Enter"))return;t.preventDefault();let n=this.element,{short:i,long:f,dir:l,isReversed:o}=K(n),c=E(n),h=c.filter(g=>g.isSelected),d=t.shiftKey?h[0]:h[h.length-1],w=[],m=i,v=f;for(let g of c){if(!(d.index===g.index)){w.push(g.value);continue}t.shiftKey?(w.push(`
`+g.value),m=g.startIndex,v=g.startIndex):(w.push(g.value+`
`),m=g.endIndex,v=g.endIndex)}S(n,{isReversed:!1,short:m,long:v,dir:"none",value:w.join("")}),this.history.add()},L=class{parent;constructor(e){this.parent=e,e.modules.push({name:"Breakify",onKeydown:ee})}static defaults={}};var te=function(t){if(t.defaultPrevented)return;let{key:e,altKey:s,ctrlKey:r,shiftKey:u}=I(t);if(!(r&&!s&&u&&e.toLowerCase()==="k"))return;t.preventDefault();let n=this.element,i=E(n),f=i.filter(m=>m.isSelected),l=f[0],o=[],c=0,h=0;for(let m of i)m.isSelected||(m.index===l.index-1&&(c=m.startIndex,h=m.startIndex),o.push(m.value));let d=o.join("");f.length===1&&f[0].value===""&&i[i.length-1].index===f[0].index&&(d=d.substring(0,d.length-1)),S(n,{isReversed:!1,short:c,long:h,dir:"none",value:d}),this.history.add()},P=class{parent;constructor(e){this.parent=e,e.modules.push({name:"Removify",onKeydown:te})}static defaults={}};var B=class{element;modules;_keydownState;_keydownEvent;_keyupEvent;_mouseupEvent;constructor(e){this.element=e,this.modules=[],this.history=new _(this),this.commentify=new G(this),this.indentify=new V(this),this.breakify=new L(this),this.removify=new P(this),this.pairify=new R(this),this.tagify=new C(this),this._keydownState=null,this._keydownEvent=s=>{for(let r of this.modules)if(r.onKeydown?.call(this,s),s.defaultPrevented){this._clearKeydownState();return}["Meta","Control","Alt","Shift"].includes(s.key)||this._setKeydownState(s)},this._keyupEvent=s=>{let r=this.element;for(let n of this.modules)if(n.onKeyup?.call(this,s),s.defaultPrevented)break;let u=this._keydownState;if(this._clearKeydownState(),!u)return;if(u.value!==r.value)this.history.add();else{let n=u.state,i=K(r);(n.short!==i.short||n.long!==i.long)&&this.history.add(!1)}},this._mouseupEvent=s=>{this.history.add(!1)},this.element.addEventListener("keydown",this._keydownEvent,!0),this.element.addEventListener("keyup",this._keyupEvent,!0),this.element.addEventListener("mouseup",this._mouseupEvent,!0)}getState(e){return K(this.element,e)}setState(e){S(this.element,e)}_clearKeydownState(){this._keydownState=null}_setKeydownState(e){this._keydownState={value:this.element.value,state:K(this.element),key:e.key}}};export{L as Breakify,G as Commentify,_ as History,V as Indentify,B as MTGA,R as Pairify,P as Removify,C as Tagify};
