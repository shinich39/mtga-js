var x=function(t,e){let s=t.selectionStart>t.selectionEnd,o=Math.min(t.selectionStart,t.selectionEnd),a=Math.max(t.selectionStart,t.selectionEnd),r=t.selectionDirection;return e?{isReversed:s,short:o,long:a,dir:r,value:t.value}:{isReversed:s,short:o,long:a,dir:r}},K=function(t,e){e.value&&(t.value=e.value),e.isReversed?t.setSelectionRange(e.long,e.short,e.dir||"none"):t.setSelectionRange(e.short,e.long,e.dir||"none"),t.focus()},b=function(t){let e=t.key,s=t.altKey,o=t.shiftKey,a=t.ctrlKey||t.metaKey;return{key:e,altKey:s,shiftKey:o,ctrlKey:a}};function q(t,e){let s=Array.from({length:t.length+1},()=>Array(e.length+1).fill(0));for(let c=1;c<=t.length;c++)for(let l=1;l<=e.length;l++)t[c-1]===e[l-1]?s[c][l]=s[c-1][l-1]+1:s[c][l]=Math.max(s[c-1][l],s[c][l-1]);let o=[],a=0,r=t.length,n=e.length,i=null,h=[],u=function(){i!==null&&h.length>0&&o.push([i,h.reverse().join("")]),i=null,h=[]};for(;r>0||n>0;){let c=t[r-1],l=e[n-1];r>0&&n>0&&c===l?(i!==0&&u(),i=0,h.push(c),a++,r--,n--):n>0&&(r===0||s[r][n-1]>=s[r-1][n])?(i!==1&&u(),i=1,h.push(l),n--):r>0&&(i!==-1&&u(),i=-1,h.push(c),r--)}return u(),{accuracy:a*2/(t.length+e.length),score:a,match:o.reverse()}}var E=function(t){let{short:e,long:s}=x(t),o=t.value.split(/\n/),a=[],r=[],n=0;for(let i=0;i<o.length;i++){let h=o[i],c=i===o.length-1?h:h+`
`,l=n,f=n+h.length+1,g=-1,v=-1,T="";e>=l&&e<f&&(g=e-l),s>l&&s<f&&(v=s-l),e<=l&&s>=f&&(g=0,v=c.length),g>-1&&v===-1&&(v=c.length),v>-1&&g===-1&&(g=0);let p=g>-1&&v>-1;p&&(T=c.substring(g,v));let m={rowIndex:i,startIndex:l,endIndex:f,value:c,selectionStart:g,selectionEnd:v,selectionValue:T};a.push(m),p&&r.push(m),n=f}return{rows:a,selectedRows:r}};var D=function(t,e){return Object.keys(t).includes(e)};var H=function(t,e){return t[e]},B=function(t){if(t.defaultPrevented)return;let{key:e,altKey:s,ctrlKey:o,shiftKey:a}=b(t),r=this.element,n=this.pairify.pairs;if(!(!o&&!s&&D(n,e)))return;t.preventDefault();let{short:h,long:u,dir:c,isReversed:l}=x(r),f=h!==u,g=e,v=H(n,g),T=r.value.substring(0,h),p=r.value.substring(h,u),m=r.value.substring(u),y,S,M;if(f)M=T+g+p+v+m,y=(T+g).length,S=(T+g+p).length;else{let d=(T+g).length;M=T+g+v+m,y=d,S=d}K(r,{isReversed:l,short:y,long:S,dir:c,value:M}),this.history.add()},Q=function(t){if(t.defaultPrevented)return;let{key:e,altKey:s,ctrlKey:o,shiftKey:a}=b(t);if(!(!o&&!s&&!a&&e==="Backspace"))return;let n=this.element,i=this.pairify.pairs,{short:h,long:u,dir:c,isReversed:l}=x(n);if(h!==u)return;let g=n.value.charAt(u-1),v=H(i,g);if(!(D(i,g)&&H(i,g)===v))return;t.preventDefault();let p=n.value.substring(0,u-1),m=n.value.substring(u+1),y=p+m,S=p.length,M=p.length;K(n,{isReversed:!1,short:S,long:M,dir:"forward",value:y}),this.history.add()},R=class t{parent;pairs;constructor(e){this.parent=e,this.pairs={...t.defaults.pairs},e.modules.push({name:"ClosePair",onKeydown:B},{name:"ClearPair",onKeydown:Q})}static defaults={pairs:{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}}};var U=function(t){for(let e of t)if(e.value.startsWith("//"))return!0;return!1},W=function(t){if(t.defaultPrevented)return;let{key:e,altKey:s,ctrlKey:o,shiftKey:a}=b(t);if(!(o&&!s&&!a&&e==="/"))return;t.preventDefault();let n=this.element,{pattern:i,value:h}=this.commentify,{rows:u,selectedRows:c}=E(n),{short:l,long:f,dir:g,isReversed:v}=x(n),T=c.length>1,p=U(c),m=l,y=f,S=[];for(let M=0;M<u.length;M++){let d=u[M],{startIndex:k,endIndex:A}=d,L=d.value;if(!(d.selectionStart>-1||d.selectionEnd>-1)){S.push(d.value);continue}let I;if(T){let j=!d.value.trim();p?I=d.value.replace(i,""):j?I=d.value:I=h+d.value}else p?I=d.value.replace(i,""):I=h+d.value;let w=I.length-L.length;l>=k&&l<A?w>=0?(m+=w,y+=w):(m+=Math.max(w,k-l),y+=Math.max(w,k-f)):f>=k&&l<A?w>=0?y+=w:y+=Math.max(w,k-f):y+=w,S.push(I)}K(n,{isReversed:v,short:m,long:y,dir:g,value:S.join("")}),this.history.add()},G=class t{parent;pattern;value;constructor(e){this.parent=e,this.pattern=t.defaults.pattern,this.value=t.defaults.value,e.modules.push({name:"Commentify",onKeydown:W})}static defaults={pattern:/^\/\/\s?/,value:"// "}};var $=function(t){if(t.defaultPrevented)return;let{key:e,altKey:s,ctrlKey:o,shiftKey:a}=b(t);if(!(!o&&!s&&e==="Tab"))return;t.preventDefault();let n=this.element,{pattern:i,value:h}=this.indentify,{rows:u,selectedRows:c}=E(n),{short:l,long:f,dir:g,isReversed:v}=x(n),T=c.length>1,p=t.shiftKey,m=l,y=f,S=[];for(let M=0;M<u.length;M++){let d=u[M],{startIndex:k,endIndex:A}=d,L=d.value;if(!(d.selectionStart>-1||d.selectionEnd>-1)){S.push(d.value);continue}let I;if(T){let j=!d.value.trim();p?I=d.value.replace(i,""):j?I=d.value:I=h+d.value}else p?I=d.value.replace(i,""):I=h+d.value;let w=I.length-L.length;l>=k&&l<A?w>=0?(m+=w,y+=w):(m+=Math.max(w,k-l),y+=Math.max(w,k-f)):f>=k&&l<A?w>=0?y+=w:y+=Math.max(w,k-f):y+=w,S.push(I)}K(n,{isReversed:v,short:m,long:y,dir:g,value:S.join("")}),this.history.add()},V=class t{parent;pattern;value;constructor(e){this.parent=e,this.pattern=t.defaults.pattern,this.value=t.defaults.value,e.modules.push({name:"Indentify",onKeydown:$})}static defaults={pattern:/^[^\S\n\r][^\S\n\r]?/,value:"  "}};var F=function(t,e){for(let s of t)if(s.pattern.test(e))return s},J=function(t){if(t.defaultPrevented)return;let{key:e,altKey:s,ctrlKey:o,shiftKey:a}=b(t);if(!(!o&&(e.length===1||e==="Backspace")))return;let n=this.tagify;n.stop(!0);let i=n._requestId+1,h=n._chunkSize,u=[],c=!1,l=!1,f=0,g=y=>{c=!0,l=y||!1};n._requestId=i,n._stop=g;let v=n.parser.call(this,this.element),T=v.body,p=[];if(T){let y=F(n.indexes,T);y?p=y.tags:p=n.tags}let m=()=>{let y=[],S=f+h;for(;f<S&&f<p.length;){let d={tag:p[f],query:v};n.filter?.call(this,d,f,p,u)&&(y.push(d),u.push(d)),f++}if(!(l||n._requestId!==i)){if(c||f>=p.length){n.onData?.call(this,y,u),n.onEnd?.call(this,u);return}n.onData?.call(this,y,u),setTimeout(m,0)}};m()},C=class t{parent;tags;indexes;parser;filter;onData;onEnd;_requestId;_chunkSize;_stop;constructor(e){this.parent=e,this.tags=[],this.indexes=[],this.parser=t.defaults.parser,this.filter=t.defaults.filter,this.onData=()=>{},this.onEnd=()=>{},this._requestId=0,this._chunkSize=t.defaults.chunkSize,this._stop=()=>{},e.modules.push({name:"Tagify",onKeyup:J})}static defaults={chunkSize:100,parser:e=>{let s=e.value.split(/[,.․‧・｡。{}()<>[\]\\/|'"`!?]|\r\n|\r|\n/),o=e.selectionStart,a=0,r=0;for(let c of s){if(r=a+c.length,o>=a&&o<=r)break;a=r+1}let n=e.value.substring(0,a),i=e.value.substring(a,r),h=e.value.substring(r),u=i.match(/^(\s*)(.*?)(\s*)$/);return u&&(n=n+(u[1]||""),i=u[2],h=(u[3]||"")+h),{head:n,body:i,tail:h}},filter:()=>!0};compare(e,s){return q(e,s)}stop(e){let s=this._stop;s?.(e)}set(e){let s=e.query.head.length+e.tag.value.length,o=e.query.head.length+e.tag.value.length,a=e.query.head+e.tag.value+e.query.tail,r={short:s,long:o,value:a};K(this.parent.element,r)}};var N=function(t){if(t.defaultPrevented)return;let{key:e,altKey:s,ctrlKey:o,shiftKey:a}=b(t);if(!(o&&!s&&!a&&e.toLowerCase()==="z"))return;t.preventDefault();let n=this.element,i=this.history.prev();i&&K(n,i)},X=function(t){if(t.defaultPrevented)return;let{key:e,altKey:s,ctrlKey:o,shiftKey:a}=b(t);if(!(o&&!s&&a&&e.toLowerCase()==="z"))return;t.preventDefault();let n=this.element,i=this.history.next();i&&K(n,i)},Y=function(t){let e=this._keydownState;if(this._clearKeydownState(),!e)return;let s=this.element;if(e.value!==s.value)this.history.add();else{let a=e.state,r=x(s);(a.short!==r.short||a.long!==r.long)&&this.history.add(!1)}},_=class t{parent;items;index;maxCount;constructor(e){this.parent=e,this.items=[],this.index=1,this.maxCount=t.defaults.maxCount,e.modules.push({name:"Undo",onKeydown:N},{name:"Redo",onKeydown:X},{name:"History",onKeyup:Y})}static defaults={maxCount:390};prune(){this.index>1&&(this.items=this.items.slice(0,this.items.length-(this.index-1)),this.index=1)}add(e=!0){let s=this.parent.element;if(e)this.prune();else if(this.index!==1)return;let o=x(s,!0);this.items.push(o),this.items.length>this.maxCount&&this.items.shift()}prev(){return this.index<this.items.length&&(this.index+=1),this.curr()}next(){return this.index>1&&(this.index-=1),this.curr()}curr(){return this.items[this.items.length-this.index]}};var Z=function(t){if(t.defaultPrevented)return;let{key:e,altKey:s,ctrlKey:o,shiftKey:a}=b(t);if(!(o&&!s&&e==="Enter"))return;t.preventDefault();let n=this.element,{short:i,long:h,dir:u,isReversed:c}=x(n),{rows:l,selectedRows:f}=E(n),g=t.shiftKey?f[0]:f[f.length-1],v=[],T=i,p=h;for(let m of l){if(!(g.rowIndex===m.rowIndex)){v.push(m.value);continue}t.shiftKey?(v.push(`
`+m.value),T=m.startIndex,p=m.startIndex):(v.push(m.value+`
`),T=m.endIndex,p=m.endIndex)}K(n,{isReversed:!1,short:T,long:p,dir:"none",value:v.join("")}),this.history.add()},P=class{parent;constructor(e){this.parent=e,e.modules.push({name:"Breakify",onKeydown:Z})}static defaults={}};var z=class{element;modules;_keydownState;_keydownEvent;_keyupEvent;_mouseupEvent;constructor(e){this.element=e,this.modules=[],this.history=new _(this),this.commentify=new G(this),this.indentify=new V(this),this.breakify=new P(this),this.pairify=new R(this),this.tagify=new C(this),this._keydownState=null,this._keydownEvent=s=>{for(let o of this.modules)if(o.onKeydown?.call(this,s),s.defaultPrevented){this._clearKeydownState();return}["Meta","Control","Alt","Shift"].includes(s.key)||this._setKeydownState(s)},this._keyupEvent=s=>{let o=this.element;for(let n of this.modules)if(n.onKeyup?.call(this,s),s.defaultPrevented)break;let a=this._keydownState;if(this._clearKeydownState(),!a)return;if(a.value!==o.value)this.history.add();else{let n=a.state,i=x(o);(n.short!==i.short||n.long!==i.long)&&this.history.add(!1)}},this._mouseupEvent=s=>{this.history.add(!1)},this.element.addEventListener("keydown",this._keydownEvent,!0),this.element.addEventListener("keyup",this._keyupEvent,!0),this.element.addEventListener("mouseup",this._mouseupEvent,!0)}getState(e){return x(this.element,e)}setState(e){K(this.element,e)}_clearKeydownState(){this._keydownState=null}_setKeydownState(e){this._keydownState={value:this.element.value,state:x(this.element),key:e.key}}};export{G as Commentify,_ as History,V as Indentify,z as MTGA,R as Pairify,C as Tagify};
