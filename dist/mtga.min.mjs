var M=function(e,t){let n=e.selectionStart>e.selectionEnd,o=Math.min(e.selectionStart,e.selectionEnd),i=Math.max(e.selectionStart,e.selectionEnd),a=e.selectionDirection;return t?{isReversed:n,short:o,long:i,dir:a,value:e.value}:{isReversed:n,short:o,long:i,dir:a}},U=function(e,t){typeof t.value=="string"&&(e.value=t.value),t.isReversed?e.setSelectionRange(t.long,t.short,t.dir||"none"):e.setSelectionRange(t.short,t.long,t.dir||"none"),e.focus()},S=function(e){let t=e.key,n=e.altKey,o=e.shiftKey,i=e.ctrlKey||e.metaKey;return{key:t,altKey:n,shiftKey:o,ctrlKey:i}};function B(e,t){let n=Array.from({length:e.length+1},()=>Array(t.length+1).fill(0));for(let u=1;u<=e.length;u++)for(let c=1;c<=t.length;c++)e[u-1]===t[c-1]?n[u][c]=n[u-1][c-1]+1:n[u][c]=Math.max(n[u-1][c],n[u][c-1]);let o=[],i=0,a=e.length,s=t.length,r=null,d=[],l=function(){r!==null&&d.length>0&&o.push([r,d.reverse().join("")]),r=null,d=[]};for(;a>0||s>0;){let u=e[a-1],c=t[s-1];a>0&&s>0&&u===c?(r!==0&&l(),r=0,d.push(u),i++,a--,s--):s>0&&(a===0||n[a][s-1]>=n[a-1][s])?(r!==1&&l(),r=1,d.push(c),s--):a>0&&(r!==-1&&l(),r=-1,d.push(u),a--)}return l(),{accuracy:i*2/(e.length+t.length),score:i,match:o.reverse()}}var C=function(e){let{short:t,long:n}=M(e),o=e.value.split(/\n/),i=[],a=0;for(let s=0;s<o.length;s++){let r=o[s],d=s===o.length-1,l=d?r:r+`
`,u=a,c=u+l.length,h=-1,p=-1,v="";t>=u&&t<c&&(h=t-u),n>u&&(d?n<=c:n<c)&&(p=n-u),t<=u&&n>=c&&(h=0,p=l.length),h>-1&&p===-1&&(p=l.length),p>-1&&h===-1&&(h=0);let m={isSelected:h>-1&&p>-1,index:s,startIndex:u,endIndex:c,value:l,selectionStart:h,selectionEnd:p};i.push(m),a=c}return i};var I=class{parent;name;index;onKeydown;onKeyup;constructor(t,n,o=9999){this.parent=t,this.name=n,this.index=o}static defaults={}};var X=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:o,shiftKey:i}=S(e);if(!(o&&!n&&t.toLowerCase()==="z"))return;e.preventDefault();let s=this.getModule(L.name);if(!s){console.warn(`Module not found: ${L.name}`);return}let r;i?r=s.next():r=s.prev(),r&&this.setState(r)},Y=function(e){let t=this._keydownState;if(this._clearKeydownState(),!t)return;let n=this.element,o=t.value,i=n.value;if(o!==i)this.addHistory();else{let a=t.state,s=M(n);(a.short!==s.short||a.long!==s.long)&&this.addHistory(!1)}},L=class e extends I{items;maxCount;_i;constructor(t){super(t,e.name,0),this.items=[],this.maxCount=e.defaults.maxCount,this._i=1}static name="History";static defaults={maxCount:390};onKeydown=X;onKeyup=Y;prune(){this._i>1&&(this.items=this.items.slice(0,this.items.length-(this._i-1)),this._i=1)}add(t=!0){let n=this.parent.element;if(t)this.prune();else if(this._i!==1)return;let o=this.items[this.items.length-1],i=M(n,!0);(!o||o.short!==i.short||o.long!==i.long||o.value!==i.value)&&(this.items.push(i),this.items.length>this.maxCount&&this.items.shift())}prev(){return this._i<this.items.length&&(this._i+=1),this.curr()}next(){return this._i>1&&(this._i-=1),this.curr()}curr(){return this.items[this.items.length-this._i]}};var Z=function(e){for(let t of e)if(!t.value.startsWith("//"))return!1;return!0},ee=function(e){if(e.defaultPrevented)return;let t=this.getModule(k.name);if(!t){console.warn(`Module not found: ${k.name}`);return}let{key:n,altKey:o,ctrlKey:i,shiftKey:a}=S(e);if(!(i&&!o&&!a&&n==="/"))return;e.preventDefault();let r=this.element,{pattern:d,value:l}=t,u=C(r),{short:c,long:h,dir:p,isReversed:v}=M(r),g=u.filter(x=>x.isSelected),m=g.length>1,y=Z(g),f=c,K=h,A=[];for(let x=0;x<u.length;x++){let w=u[x],{startIndex:E,endIndex:H}=w,$=w.value;if(!w.isSelected){A.push(w.value);continue}let T;if(m){let z=!w.value.trim();y?T=w.value.replace(d,""):z?T=w.value:T=l+w.value}else y?T=w.value.replace(d,""):T=l+w.value;let b=T.length-$.length;c>=E&&c<H?b>=0?(f+=b,K+=b):(f+=Math.max(b,E-c),K+=Math.max(b,E-h)):h>=E&&c<H?b>=0?K+=b:K+=Math.max(b,E-h):(f+=b,K+=b),A.push(T)}this.setState({isReversed:v,short:f,long:K,dir:p,value:A.join("")}),this.addHistory()},te=function(e){if(e.defaultPrevented)return;if(!this.getModule(k.name)){console.warn(`Module not found: ${k.name}`);return}let{key:n,altKey:o,ctrlKey:i,shiftKey:a}=S(e);if(!(!i&&!o&&a&&n==="*"))return;let r=this.element,{short:d,long:l,dir:u,isReversed:c}=M(r);if(d!==l||r.value.charAt(d-1)!=="/")return;e.preventDefault();let v=d+1,g=l+1,m=r.value.substring(0,d)+"**/"+r.value.substring(l);this.setState({isReversed:c,short:v,long:g,dir:u,value:m}),this.addHistory()},ne=function(e){ee.call(this,e),te.call(this,e)},k=class e extends I{pattern;value;constructor(t){super(t,e.name),this.pattern=e.defaults.pattern,this.value=e.defaults.value}static name="Comment";static defaults={pattern:/^\/\/\s?/,value:"// "};onKeydown=ne};var se=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:o,shiftKey:i}=S(e);if(!(!o&&!n&&t==="Tab"))return;e.preventDefault();let s=this.getModule(G.name);if(!s){console.warn(`Module not found: ${G.name}`);return}let r=this.element,{pattern:d,value:l}=s,u=C(r),{short:c,long:h,dir:p,isReversed:v}=M(r),m=u.filter(x=>x.isSelected).length>1,y=e.shiftKey,f=c,K=h,A=[];for(let x=0;x<u.length;x++){let w=u[x],{startIndex:E,endIndex:H}=w,$=w.value;if(!w.isSelected){A.push(w.value);continue}let T;if(m){let z=!w.value.trim();y?T=w.value.replace(d,""):z?T=w.value:T=l+w.value}else y?T=w.value.replace(d,""):T=l+w.value;let b=T.length-$.length;c>=E&&c<H?b>=0?(f+=b,K+=b):(f+=Math.max(b,E-c),K+=Math.max(b,E-h)):h>=E&&c<H?b>=0?K+=b:K+=Math.max(b,E-h):(f+=b,K+=b),A.push(T)}this.setState({isReversed:v,short:f,long:K,dir:p,value:A.join("")}),this.addHistory()},G=class e extends I{pattern;value;constructor(t){super(t,e.name),this.pattern=e.defaults.pattern,this.value=e.defaults.value}onKeydown=se;static name="Indent";static defaults={pattern:/^[^\S\n\r][^\S\n\r]?/,value:"  "}};var Q=function(e,t){return Object.keys(e).includes(t)};var q=function(e,t,n){return e[t]&&e[t]===n};var F=function(e,t){return e[t]};var N=function(e,t){return e.repeat(Math.ceil(t/e.length)).slice(0,t)},oe=function(e,t,n){let o=Object.keys(e).join(""),i=Object.values(e).join("");for(let a=n.length-1;a>=0;a--){let s=n[a];for(let r=s.length-1;r>=0;r--){let d=s[r];if(i.includes(d)){let l=s.match(/^\s*/)?.[0].length||0;return N(t,l)}if(o.includes(d)){let l=(s.match(/^\s*/)?.[0].length||0)+t.length;return N(t,l)}}}return""},re=function(e){if(e.defaultPrevented)return;let t=this.getModule(P.name);if(!t){console.warn(`Module not found: ${P.name}`);return}let{key:n,altKey:o,ctrlKey:i,shiftKey:a}=S(e);if(!(!i&&!o&&!a&&n==="Enter"))return;e.preventDefault();let{pairs:r,indentUnit:d}=t,l=this.element,{short:u,long:c,dir:h,isReversed:p}=M(l),v=l.value.charAt(u-1),g=l.value.charAt(u),m=l.value.substring(0,u),y=`
`,f=l.value.substring(c),K=m.split(/\r\n|\r|\n/),A=oe(r,d,K),x=u+1;if(q(r,v,g)){let H=A.substring(0,A.length-d.length);y+=A+`
`+H,x+=A.length}else y+=A,x+=A.length;let w=m+y+f,E=x;this.setState({isReversed:!1,short:x,long:E,dir:"none",value:w}),this.addHistory()},P=class e extends I{pairs;indentUnit;constructor(t){super(t,e.name),this.pairs=e.defaults.pairs,this.indentUnit=e.defaults.indentUnit}onKeydown=re;static name="AutoIndent";static defaults={pairs:{"(":")","[":"]","{":"}"},indentUnit:"  "}};var ie=function(e){if(e.defaultPrevented)return;let t=this.getModule(R.name);if(!t){console.warn(`Module not found: ${R.name}`);return}let n=t.pairs,{key:o,altKey:i,ctrlKey:a,shiftKey:s}=S(e);if(!(!a&&!i&&Q(n,o)))return;e.preventDefault();let d=this.element,{short:l,long:u,dir:c,isReversed:h}=M(d),p=l!==u,v=o,g=F(n,v),m=d.value.substring(0,l),y=d.value.substring(l,u),f=d.value.substring(u),K,A,x;if(p)x=m+v+y+g+f,K=(m+v).length,A=(m+v+y).length;else{let w=(m+v).length;x=m+v+g+f,K=w,A=w}this.setState({isReversed:h,short:K,long:A,dir:c,value:x}),this.addHistory()},le=function(e){if(e.defaultPrevented)return;let t=this.getModule(R.name);if(!t){console.warn(`Module not found: ${R.name}`);return}let n=t.pairs,{key:o,altKey:i,ctrlKey:a,shiftKey:s}=S(e),r=this.element;if(!(!a&&!i&&!s&&o==="Backspace"))return;let{short:l,long:u}=M(r);if(l!==u)return;let h=r.value.charAt(l-1),p=r.value.charAt(l);if(!q(n,h,p))return;e.preventDefault();let v=r.value.substring(0,l-1),g=r.value.substring(l+1),m=v+g,y=v.length,f=v.length;this.setState({isReversed:!1,short:y,long:f,dir:"forward",value:m}),this.addHistory()},ae=function(e){ie.call(this,e),le.call(this,e)},R=class e extends I{pairs;constructor(t){super(t,e.name),this.pairs={...e.defaults.pairs}}onKeydown=ae;static name="AutoPair";static defaults={pairs:{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}}};var ue=function(e,t){for(let n of e)if(n.pattern.test(t))return n},ce=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:o,shiftKey:i}=S(e);if(!(!o&&!n&&(t.length===1||t==="Backspace")))return;let s=this.getModule(V.name);if(!s){console.warn(`Module not found: ${V.name}`);return}s.stop(!0);let r=s._requestId+1,d=s._chunkSize,l=[],u=!1,c=!1,h=0,p=f=>{u=!0,c=f||!1};s._requestId=r,s._stop=p;let v=s.parser.call(s,this.element),g=v.body,m=[];if(g){let f=ue(s.indexes,g);f?m=f.tags:m=s.tags}let y=()=>{let f=[],K=h+d;for(;h<K&&h<m.length;){let x={tag:m[h],query:v};s.filter?.call(s,x,l,h,m)&&(f.push(x),l.push(x)),h++}if(!(c||s._requestId!==r)){if(u||h>=m.length){s.onData?.call(s,f,l),s.onEnd?.call(s,l);return}s.onData?.call(s,f,l),setTimeout(y,0)}};y()},V=class e extends I{tags;indexes;parser;filter;onData;onEnd;_requestId;_chunkSize;_stop;constructor(t){super(t,e.name,1),this.tags=[],this.indexes=[],this.parser=e.defaults.parser,this.filter=e.defaults.filter,this.onData=()=>{},this.onEnd=()=>{},this._requestId=0,this._chunkSize=e.defaults.chunkSize,this._stop=()=>{}}onKeyup=ce;static name="AutoComplete";static defaults={chunkSize:100,parser:function(t){let n=t.value.split(/[,.․‧・｡。{}()<>[\]\\/|'"`!?]|\r\n|\r|\n/),o=t.selectionStart,i=0,a=0;for(let u of n){if(a=i+u.length,o>=i&&o<=a)break;i=a+1}let s=t.value.substring(0,i),r=t.value.substring(i,a),d=t.value.substring(a),l=r.match(/^(\s*)(.*?)(\s*)$/);return l&&(s=s+(l[1]||""),r=l[2],d=(l[3]||"")+d),{head:s,body:r,tail:d}},filter:function(t,n,o,i){let{tag:a,query:s}=t,r=s.body;return a.key.indexOf(r)>-1}};compare(t,n){return B(t,n)}stop(t){let n=this._stop;n?.(t)}set(t){let n=t.query.head.length+t.tag.value.length,o=t.query.head.length+t.tag.value.length,i=t.query.head+t.tag.value+t.query.tail,a={short:n,long:o,value:i};this.parent.setState(a)}};var de=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:o,shiftKey:i}=S(e);if(!(o&&!n&&t==="Enter"))return;e.preventDefault();let s=this.element,{short:r,long:d,dir:l,isReversed:u}=M(s),c=C(s),h=c.filter(f=>f.isSelected),p=e.shiftKey?h[0]:h[h.length-1],v=c[c.length-1].index===h[h.length-1].index,g=[],m=r,y=d;for(let f of c){if(!(p.index===f.index)){g.push(f.value);continue}i?(g.push(`
`+f.value),m=f.startIndex,y=f.startIndex):(g.push(f.value+`
`),m=f.endIndex,y=f.endIndex)}!i&&v&&(m+=1,y+=1),this.setState({isReversed:!1,short:m,long:y,dir:"none",value:g.join("")}),this.addHistory()},_=class e extends I{constructor(t){super(t,e.name)}onKeydown=de;static name="LineBreak";static defaults={}};var he=function(e){if(e.defaultPrevented)return;let{key:t,altKey:n,ctrlKey:o,shiftKey:i}=S(e);if(!(o&&!n&&i&&t.toLowerCase()==="k"))return;e.preventDefault();let s=this.element,r=C(s),d=r.filter(g=>g.isSelected),l=d[0],u=[],c=0,h=0;for(let g of r)g.isSelected||(g.index===l.index-1&&(c=g.startIndex,h=g.startIndex),u.push(g.value));let p=u.join("");d.length===1&&d[0].value===""&&r[r.length-1].index===d[0].index&&(p=p.substring(0,p.length-1)),this.setState({isReversed:!1,short:c,long:h,dir:"none",value:p}),this.addHistory()},j=class e extends I{constructor(t){super(t,e.name)}onKeydown=he;static name="LineRemove";static defaults={}};var fe=!!navigator.clipboard?.writeText,me=function(e){if(e.defaultPrevented)return;if(!fe){console.warn("navigator.clipboard.writeText not found");return}let t=this.element,{key:n,altKey:o,ctrlKey:i,shiftKey:a}=S(e),{short:s,long:r,dir:d,isReversed:l}=M(t);if(!(!(s!==r)&&i&&!o&&!a&&n.toLowerCase()==="x"))return;e.preventDefault();let h=C(t),p="",v=[],g=s,m=r;for(let y of h)y.isSelected?(g=y.startIndex,m=y.startIndex,p=y.value):v.push(y.value);if(!p){console.warn("No data selected");return}navigator.clipboard.writeText(p).then(()=>{this.setState({isReversed:!1,short:g,long:m,dir:"none",value:v.join("")}),this.addHistory()})},O=class e extends I{constructor(t){super(t,e.name)}onKeydown=me;static name="LineCut";static defaults={}};var pe=!!navigator.clipboard?.writeText,ge=function(e){if(e.defaultPrevented)return;if(!pe){console.warn("navigator.clipboard.writeText not found");return}let t=this.element,{key:n,altKey:o,ctrlKey:i,shiftKey:a}=S(e),{short:s,long:r,dir:d,isReversed:l}=M(t);if(!(!(s!==r)&&i&&!o&&!a&&n.toLowerCase()==="c"))return;e.preventDefault();let p=C(t).find(v=>v.isSelected)?.value;if(!p){console.warn("No data selected");return}navigator.clipboard.writeText(p)},D=class e extends I{constructor(t){super(t,e.name)}onKeydown=ge;static name="LineCopy";static defaults={}};var W=class{element;modules;moduleOrder;_keydownState;_keydownEvent;_keyupEvent;_focusEvent;_blurEvent;constructor(t){this.element=t,this.modules={},this.modules[L.name]=new L(this),this.modules[k.name]=new k(this),this.modules[G.name]=new G(this),this.modules[_.name]=new _(this),this.modules[j.name]=new j(this),this.modules[O.name]=new O(this),this.modules[D.name]=new D(this),this.modules[P.name]=new P(this),this.modules[R.name]=new R(this),this.modules[V.name]=new V(this),this.moduleOrder=[],this._keydownState=null,this._keydownEvent=o=>{for(let i of this.moduleOrder)i.onKeydown?.call(this,o);o.defaultPrevented?this._clearKeydownState():["Meta","Control","Alt","Shift"].includes(o.key)||this._setKeydownState(o)},this._keyupEvent=o=>{for(let i of this.moduleOrder)i.onKeyup?.call(this,o)};let n=o=>{this.addHistory(!1)};this._focusEvent=o=>{setTimeout(()=>{this.addHistory(!1),this.element.addEventListener("pointerup",n,!0)},0)},this._blurEvent=o=>{this.element.removeEventListener("pointerup",n,!0)},this.element.addEventListener("keydown",this._keydownEvent,!0),this.element.addEventListener("keyup",this._keyupEvent,!0),this.element.addEventListener("focus",this._focusEvent,!0),this.element.addEventListener("blur",this._blurEvent,!0),this.initOrder()}initOrder(){this.moduleOrder=Object.values(this.modules).sort((t,n)=>t.index-n.index)}getModule(t){return this.modules[t]}getState(t){return M(this.element,t)}setState(t){U(this.element,t)}addHistory(t=!0){this.getModule(L.name)?.add(t)}_clearKeydownState(){this._keydownState=null}_setKeydownState(t){this._keydownState={value:this.element.value,state:M(this.element),key:t.key}}};export{V as AutoCompleteModule,P as AutoIndentModule,R as AutoPairModule,k as CommentModule,L as HistoryModule,G as IndentModule,_ as LineBreakModule,D as LineCopyModule,O as LineCutModule,j as LineRemoveModule,W as MTGA};
