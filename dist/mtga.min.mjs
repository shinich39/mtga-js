var y=function(n,t){let e=n.selectionStart>n.selectionEnd,s=Math.min(n.selectionStart,n.selectionEnd),i=Math.max(n.selectionStart,n.selectionEnd),o=n.selectionDirection;return t?{isReversed:e,short:s,long:i,dir:o,value:n.value}:{isReversed:e,short:s,long:i,dir:o}},p=function(n,t){t.value&&(n.value=t.value),t.isReversed?n.setSelectionRange(t.long,t.short,t.dir||"none"):n.setSelectionRange(t.short,t.long,t.dir||"none"),n.focus()},v=function(n){let t=n.key,e=n.altKey,s=n.shiftKey,i=n.ctrlKey||n.metaKey;return{key:t,altKey:e,shiftKey:s,ctrlKey:i}};function k(n,t){let e=Array.from({length:n.length+1},()=>Array(t.length+1).fill(0));for(let l=1;l<=n.length;l++)for(let u=1;u<=t.length;u++)n[l-1]===t[u-1]?e[l][u]=e[l-1][u-1]+1:e[l][u]=Math.max(e[l-1][u],e[l][u-1]);let s=[],i=0,o=n.length,a=t.length,c=null,r=[],h=function(){c!==null&&r.length>0&&s.push([c,r.reverse().join("")]),c=null,r=[]};for(;o>0||a>0;){let l=n[o-1],u=t[a-1];o>0&&a>0&&l===u?(c!==0&&h(),c=0,r.push(l),i++,o--,a--):a>0&&(o===0||e[o][a-1]>=e[o-1][a])?(c!==1&&h(),c=1,r.push(u),a--):o>0&&(c!==-1&&h(),c=-1,r.push(l),o--)}return h(),{accuracy:i*2/(n.length+t.length),score:i,match:s.reverse()}}function L(n){let t=[],e=n.length;for(let s=1;s<1<<e;s++){let i=[];for(let o=0;o<e;o++)s>>o&1&&i.push(n[o]);t.push(i)}return t}var b=function(n){let{short:t,long:e}=y(n),s=n.value.split(/\n/),i=[],o=[],a=0;for(let c=0;c<s.length;c++){let r=s[c],l=c===s.length-1?r:r+`
`,u=a,d=a+r.length+1,f=-1,g=-1,m="";t>=u&&t<d&&(f=t-u),e>u&&e<d&&(g=e-u),t<=u&&e>=d&&(f=0,g=l.length),f>-1&&g===-1&&(g=l.length),g>-1&&f===-1&&(f=0);let x=f>-1&&g>-1;x&&(m=l.substring(f,g));let S={rowIndex:c,startIndex:u,endIndex:d,value:l,selectionStart:f,selectionEnd:g,selectionValue:m};i.push(S),x&&o.push(S),a=d}return{rows:i,selectedRows:o}},w=function(n,t,e){let{short:s,long:i,dir:o,isReversed:a}=y(n),c=s,r=i,h=[];for(let l of t){let{startIndex:u,endIndex:d}=l,f=l.value,g=e(l),m=g.length-f.length;s>=u&&s<d?m>=0?(c+=m,r+=m):(c+=Math.max(m,u-s),r+=Math.max(m,u-i)):i>=u&&s<d?m>=0?r+=m:r+=Math.max(m,u-i):r+=m,h.push(g)}return{isReversed:a,short:c,long:r,dir:o,value:h.join("")}};var H=function(n,t){return Object.keys(n).includes(t)};var _=function(n,t){return n[t]},K=class{element;pairs;constructor(t,e){this.element=t,this.pairs=e}isInsert(t){let{key:e,altKey:s,ctrlKey:i,shiftKey:o}=v(t);return!s&&!i&&H(this.pairs,e)}isDelete(t){let e=this.element,s=this.pairs,{key:i,altKey:o,ctrlKey:a,shiftKey:c}=v(t);if(o||a||c||i!=="Backspace")return!1;let{short:r,long:h,dir:l,isReversed:u}=y(e);if(r!==h)return!1;let f=e.value.charAt(h-1),g=e.value.charAt(h);return H(s,f)&&_(s,f)===g}insert(t){let e=this.element,s=this.pairs,{key:i}=v(t),{short:o,long:a,dir:c,isReversed:r}=y(e),h=o!==a,l=i,u=_(s,l),d=e.value.substring(0,o),f=e.value.substring(o,a),g=e.value.substring(a),m,x,S;if(h)S=d+l+f+u+g,m=(d+l).length,x=(d+l+f).length;else{let A=(d+l).length;S=d+l+u+g,m=A,x=A}p(e,{isReversed:r,short:m,long:x,dir:c,value:S})}delete(t){let e=this.element,s=this.pairs,{long:i}=y(e),o=e.value.substring(0,i-1),a=e.value.substring(i+1),c=o+a,r=o.length,h=o.length;p(e,{isReversed:!1,short:r,long:h,dir:"forward",value:c})}};var C=function(n){let{key:t,altKey:e,ctrlKey:s,shiftKey:i}=v(n);return s&&!i&&t.toLowerCase()==="z"},P=function(n){let{key:t,altKey:e,ctrlKey:s,shiftKey:i}=v(n);return s&&i&&t.toLowerCase()==="z"},I=class{element;histories;index;maxCount;constructor(t){this.element=t,this.histories=[],this.index=1,this.maxCount=390}prune(){this.index>1&&(this.histories=this.histories.slice(0,this.histories.length-(this.index-1)),this.index=1)}add(t=!0){let e=this.element;if(t)this.prune();else if(this.index!==1)return;let s=y(e,!0);this.histories.push(s),this.histories.length>this.maxCount&&this.histories.shift()}prev(){this.index<this.histories.length&&(this.index+=1)}next(){this.index>1&&(this.index-=1)}curr(){return this.histories[this.histories.length-this.index]}undo(t){let e=this.element;this.prev();let s=this.curr();s&&p(e,s)}redo(t){let e=this.element;this.next();let s=this.curr();s&&p(e,s)}};var V=function(n){for(let t of n)if(t.value.startsWith("//"))return!0;return!1},E=class{element;key;removePattern;newValue;constructor(t){this.element=t,this.key="/",this.removePattern=/^\/\/\s?/,this.newValue="// "}isValid(t){let{key:e,altKey:s,shiftKey:i}=t;return(t.ctrlKey||t.metaKey)&&!s&&!i&&e===this.key}exec(t){let e=this.element,{rows:s,selectedRows:i}=b(e),o=i.length>1,a=V(i),c=w(e,s,r=>{if(!(r.selectionStart>-1||r.selectionEnd>-1))return r.value;if(o){let l=!r.value.trim();return a?r.value.replace(this.removePattern,""):l?r.value:this.newValue+r.value}else return a?r.value.replace(this.removePattern,""):this.newValue+r.value});p(e,c)}};var R=class{element;key;removePattern;newValue;constructor(t){this.element=t,this.key="Tab",this.removePattern=/^[^\S\n\r][^\S\n\r]?/,this.newValue="  "}isValid(t){let{key:e,altKey:s,shiftKey:i}=t;return!(t.ctrlKey||t.metaKey)&&!s&&e===this.key}exec(t){let e=this.element,{rows:s,selectedRows:i}=b(e),o=i.length>1,a=t.shiftKey,c=w(e,s,r=>{if(!(r.selectionStart>-1||r.selectionEnd>-1))return r.value;if(o){let l=!r.value.trim();return a?r.value.replace(this.removePattern,""):l?r.value:this.newValue+r.value}else return a?r.value.replace(this.removePattern,""):this.newValue+r.value});p(e,c)}};var j=function(n,t){let e=Object.keys(n).sort((s,i)=>i.length-s.length);for(let s of e){let{score:i}=k(s,t);if(i===s.length)return n[s]}},D=function(n,t){let e={};if(t>0)for(let s of n){let{key:i,value:o}=s,a=[],c=L(i.split(""));for(let h of c)h.length<=t&&a.push(h.join(""));let r=[...new Set(a)];for(let h of r)e[h]?e[h].push(s):e[h]=[s]}return e},T=class{element;tags;index;result;parser;filter;onLoad;_state;_stop;constructor(t){this.element=t,this.tags=[],this.index={},this._state=y(t,!0),this.result=[],this.parser=e=>{let s=e.value.split(/[,.\s․‧・｡。{}()<>[\]\\/|'"`!?]/),i=e.selectionStart,o=0,a=0;for(let l of s){if(a=o+l.length,i>=o&&i<=a)break;o=a+1}let c=e.value.substring(0,o),r=e.value.substring(o,a).trim().replace(/\s/g,"_"),h=e.value.substring(a);return{head:c,body:r,tail:h}},this.filter=()=>!0,this._stop=null,this.onLoad=null}stop(t){let e=this._stop;e&&e(t)}clear(){let t=this._stop;t&&t(!0),this.result=[]}createIndex(t=1){this.index=D(this.tags,t)}reset(){p(this.element,this._state)}set(t){let e=t.parts.head.length+t.tag.value.length,s=t.parts.head.length+t.tag.value.length,i=t.parts.head+t.tag.value+t.parts.tail,o={short:e,long:s,value:i};p(this.element,o)}async exec(){this.clear(),this._state=y(this.element,!0);let t=!1,e=!1;this._stop=r=>{t=!0,e=r||!1,this._stop=null};let s=this._stop,i=this.result,o=this.parser(this.element),a=o.body,c=a?j(this.index,a)||this.tags:[];for(let r=0;r<c.length;r++){let h=c[r],l={...k(a,h.key),tag:h,parts:o};if(this.filter(l,r,c,s)&&i.push(l),t)break;r%39===0&&await new Promise(d=>setTimeout(d,0))}e||this.onLoad?.(i)}};var M=class{element;_keydownState;History;Commentify;Indentify;AutoPairing;AutoComplete;constructor(t){this.element=t,this._keydownState=null,this.History=new I(t),this.Commentify=new E(t),this.Indentify=new R(t),this.AutoPairing=new K(t,{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}),this.AutoComplete=new T(t),t.addEventListener("keydown",e=>{C(e)?(e.preventDefault(),this.History.undo(e),this._clearKeydownState()):P(e)?(e.preventDefault(),this.History.redo(e),this._clearKeydownState()):this.AutoPairing.isInsert(e)?(e.preventDefault(),this.AutoPairing.insert(e),this.History.add(),this._clearKeydownState()):this.AutoPairing.isDelete(e)?(e.preventDefault(),this.AutoPairing.delete(e),this.History.add(),this._clearKeydownState()):this.Commentify.isValid(e)?(e.preventDefault(),this.Commentify.exec(e),this.History.add(),this._clearKeydownState()):this.Indentify.isValid(e)?(e.preventDefault(),this.Indentify.exec(e),this.History.add(),this._clearKeydownState()):["Meta","Control","Alt","Shift"].includes(e.key)||this._setKeydownState(e)}),t.addEventListener("keyup",e=>{let s=this._keydownState;if(this._clearKeydownState(),!s)return;if(s.value!==t.value)this.History.add(),this.AutoComplete.exec();else{let o=s.state,a=y(t);(o.short!==a.short||o.long!==a.long)&&this.History.add(!1)}}),this.element.addEventListener("mouseup",e=>{this.History.add(!1)})}getState(t){return y(this.element,t)}setState(t){p(this.element,t)}_clearKeydownState(){this._keydownState=null}_setKeydownState(t){this._keydownState={value:this.element.value,state:y(this.element),key:t.key}}};export{M as MTGA};
