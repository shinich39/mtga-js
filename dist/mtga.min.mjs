var x=function(t,e){let n=t.selectionStart>t.selectionEnd,s=Math.min(t.selectionStart,t.selectionEnd),o=Math.max(t.selectionStart,t.selectionEnd),i=t.selectionDirection;return e?{isReversed:n,short:s,long:o,dir:i,value:t.value}:{isReversed:n,short:s,long:o,dir:i}},W=function(t,e){typeof e.value=="string"&&(t.value=e.value),e.isReversed?t.setSelectionRange(e.long,e.short,e.dir||"none"):t.setSelectionRange(e.short,e.long,e.dir||"none"),t.focus()};var K=class{parent;name;index;onKeydown;onKeydownAsync;onKeyup;onKeyupAsync;onPaste;onPasteAsync;constructor(e,n,s=9999){this.parent=e,this.name=n,this.index=s}static defaults={}};var b=function(t){let e=t.key,n=t.altKey,s=t.shiftKey,o=t.ctrlKey||t.metaKey;return{key:e,altKey:n,shiftKey:s,ctrlKey:o}};function F(t,e){let n=Array.from({length:t.length+1},()=>Array(e.length+1).fill(0));for(let l=1;l<=t.length;l++)for(let d=1;d<=e.length;d++)t[l-1]===e[d-1]?n[l][d]=n[l-1][d-1]+1:n[l][d]=Math.max(n[l-1][d],n[l][d-1]);let s=[],o=0,i=t.length,a=e.length,u=null,c=[],r=function(){u!==null&&c.length>0&&s.push([u,c.reverse().join("")]),u=null,c=[]};for(;i>0||a>0;){let l=t[i-1],d=e[a-1];i>0&&a>0&&l===d?(u!==0&&r(),u=0,c.push(l),o++,i--,a--):a>0&&(i===0||n[i][a-1]>=n[i-1][a])?(u!==1&&r(),u=1,c.push(d),a--):i>0&&(u!==-1&&r(),u=-1,c.push(l),i--)}return r(),{accuracy:o*2/(t.length+e.length),score:o,match:s.reverse()}}var te=function(t){if(t.defaultPrevented)return;let e=this.parent,{key:n,altKey:s,ctrlKey:o,shiftKey:i}=b(t);if(!(o&&!s&&n.toLowerCase()==="z"))return;t.preventDefault();let u;i?u=this.next():u=this.prev(),u&&e.setState(u)},ne=function(t){let e=this.parent,n=e._keydownState;if(e._clearKeydownState(),!n)return;let s=e.element,o=n.value,i=s.value;if(o!==i)e.addHistory();else{let a=n.state,u=x(s);(a.short!==u.short||a.long!==u.long)&&e.addHistory(!1)}},V=class t extends K{items;maxCount;_i;constructor(e){super(e,t.name,0),this.items=[],this.maxCount=t.defaults.maxCount,this._i=1}static name="History";static defaults={maxCount:390};onKeydown=te;onKeyup=ne;prune(){this._i>1&&(this.items=this.items.slice(0,this.items.length-(this._i-1)),this._i=1)}add(e=!0){let n=this.parent.element;if(e)this.prune();else if(this._i!==1)return;let s=this.items[this.items.length-1],o=x(n,!0);(!s||s.short!==o.short||s.long!==o.long||s.value!==o.value)&&(this.items.push(o),this.items.length>this.maxCount&&this.items.shift())}prev(){return this._i<this.items.length&&(this._i+=1),this.curr()}next(){return this._i>1&&(this._i-=1),this.curr()}curr(){return this.items[this.items.length-this._i]}};var C=function(t){let{short:e,long:n}=x(t),s=t.value.split(/\n/),o=[],i=0;for(let a=0;a<s.length;a++){let u=s[a],c=a===s.length-1,r=c?u:u+`
`,l=i,d=l+r.length,m=-1,v=-1,f="";e>=l&&e<d&&(m=e-l),n>l&&(c?n<=d:n<d)&&(v=n-l),e<=l&&n>=d&&(m=0,v=r.length),m>-1&&v===-1&&(v=r.length),v>-1&&m===-1&&(m=0);let h={isSelected:m>-1&&v>-1,index:a,startIndex:l,endIndex:d,value:r,selectionStart:m,selectionEnd:v};o.push(h),i=d}return o};var se=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:i,shiftKey:a}=b(t);if(!(i&&!o&&!a&&s==="/"))return;t.preventDefault();let{pattern:c,value:r}=this,l=C(n),{short:d,long:m,dir:v,isReversed:f}=x(n),y=l.filter(M=>M.isSelected),h=y.filter(M=>!M.value.trim()),w=y.length>1,p=w&&y.length!==h.length,g=!0;for(let M of y)if(!(p&&h.some(A=>A.index===M.index))&&!M.value.startsWith("//")){g=!1;break}let I=d,S=m,E=[];for(let M=0;M<l.length;M++){let A=l[M],{startIndex:P,endIndex:Q}=A,R=A.value;if(!A.isSelected){E.push(A.value);continue}let L;w?g?L=A.value.replace(c,""):p&&h.some(ee=>ee.index===A.index)?L=A.value:L=r+A.value:g?L=A.value.replace(c,""):L=r+A.value;let k=L.length-R.length;d>=P&&d<Q?k>=0?(I+=k,S+=k):(I+=Math.max(k,P-d),S+=Math.max(k,P-m)):m>=P&&d<Q?k>=0?S+=k:S+=Math.max(k,P-m):(I+=k,S+=k),E.push(L)}e.setState({isReversed:f,short:I,long:S,dir:v,value:E.join("")}),e.addHistory()},oe=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:i,shiftKey:a}=b(t);if(!(!i&&!o&&a&&s==="*"))return;let{short:c,long:r,dir:l,isReversed:d}=x(n);if(c!==r||n.value.charAt(c-1)!=="/")return;t.preventDefault();let f=c+1,y=r+1,h=n.value.substring(0,c)+"**/"+n.value.substring(r);e.setState({isReversed:d,short:f,long:y,dir:l,value:h}),e.addHistory()},re=function(t){se.call(this,t),oe.call(this,t)},_=class t extends K{pattern;value;constructor(e){super(e,t.name),this.pattern=t.defaults.pattern,this.value=t.defaults.value}static name="Comment";static defaults={pattern:/^\/\/\s?/,value:"// "};onKeydown=re};var ie=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:i,shiftKey:a}=b(t);if(!(!i&&!o&&s==="Tab"))return;t.preventDefault();let{pattern:c,value:r}=this,l=C(n),{short:d,long:m,dir:v,isReversed:f}=x(n),h=l.filter(S=>S.isSelected).length>1,w=t.shiftKey,p=d,g=m,I=[];for(let S=0;S<l.length;S++){let E=l[S],{startIndex:M,endIndex:A}=E,P=E.value;if(!E.isSelected){I.push(E.value);continue}let R;if(h){let L=!E.value.trim();w?R=E.value.replace(c,""):L?R=E.value:R=r+E.value}else w?R=E.value.replace(c,""):R=r+E.value;let T=R.length-P.length;d>=M&&d<A?T>=0?(p+=T,g+=T):(p+=Math.max(T,M-d),g+=Math.max(T,M-m)):m>=M&&d<A?T>=0?g+=T:g+=Math.max(T,M-m):(p+=T,g+=T),I.push(R)}e.setState({isReversed:f,short:p,long:g,dir:v,value:I.join("")}),e.addHistory()},H=class t extends K{pattern;value;constructor(e){super(e,t.name),this.pattern=t.defaults.pattern,this.value=t.defaults.value}onKeydown=ie;static name="Indent";static defaults={pattern:/^[^\S\n\r][^\S\n\r]?/,value:"  "}};var $=function(t,e){return Object.keys(t).includes(e)},J=function(t,e){return Object.values(t).includes(e)},N=function(t,e,n){return t[e]&&t[e]===n};var X=function(t,e){return t[e]};var Y=function(t,e){return t.repeat(Math.ceil(e/t.length)).slice(0,e)},ae=function(t,e,n){let s=Object.keys(t).join(""),o=Object.values(t).join("");for(let i=n.length-1;i>=0;i--){let a=n[i];for(let u=a.length-1;u>=0;u--){let c=a[u];if(o.includes(c)){let r=a.match(/^\s*/)?.[0].length||0;return Y(e,r)}if(s.includes(c)){let r=(a.match(/^\s*/)?.[0].length||0)+e.length;return Y(e,r)}}}return""},le=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:s,shiftKey:o}=b(t);if(!(!s&&!n&&!o&&e==="Enter"))return;t.preventDefault();let a=this.parent,u=a.element,{pairs:c,indentUnit:r}=this,{short:l,long:d,dir:m,isReversed:v}=x(u),f=u.value.charAt(l),y=u.value.substring(0,l),h=`
`,w=u.value.substring(d),p=y.split(/\r\n|\r|\n/),g=ae(c,r,p),I=l+1;if(J(c,f)){let M=g.substring(0,g.length-r.length);h+=g+`
`+M,I+=g.length}else h+=g,I+=g.length;let S=y+h+w,E=I;a.setState({isReversed:!1,short:I,long:E,dir:"none",value:S}),a.addHistory()},G=class t extends K{pairs;indentUnit;constructor(e){super(e,t.name),this.pairs=t.defaults.pairs,this.indentUnit=t.defaults.indentUnit}onKeydown=le;static name="AutoIndent";static defaults={pairs:{"(":")","[":"]","{":"}"},indentUnit:"  "}};var ue=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,s=this.pairs,{key:o,altKey:i,ctrlKey:a,shiftKey:u}=b(t);if(!(!a&&!i&&$(s,o)))return;t.preventDefault();let{short:r,long:l,dir:d,isReversed:m}=x(n),v=r!==l,f=o,y=X(s,f),h=n.value.substring(0,r),w=n.value.substring(r,l),p=n.value.substring(l),g,I,S;if(v)S=h+f+w+y+p,g=(h+f).length,I=(h+f+w).length;else{let E=(h+f).length;S=h+f+y+p,g=E,I=E}e.setState({isReversed:m,short:g,long:I,dir:d,value:S}),e.addHistory()},ce=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,s=this.pairs,{key:o,altKey:i,ctrlKey:a,shiftKey:u}=b(t);if(!(!a&&!i&&!u&&o==="Backspace"))return;let{short:r,long:l}=x(n);if(r!==l)return;let m=n.value.charAt(r-1),v=n.value.charAt(r);if(!N(s,m,v))return;t.preventDefault();let f=n.value.substring(0,r-1),y=n.value.substring(r+1),h=f+y,w=f.length,p=f.length;e.setState({isReversed:!1,short:w,long:p,dir:"forward",value:h}),e.addHistory()},de=function(t){ue.call(this,t),ce.call(this,t)},O=class t extends K{pairs;constructor(e){super(e,t.name),this.pairs={...t.defaults.pairs}}onKeydown=de;static name="AutoPair";static defaults={pairs:{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}}};var he=function(t,e){for(let n of t)if(n.pattern.test(e))return n},fe=function(t){if(t.defaultPrevented)return;let{key:e,altKey:n,ctrlKey:s,shiftKey:o}=b(t);if(!(!s&&!n&&(e.length===1||e==="Backspace")))return;this.stop(!0);let a=this.parent,u=this._requestId+1,c=this._chunkSize,r=[],l=!1,d=!1,m=0,v=p=>{l=!0,d=p||!1};this._requestId=u,this._stop=v;let f=this.parser.call(this,a.element),y=f.body,h=[];if(y){let p=he(this.indexes,y);p?h=p.tags:h=this.tags}let w=()=>{let p=[],g=m+c;for(;m<g&&m<h.length;){let S={tag:h[m],query:f};this.filter?.call(this,S,r,m,h)&&(p.push(S),r.push(S)),m++}if(!(d||this._requestId!==u)){if(l||m>=h.length){this.onData?.call(this,p,r),this.onEnd?.call(this,r);return}this.onData?.call(this,p,r),setTimeout(w,0)}};w()},D=class t extends K{tags;indexes;parser;filter;onData;onEnd;_requestId;_chunkSize;_stop;constructor(e){super(e,t.name,1),this.tags=[],this.indexes=[],this.parser=t.defaults.parser,this.filter=t.defaults.filter,this.onData=()=>{},this.onEnd=()=>{},this._requestId=0,this._chunkSize=t.defaults.chunkSize,this._stop=()=>{}}onKeyup=fe;static name="AutoComplete";static defaults={chunkSize:100,parser:function(e){let n=e.value.split(/[,.․‧・｡。{}()<>[\]\\/|'"`!?]|\r\n|\r|\n/),s=e.selectionStart,o=0,i=0;for(let l of n){if(i=o+l.length,s>=o&&s<=i)break;o=i+1}let a=e.value.substring(0,o),u=e.value.substring(o,i),c=e.value.substring(i),r=u.match(/^(\s*)(.*?)(\s*)$/);return r&&(a=a+(r[1]||""),u=r[2],c=(r[3]||"")+c),{head:a,body:u,tail:c}},filter:function(e,n,s,o){let{tag:i,query:a}=e,u=a.body;return i.key.indexOf(u)>-1}};compare(e,n){return F(e,n)}stop(e){let n=this._stop;n?.(e)}set(e){let n=e.query.head.length+e.tag.value.length,s=e.query.head.length+e.tag.value.length,o=e.query.head+e.tag.value+e.query.tail,i={short:n,long:s,value:o};this.parent.setState(i)}};var me=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:i,shiftKey:a}=b(t);if(!(i&&!o&&s==="Enter"))return;t.preventDefault();let{short:c,long:r,dir:l,isReversed:d}=x(n),m=C(n),v=m.filter(g=>g.isSelected),f=t.shiftKey?v[0]:v[v.length-1],y=m[m.length-1].index===v[v.length-1].index,h=[],w=c,p=r;for(let g of m){if(!(f.index===g.index)){h.push(g.value);continue}a?(h.push(`
`+g.value),w=g.startIndex,p=g.startIndex):(h.push(g.value+`
`),w=g.endIndex,p=g.endIndex)}!a&&y&&(w+=1,p+=1),e.setState({isReversed:!1,short:w,long:p,dir:"none",value:h.join("")}),e.addHistory()},j=class t extends K{constructor(e){super(e,t.name)}onKeydown=me;static name="LineBreak";static defaults={}};var pe=function(t){if(t.defaultPrevented)return;let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:i,shiftKey:a}=b(t);if(!(i&&!o&&a&&s.toLowerCase()==="k"))return;t.preventDefault();let c=C(n),r=c.filter(h=>h.isSelected),l=r[0],d=[],m=0,v=0;for(let h of c)h.isSelected||(h.index===l.index-1&&(m=h.startIndex,v=h.startIndex),d.push(h.value));let f=d.join("");r.length===1&&r[0].value===""&&c[c.length-1].index===r[0].index&&(f=f.substring(0,f.length-1)),e.setState({isReversed:!1,short:m,long:v,dir:"none",value:f}),e.addHistory()},q=class t extends K{constructor(e){super(e,t.name)}onKeydown=pe;static name="LineRemove";static defaults={}};var ge=!!navigator.clipboard?.writeText,ve=async function(t){if(t.defaultPrevented)return;if(!ge){console.warn("navigator.clipboard.writeText not found");return}let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:i,shiftKey:a}=b(t),{short:u,long:c,dir:r,isReversed:l}=x(n);if(!(!(u!==c)&&i&&!o&&!a&&s.toLowerCase()==="x"))return;t.preventDefault();let v=C(n),f="",y=[],h=u,w=c;for(let p of v)p.isSelected?(h=p.startIndex,w=p.startIndex,f=p.value):y.push(p.value);f&&(f.endsWith(`
`)||(f+=`
`),await navigator.clipboard.writeText(f),e.setState({isReversed:!1,short:h,long:w,dir:"none",value:y.join("")}),e.addHistory())},z=class t extends K{constructor(e){super(e,t.name)}onKeydownAsync=ve;static name="LineCut";static defaults={}};var ye=!!navigator.clipboard?.writeText,we=async function(t){if(t.defaultPrevented)return;if(!ye){console.warn("navigator.clipboard.writeText not found");return}let e=this.parent,n=this.parent.element,{key:s,altKey:o,ctrlKey:i,shiftKey:a}=b(t),{short:u,long:c,dir:r,isReversed:l}=x(n);if(!(!(u!==c)&&i&&!o&&!a&&s.toLowerCase()==="c"))return;t.preventDefault();let f=C(n).find(y=>y.isSelected)?.value;f&&(f.endsWith(`
`)||(f+=`
`),await navigator.clipboard.writeText(f))},U=class t extends K{constructor(e){super(e,t.name)}onKeydownAsync=we;static name="LineCopy";static defaults={}};var xe=!!navigator.clipboard?.readText,Ke=function(t){if(t.defaultPrevented)return;if(!xe){console.warn("navigator.clipboard?.readText not found");return}let e=this.parent,n=this.parent.element,{short:s,long:o,dir:i,isReversed:a}=x(n);if(!!(s!==o))return;let r=t.clipboardData?.getData("text");if(!r)return;r=r.replace(/\r\n|\r/g,`
`);let l=r.split(`
`),d=l.length===2,m=l[l.length-1]==="";if(!d||!m)return;t.preventDefault();let v=C(n),f=[],y=s+r.length,h=o+r.length;for(let w of v)w.isSelected&&f.push(r),f.push(w.value);e.setState({isReversed:a,short:y,long:h,dir:i,value:f.join("")}),e.addHistory()},B=class t extends K{constructor(e){super(e,t.name)}onPaste=Ke;static name="LinePaste";static defaults={}};var Z=class{element;modules;moduleOrder;_keydownState;_keydownEvent;_keyupEvent;_pasteEvent;_focusEvent;_blurEvent;constructor(e){this.element=e,this.modules={},this.modules[V.name]=new V(this),this.modules[_.name]=new _(this),this.modules[H.name]=new H(this),this.modules[j.name]=new j(this),this.modules[q.name]=new q(this),this.modules[z.name]=new z(this),this.modules[U.name]=new U(this),this.modules[B.name]=new B(this),this.modules[G.name]=new G(this),this.modules[O.name]=new O(this),this.modules[D.name]=new D(this),this.moduleOrder=[],this._keydownState=null,this._keydownEvent=async s=>{for(let o of this.moduleOrder)o.onKeydown?.call(o,s),await o.onKeydownAsync?.call(o,s);s.defaultPrevented?this._clearKeydownState():["Meta","Control","Alt","Shift"].includes(s.key)||this._setKeydownState(s)},this._keyupEvent=async s=>{for(let o of this.moduleOrder)o.onKeyup?.call(o,s),await o.onKeyupAsync?.call(o,s)},this._pasteEvent=async s=>{for(let o of this.moduleOrder)o.onPaste?.call(o,s),await o.onPasteAsync?.call(o,s)};let n=s=>{this.addHistory(!1)};this._focusEvent=s=>{setTimeout(()=>{this.addHistory(!1),this.element.addEventListener("pointerup",n,!0)},0)},this._blurEvent=s=>{this.element.removeEventListener("pointerup",n,!0)},this.element.addEventListener("keydown",this._keydownEvent,!0),this.element.addEventListener("keyup",this._keyupEvent,!0),this.element.addEventListener("paste",this._pasteEvent,!0),this.element.addEventListener("focus",this._focusEvent,!0),this.element.addEventListener("blur",this._blurEvent,!0),this.initModuleOrder()}initModuleOrder(){this.moduleOrder=Object.values(this.modules).sort((e,n)=>e.index-n.index)}getModule(e){return this.modules[e]}setModule(e){this.modules[e.name]=e,this.initModuleOrder()}removeModule(e){this.modules[e]&&(delete this.modules[e],this.initModuleOrder())}getState(e){return x(this.element,e)}setState(e){W(this.element,e)}addHistory(e=!0){this.getModule(V.name)?.add(e)}_clearKeydownState(){this._keydownState=null}_setKeydownState(e){this._keydownState={value:this.element.value,state:x(this.element),key:e.key}}destroy(){this.element.removeEventListener("keydown",this._keydownEvent),this.element.removeEventListener("keyup",this._keyupEvent),this.element.removeEventListener("paste",this._pasteEvent),this.element.removeEventListener("focus",this._focusEvent),this.element.removeEventListener("blur",this._blurEvent)}};export{D as AutoCompleteModule,G as AutoIndentModule,O as AutoPairModule,_ as CommentModule,V as HistoryModule,H as IndentModule,j as LineBreakModule,U as LineCopyModule,z as LineCutModule,B as LinePasteModule,q as LineRemoveModule,Z as MTGA};
