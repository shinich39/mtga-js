var y=function(o,e){let t=o.selectionStart>o.selectionEnd,s=Math.min(o.selectionStart,o.selectionEnd),i=Math.max(o.selectionStart,o.selectionEnd),n=o.selectionDirection;return e?{isReversed:t,short:s,long:i,dir:n,value:o.value}:{isReversed:t,short:s,long:i,dir:n}},p=function(o,e){e.value&&(o.value=e.value),e.isReversed?o.setSelectionRange(e.long,e.short,e.dir||"none"):o.setSelectionRange(e.short,e.long,e.dir||"none"),o.focus()},v=function(o){let e=o.key,t=o.altKey,s=o.shiftKey,i=o.ctrlKey||o.metaKey;return{key:e,altKey:t,shiftKey:s,ctrlKey:i}};function R(o,e){let t=Array.from({length:o.length+1},()=>Array(e.length+1).fill(0));for(let l=1;l<=o.length;l++)for(let u=1;u<=e.length;u++)o[l-1]===e[u-1]?t[l][u]=t[l-1][u-1]+1:t[l][u]=Math.max(t[l-1][u],t[l][u-1]);let s=[],i=0,n=o.length,a=e.length,c=null,r=[],h=function(){c!==null&&r.length>0&&s.push([c,r.reverse().join("")]),c=null,r=[]};for(;n>0||a>0;){let l=o[n-1],u=e[a-1];n>0&&a>0&&l===u?(c!==0&&h(),c=0,r.push(l),i++,n--,a--):a>0&&(n===0||t[n][a-1]>=t[n-1][a])?(c!==1&&h(),c=1,r.push(u),a--):n>0&&(c!==-1&&h(),c=-1,r.push(l),n--)}return h(),{accuracy:i*2/(o.length+e.length),score:i,match:s.reverse()}}function L(o){let e=[],t=o.length;for(let s=1;s<1<<t;s++){let i=[];for(let n=0;n<t;n++)s>>n&1&&i.push(o[n]);e.push(i)}return e}var b=function(o){let{short:e,long:t}=y(o),s=o.value.split(/\n/),i=[],n=[],a=0;for(let c=0;c<s.length;c++){let r=s[c],l=c===s.length-1?r:r+`
`,u=a,d=a+r.length+1,f=-1,g=-1,m="";e>=u&&e<d&&(f=e-u),t>u&&t<d&&(g=t-u),e<=u&&t>=d&&(f=0,g=l.length),f>-1&&g===-1&&(g=l.length),g>-1&&f===-1&&(f=0);let x=f>-1&&g>-1;x&&(m=l.substring(f,g));let S={rowIndex:c,startIndex:u,endIndex:d,value:l,selectionStart:f,selectionEnd:g,selectionValue:m};i.push(S),x&&n.push(S),a=d}return{rows:i,selectedRows:n}},w=function(o,e,t){let{short:s,long:i,dir:n,isReversed:a}=y(o),c=s,r=i,h=[];for(let l of e){let{startIndex:u,endIndex:d}=l,f=l.value,g=t(l),m=g.length-f.length;s>=u&&s<d?m>=0?(c+=m,r+=m):(c+=Math.max(m,u-s),r+=Math.max(m,u-i)):i>=u&&s<d?m>=0?r+=m:r+=Math.max(m,u-i):r+=m,h.push(g)}return{isReversed:a,short:c,long:r,dir:n,value:h.join("")}};var H=function(o,e){return Object.keys(o).includes(e)};var C=function(o,e){return o[e]},I=class{element;pairs;constructor(e,t){this.element=e,this.pairs=t}isInsert(e){let{key:t,altKey:s,ctrlKey:i,shiftKey:n}=v(e);return!s&&!i&&H(this.pairs,t)}isDelete(e){let t=this.element,s=this.pairs,{key:i,altKey:n,ctrlKey:a,shiftKey:c}=v(e);if(n||a||c||i!=="Backspace")return!1;let{short:r,long:h,dir:l,isReversed:u}=y(t);if(r!==h)return!1;let f=t.value.charAt(h-1),g=t.value.charAt(h);return H(s,f)&&C(s,f)===g}insert(e){let t=this.element,s=this.pairs,{key:i}=v(e),{short:n,long:a,dir:c,isReversed:r}=y(t),h=n!==a,l=i,u=C(s,l),d=t.value.substring(0,n),f=t.value.substring(n,a),g=t.value.substring(a),m,x,S;if(h)S=d+l+f+u+g,m=(d+l).length,x=(d+l+f).length;else{let A=(d+l).length;S=d+l+u+g,m=A,x=A}p(t,{isReversed:r,short:m,long:x,dir:c,value:S})}delete(e){let t=this.element,s=this.pairs,{long:i}=y(t),n=t.value.substring(0,i-1),a=t.value.substring(i+1),c=n+a,r=n.length,h=n.length;p(t,{isReversed:!1,short:r,long:h,dir:"forward",value:c})}};var P=function(o){let{key:e,altKey:t,ctrlKey:s,shiftKey:i}=v(o);return s&&!i&&e.toLowerCase()==="z"},_=function(o){let{key:e,altKey:t,ctrlKey:s,shiftKey:i}=v(o);return s&&i&&e.toLowerCase()==="z"},K=class{element;histories;index;maxCount;constructor(e){this.element=e,this.histories=[],this.index=1,this.maxCount=390}prune(){this.index>1&&(this.histories=this.histories.slice(0,this.histories.length-(this.index-1)),this.index=1)}add(e=!0){let t=this.element;if(e)this.prune();else if(this.index!==1)return;let s=y(t,!0);this.histories.push(s),this.histories.length>this.maxCount&&this.histories.shift()}prev(){this.index<this.histories.length&&(this.index+=1)}next(){this.index>1&&(this.index-=1)}curr(){return this.histories[this.histories.length-this.index]}undo(e){let t=this.element;this.prev();let s=this.curr();s&&p(t,s)}redo(e){let t=this.element;this.next();let s=this.curr();s&&p(t,s)}};var V=function(o){for(let e of o)if(e.value.startsWith("//"))return!0;return!1},E=class{element;key;removePattern;newValue;constructor(e){this.element=e,this.key="/",this.removePattern=/^\/\/\s?/,this.newValue="// "}isValid(e){let{key:t,altKey:s,shiftKey:i}=e;return(e.ctrlKey||e.metaKey)&&!s&&!i&&t===this.key}exec(e){let t=this.element,{rows:s,selectedRows:i}=b(t),n=i.length>1,a=V(i),c=w(t,s,r=>{if(!(r.selectionStart>-1||r.selectionEnd>-1))return r.value;if(n){let l=!r.value.trim();return a?r.value.replace(this.removePattern,""):l?r.value:this.newValue+r.value}else return a?r.value.replace(this.removePattern,""):this.newValue+r.value});p(t,c)}};var T=class{element;key;removePattern;newValue;constructor(e){this.element=e,this.key="Tab",this.removePattern=/^[^\S\n\r][^\S\n\r]?/,this.newValue="  "}isValid(e){let{key:t,altKey:s,shiftKey:i}=e;return!(e.ctrlKey||e.metaKey)&&!s&&t===this.key}exec(e){let t=this.element,{rows:s,selectedRows:i}=b(t),n=i.length>1,a=e.shiftKey,c=w(t,s,r=>{if(!(r.selectionStart>-1||r.selectionEnd>-1))return r.value;if(n){let l=!r.value.trim();return a?r.value.replace(this.removePattern,""):l?r.value:this.newValue+r.value}else return a?r.value.replace(this.removePattern,""):this.newValue+r.value});p(t,c)}};var k=class{element;tags;index;timeout;result;parser;filter;onLoad;_reqId;_state;constructor(e){this.element=e,this.tags=[],this.index={},this.timeout=0,this.result=[],this.parser=t=>{let s=t.value.split(/[,.\s․‧・｡。{}()<>[\]\\/|'"`!?]/),i=t.selectionStart,n=0,a=0;for(let l of s){if(a=n+l.length,i>=n&&i<=a)break;n=a+1}let c=t.value.substring(0,n),r=t.value.substring(n,a).trim(),h=t.value.substring(a);return{head:c,body:r,tail:h}},this.filter=()=>!0,this.onLoad=()=>{},this._state=y(e,!0),this._reqId=0}findIndex(e){let t=this.index,s=Object.keys(t).sort((i,n)=>n.length-i.length);for(let i of s){let{score:n}=R(i,e);if(n===i.length)return t[i]}}createIndex(e){let t=this.tags,s=this.index;return this.index=s,new Promise(i=>{let n=0,a=()=>{let c=n+100;for(;n<t.length;){if(n>=c){setTimeout(a,0);return}let r=t[n],h=[],l=L(r.key.split(""));for(let d of l){let f=d.join("");f.length===e&&h.push(f)}let u=[...new Set(h)];for(let d of u)s[d]?s[d].push(r):s[d]=[r];n++}i(s)};a()})}compare(e,t){return R(e,t)}reset(){p(this.element,this._state)}set(e){let t=e.parts.head.length+e.tag.value.length,s=e.parts.head.length+e.tag.value.length,i=e.parts.head+e.tag.value+e.parts.tail,n={short:t,long:s,value:i};p(this.element,n)}exec(){let e=this._reqId+1,t=Date.now(),s=[],i=!1,n=!1,a=0,c=d=>{i=!0,n=d||!1},r=this.parser(this.element,c),h=r.body,l=h?this.findIndex(h)||this.tags:[];this.result=s,this._state=y(this.element,!0),this._reqId=e;let u=()=>{if(this._reqId!==e||n)return;if(i||this.timeout&&Date.now()-t>=this.timeout){this.onLoad?.(s);return}let d=a+100;for(;a<l.length;){if(a>=d){setTimeout(u,0);return}let g={tag:l[a],parts:r};this.filter(g,a,l,c)&&s.push(g),a++}i=!0,setTimeout(u,0)};u()}};var M=class{element;_keydownState;History;Commentify;Indentify;AutoPairing;AutoComplete;constructor(e){this.element=e,this._keydownState=null,this.History=new K(e),this.Commentify=new E(e),this.Indentify=new T(e),this.AutoPairing=new I(e,{"(":")","[":"]","{":"}","<":">","'":"'",'"':'"',"`":"`"}),this.AutoComplete=new k(e),e.addEventListener("keydown",t=>{P(t)?(t.preventDefault(),this.History.undo(t),this._clearKeydownState()):_(t)?(t.preventDefault(),this.History.redo(t),this._clearKeydownState()):this.AutoPairing.isInsert(t)?(t.preventDefault(),this.AutoPairing.insert(t),this.History.add(),this._clearKeydownState()):this.AutoPairing.isDelete(t)?(t.preventDefault(),this.AutoPairing.delete(t),this.History.add(),this._clearKeydownState()):this.Commentify.isValid(t)?(t.preventDefault(),this.Commentify.exec(t),this.History.add(),this._clearKeydownState()):this.Indentify.isValid(t)?(t.preventDefault(),this.Indentify.exec(t),this.History.add(),this._clearKeydownState()):["Meta","Control","Alt","Shift"].includes(t.key)||this._setKeydownState(t)},!0),e.addEventListener("keyup",t=>{let s=this._keydownState;if(this._clearKeydownState(),!s)return;if(s.value!==e.value)this.History.add();else{let n=s.state,a=y(e);(n.short!==a.short||n.long!==a.long)&&this.History.add(!1)}},!0),e.addEventListener("keyup",t=>{(t.key.length===1||t.key==="Backspace")&&this.AutoComplete.exec()},!0),this.element.addEventListener("mouseup",t=>{this.History.add(!1)},!0)}getState(e){return y(this.element,e)}setState(e){p(this.element,e)}_clearKeydownState(){this._keydownState=null}_setKeydownState(e){this._keydownState={value:this.element.value,state:y(this.element),key:e.key}}};export{M as MTGA};
